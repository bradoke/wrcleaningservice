<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="description" content="WR Cleaning Service â€” Sistema de GestÃ£o Financeira.">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WR Cleaning Service</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--primary:#2563eb;--primary-light:#dbeafe;--primary-dark:#1d4ed8;--secondary:#10b981;--secondary-light:#d1fae5;--destructive:#ef4444;--destructive-light:#fee2e2;--warning:#f97316;--warning-light:#ffedd5;--bg:#f8fafc;--card:#ffffff;--border:#e2e8f0;--text:#0f172a;--text-muted:#64748b;--sidebar-w:240px;--header-h:64px;--radius:10px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
button{cursor:pointer;font-family:inherit;border:none;background:none}
input,select,textarea{font-family:inherit}
.hidden{display:none!important}
.mb-4{margin-bottom:16px}.mt-4{margin-top:16px}

/* TOAST */
#toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;font-size:13px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.12);min-width:260px;display:flex;align-items:center;gap:8px;animation:slideIn .25s ease}
.toast.success{border-left:4px solid var(--secondary)}
.toast.error{border-left:4px solid var(--destructive)}
@keyframes slideIn{from{transform:translateX(60px);opacity:0}to{transform:translateX(0);opacity:1}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;animation:fadeIn .15s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--card);border-radius:14px;padding:28px;width:100%;max-width:460px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.18)}
.modal h2{font-size:18px;font-weight:700;margin-bottom:20px}
.modal-lg{max-width:600px}

/* FORMS */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:5px}
.form-control{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;outline:none;transition:border-color .15s;background:#fff}
.form-control:focus{border-color:var(--primary)}
select.form-control{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
textarea.form-control{resize:vertical;min-height:80px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;transition:all .15s;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff;border:1.5px solid var(--primary)}
.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{background:var(--secondary);color:#fff;border:1.5px solid var(--secondary)}
.btn-outline{background:transparent;color:var(--text);border:1.5px solid var(--border)}
.btn-outline:hover{background:var(--bg)}
.btn-ghost{background:transparent;color:var(--text-muted);border:1.5px solid transparent;padding:6px 10px}
.btn-ghost:hover{background:var(--bg);color:var(--text)}
.btn-danger{background:var(--destructive-light);color:var(--destructive);border:1.5px solid transparent}
.btn-danger:hover{background:var(--destructive);color:#fff}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-icon{padding:7px;border-radius:7px}
.btn-full{width:100%}

/* BADGE */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:99px;font-size:11px;font-weight:600}
.badge-primary{background:var(--primary-light);color:var(--primary)}
.badge-secondary{background:var(--secondary-light);color:var(--secondary)}
.badge-destructive{background:var(--destructive-light);color:var(--destructive)}
.badge-warning{background:var(--warning-light);color:var(--warning)}
.badge-gray{background:#f1f5f9;color:var(--text-muted)}
.badge-pending{background:var(--primary-light);color:var(--primary)}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.card-header{padding:16px 20px 8px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-header h3{font-size:15px;font-weight:700}
.card-body{padding:16px 20px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px}
.stat-card .stat-label{font-size:12px;font-weight:500;color:var(--text-muted);margin-bottom:4px}
.stat-card .stat-value{font-size:26px;font-weight:700}

/* TABLE */
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th{text-align:left;padding:10px 12px;font-weight:600;border-bottom:2px solid var(--border);color:var(--text-muted);font-size:12px}
.table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
.table tr:last-child td{border-bottom:none}
.table tr:hover td{background:var(--bg)}
.table-responsive{overflow-x:auto}

/* LOGIN */
#login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary-light) 0%,#fff 50%,var(--secondary-light) 100%);padding:20px}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:40px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(37,99,235,.1)}
.login-logo{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:28px}
.login-logo .spark{color:var(--primary);font-size:36px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.login-logo h1{font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center}
.login-logo p{font-size:13px;color:var(--text-muted)}
.login-switch{text-align:center;font-size:13px;color:var(--text-muted);margin-top:10px}
.login-switch button{color:var(--primary);font-weight:600;cursor:pointer}
.login-switch button:hover{text-decoration:underline}

/* APP */
#app-page,#emp-app-page{display:flex;flex-direction:column;min-height:100vh}
.app-header{height:var(--header-h);background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:100;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.header-logo{display:flex;align-items:center;gap:10px}
.header-logo .spark{color:var(--primary);font-size:22px}
.header-logo h2{font-size:16px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-logo span{font-size:10px;color:var(--text-muted);display:block}
.header-right{display:flex;align-items:center;gap:12px}
.user-info .name{font-size:13px;font-weight:600}
.user-info .email{font-size:11px;color:var(--text-muted)}
.app-body{display:flex;flex:1}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);background:var(--card);border-right:1px solid var(--border);padding:12px 10px;position:sticky;top:var(--header-h);height:calc(100vh - var(--header-h));overflow-y:auto;flex-shrink:0}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;font-size:13px;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all .15s;width:100%}
.nav-item:hover{background:var(--bg);color:var(--text)}
.nav-item.active{background:var(--primary);color:#fff}
.nav-item .icon{font-size:16px;flex-shrink:0}
.nav-badge{margin-left:auto;background:var(--destructive);color:#fff;font-size:10px;font-weight:700;border-radius:99px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;padding:0 4px}
.main-content{flex:1;padding:24px;overflow-x:hidden}

/* TABS */
.tab-content{display:none;animation:fadeUp .2s ease}
.tab-content.active{display:block}
@keyframes fadeUp{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.page-header h2{font-size:22px;font-weight:800}

/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0}

/* NOTIF BANNER */
.notif-banner{background:var(--destructive-light);border:1px solid #fca5a5;border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:20px}
.notif-banner .title{font-weight:700;color:var(--destructive);font-size:14px}
.notif-banner .desc{font-size:12px;color:var(--text-muted)}

/* LOG ROW */
.log-row{border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.log-row:hover{border-color:var(--primary)}
.log-row .log-date{font-size:12px;color:var(--text-muted)}
.log-row .log-client{font-size:14px;font-weight:600}
.log-row .log-employees{font-size:12px;color:var(--text-muted);margin-top:4px}
.log-row .log-revenue{font-size:16px;font-weight:700;color:var(--secondary)}

/* WEEK SCHEDULE */
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day-col{border:1px solid var(--border);border-radius:8px;min-height:100px;padding:8px}
.day-col .day-label{font-size:11px;font-weight:700;text-align:center;color:var(--text-muted);margin-bottom:6px}
.day-col .day-num{font-size:16px;font-weight:700;text-align:center;margin-bottom:8px}
.day-col.today{border-color:var(--primary);background:var(--primary-light)}
.schedule-item{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:11px;margin-bottom:4px}
.schedule-item.confirmado{border-left:3px solid var(--secondary)}
.schedule-item.pendente{border-left:3px solid var(--warning)}
.schedule-item.cancelado{border-left:3px solid var(--destructive);opacity:.7}

/* COST */
.cost-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px}
.cost-item:hover{border-color:var(--primary)}
.cost-item .cost-cat{font-size:11px;font-weight:600;color:var(--text-muted)}
.cost-item .cost-desc{font-size:14px;font-weight:500}
.cost-item .cost-amount{font-size:16px;font-weight:700}

/* REFERRAL */
.referral-item{border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px}
.referral-item.pending{border-left:4px solid var(--warning)}
.referral-item.approved{border-left:4px solid var(--secondary)}
.referral-item.rejected{border-left:4px solid var(--destructive)}

/* SUMMARY */
.summary-block{background:var(--bg);border-radius:8px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.summary-block .emp-name{font-size:13px;font-weight:600}
.summary-block .emp-count{font-size:12px;color:var(--text-muted)}
.summary-block .emp-total{font-size:16px;font-weight:700;color:var(--primary)}

/* PROFILE */
.profile-avatar{width:72px;height:72px;border-radius:99px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;font-weight:700}

/* FREQ */
.freq-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.freq-item:hover{border-color:var(--primary);background:var(--bg)}

/* NOTIF ITEM */
.notif-item{border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px}
.notif-item.pending{border-left:4px solid var(--destructive)}
.notif-item.read{border-left:4px solid var(--border);opacity:.8}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--text-muted);font-size:14px}
.empty .icon{font-size:40px;margin-bottom:8px}

/* TABS NAV */
.tabs-nav{display:flex;gap:4px;background:var(--bg);border-radius:8px;padding:4px;margin-bottom:16px}
.tab-btn{flex:1;padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;color:var(--text-muted);text-align:center;cursor:pointer;transition:all .15s}
.tab-btn.active{background:var(--card);color:var(--primary);box-shadow:0 1px 4px rgba(0,0,0,.1)}

/* EMP TAB */
.emp-tab-btn{padding:12px 16px;font-size:13px;font-weight:600;color:var(--text-muted);border-bottom:2px solid transparent;cursor:pointer;background:none;border-top:none;border-left:none;border-right:none;white-space:nowrap;transition:all .15s}
.emp-tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.emp-tab-btn:hover{color:var(--text);background:var(--bg)}
.emp-pill{display:inline-flex;align-items:center;gap:6px;background:var(--primary-light);color:var(--primary);border-radius:99px;padding:3px 10px;font-size:12px;font-weight:500}

/* MOBILE */
.mobile-menu-btn{display:none}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:150;top:var(--header-h)}
@media(max-width:768px){
  .sidebar{display:none;position:fixed;left:0;top:var(--header-h);height:calc(100vh - var(--header-h));z-index:200;transform:translateX(-100%);transition:transform .25s}
  .sidebar.open{display:flex;flex-direction:column;transform:translateX(0)}
  .mobile-menu-btn{display:flex}
  .main-content{padding:16px}
  .grid-4{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr 1fr}
  .grid-2{grid-template-columns:1fr}
  .week-grid{grid-template-columns:repeat(4,1fr)}
  .user-info{display:none}
  .sidebar-overlay.open{display:block}
}

/* PASSWORD TOGGLE */
.pass-wrapper{position:relative}.pass-wrapper .form-control{padding-right:44px}
.pass-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;display:flex;align-items:center}.pass-toggle:hover{color:var(--primary)}
/* FORM VALIDATION */
.form-control.is-error{border-color:var(--destructive)!important;box-shadow:0 0 0 3px rgba(239,68,68,.12)}
.form-error{color:var(--destructive);font-size:11px;margin-top:4px;display:none;font-weight:500}.form-error.show{display:block}
/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.chart-container{position:relative;height:270px;padding:4px 8px 12px}
/* USER ROLE BADGE */
.role-badge-adm{background:#dbeafe;color:#1d4ed8;font-size:10px;padding:2px 7px;border-radius:99px;font-weight:700}
.role-badge-col{background:#d1fae5;color:#065f46;font-size:10px;padding:2px 7px;border-radius:99px;font-weight:700}
.no-login-badge{background:#f1f5f9;color:#94a3b8;font-size:10px;padding:2px 7px;border-radius:99px;font-weight:600}
/* AGENDA MOBILE */
.week-scroll-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
.week-scroll-wrapper::-webkit-scrollbar{height:4px}
.week-scroll-wrapper::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.day-col{min-width:120px}
.schedule-header-row{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.schedule-nav-group{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.log-row-inner{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
/* PRINT */
@media print{.sidebar,.app-header,.mobile-menu-btn,.charts-grid,.notif-banner,.btn{display:none!important}.main-content{padding:0}body{background:#fff}}
@media(max-width:768px){
  .schedule-header-row{flex-direction:column;align-items:flex-start}
  .week-grid{grid-template-columns:repeat(7,minmax(108px,1fr));min-width:756px}
  .log-row-inner{flex-direction:column;gap:6px}
}
@media(max-width:480px){
  .grid-4{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr}.grid-2{grid-template-columns:1fr}
  .charts-grid{grid-template-columns:1fr}.stat-card .stat-value{font-size:20px}
  .main-content{padding:10px}.modal{padding:16px 14px}.login-card{padding:28px 18px}
  .week-grid{grid-template-columns:repeat(7,minmax(90px,1fr));min-width:630px}
  .day-col{padding:6px;min-width:90px}.schedule-nav-group{width:100%;justify-content:space-between}
  .log-row{flex-direction:column;gap:8px}.page-header{flex-direction:column;align-items:flex-start;gap:8px}
  .page-header > div{width:100%;justify-content:space-between}.card-header{flex-wrap:wrap;gap:6px}
}
@media(prefers-color-scheme:dark){
  :root{--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--text-muted:#94a3b8;--border:#334155;--primary-light:#1e3a5f;--secondary-light:#064e3b;--destructive-light:#450a0a;--warning-light:#431407}
  .form-control{background:#0f172a;color:var(--text);border-color:var(--border)}
  select.form-control option{background:#1e293b;color:#f1f5f9}
  .login-logo h1,.header-logo h2{-webkit-text-fill-color:unset;background:none;color:var(--primary)}
  #login-page{background:linear-gradient(135deg,#1e293b 0%,#0f172a 60%,#064e3b 100%)}
  .tab-btn.active{background:var(--card)}.schedule-item{background:#1e293b}
  .day-col.today{background:#1e3a5f;border-color:var(--primary)}.summary-block{background:#1e3a5f}
  .table tr:hover td{background:#1e3a5f}
}


/* Loading overlay */
#auth-loading{position:fixed;inset:0;background:var(--bg,#f8fafc);display:flex;align-items:center;
  justify-content:center;z-index:9999;flex-direction:column;gap:14px;}
#auth-loading .spin{width:40px;height:40px;border:3px solid var(--border,#e2e8f0);
  border-top-color:var(--primary,#2563eb);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
#auth-loading p{font-weight:600;color:var(--text-muted,#64748b);font-size:14px;margin:0;}
/* Charts ocultos */
.charts-grid{display:none!important}
/* Mobile */
@media(max-width:768px){
  .app-header{padding:0 12px}.header-logo h2{font-size:14px}
  .header-logo span{display:none}.user-info{display:none}
  .main-content{padding:12px}
  .page-header{flex-direction:column;align-items:flex-start;gap:10px}
  .page-header h2{font-size:18px}
  .grid-4{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr}.grid-2{grid-template-columns:1fr}
  .stat-card .stat-value{font-size:20px}
  .card-header{flex-wrap:wrap;gap:6px;padding:12px 14px 8px}.card-body{padding:12px 14px}
  .modal{padding:20px 16px}.login-card{padding:28px 18px}
  .table th,.table td{padding:8px 10px;font-size:12px}
  .log-row{flex-direction:column;gap:6px}
  .btn{min-height:40px}.btn-sm{min-height:34px}
  .tabs-nav{overflow-x:auto;flex-wrap:nowrap}.tab-btn{white-space:nowrap;flex:none;padding:7px 14px}
}
@media(max-width:480px){
  .grid-4,.grid-3{grid-template-columns:1fr 1fr}.grid-2{grid-template-columns:1fr}
  .main-content{padding:10px}.modal{padding:16px 12px}.login-card{padding:22px 14px}
  .toast-container{bottom:12px;right:12px;left:12px}.toast{min-width:unset;width:100%}
  .btn-full{font-size:15px;padding:12px}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="toast-container"></div>

<!-- â•â• LOGIN â•â• -->
<div id="login-page">
  <div class="login-card">
    <div class="login-logo">
      <div class="spark">âœ¦</div>
      <h1>WR Cleaning Service</h1>
      <p>Sistema de GestÃ£o Financeira</p>
    </div>
    <div id="login-form">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" class="form-control" id="login-email" placeholder="seu@email.com" autocomplete="email"/>
        <span class="form-error" id="login-email-err">Por favor, insira um email vÃ¡lido</span>
      </div>
      <div class="form-group">
        <label for="login-pass">Senha</label>
        <div class="pass-wrapper">
          <input type="password" class="form-control" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
          <button class="pass-toggle" id="toggle-pass" type="button" aria-label="Mostrar senha">
            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <span class="form-error" id="login-pass-err">Senha nÃ£o pode estar vazia</span>
      </div>
      <button class="btn btn-primary btn-full" id="btn-login">Entrar</button>
      <div class="login-switch"><button id="btn-to-forgot">Esqueci minha senha</button></div>
      <div class="login-switch">NÃ£o tem conta? <button id="btn-to-register">Criar conta</button></div>
    </div>
    <div id="register-form" class="hidden">
      <div class="form-group"><label>Email</label><input type="email" class="form-control" placeholder="seu@email.com"/></div>
      <button class="btn btn-primary btn-full" id="btn-send-otp">Enviar CÃ³digo</button>
      <div class="login-switch"><button id="btn-reg-back">Voltar ao Login</button></div>
    </div>
    <div id="forgot-form" class="hidden">
      <div class="form-group"><label>Email</label><input type="email" class="form-control" placeholder="seu@email.com"/></div>
      <button class="btn btn-primary btn-full" id="btn-send-forgot">Enviar CÃ³digo de VerificaÃ§Ã£o</button>
      <div class="login-switch"><button id="btn-forgot-back">Voltar ao login</button></div>
    </div>
  </div>
</div>

<!-- â•â• ADM APP â•â• -->
<div id="app-page" class="hidden">
  <header class="app-header">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="btn btn-ghost btn-icon mobile-menu-btn" id="menu-toggle">â˜°</button>
      <div class="header-logo">
        <span class="spark">âœ¦</span>
        <div><h2>WR Cleaning Service</h2><span>Painel Administrativo</span></div>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div class="name" id="header-username"></div>
        <div class="email" id="header-email"></div>
      </div>
      <button class="btn btn-outline btn-sm" id="btn-logout-adm">â¬¡ Sair</button>
    </div>
  </header>
  <div class="app-body">
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="sidebar" id="sidebar">
      <nav role="navigation" aria-label="NavegaÃ§Ã£o principal">
        <button class="nav-item active" data-tab="dashboard" aria-label="Dashboard" aria-current="page"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg><span>Dashboard</span></button>
        <button class="nav-item" data-tab="schedule" aria-label="Agenda"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Agenda</span></button>
        <button class="nav-item" data-tab="checklist" aria-label="Pagamentos"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 1 0 0 7h5a3.5 3.5 0 1 1 0 7H6"/></svg><span>Pagamentos</span></button>
        <button class="nav-item" data-tab="clients" aria-label="Clientes"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Clientes</span></button>
        <button class="nav-item" data-tab="employees" aria-label="FuncionÃ¡rios"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>FuncionÃ¡rios</span></button>
        <button class="nav-item" data-tab="costs" aria-label="Custos"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span>Custos</span></button>
        <button class="nav-item" data-tab="notifications" aria-label="NotificaÃ§Ãµes"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>NotificaÃ§Ãµes</span><span class="nav-badge hidden" id="notif-badge">0</span></button>
        <button class="nav-item" data-tab="frequencies" aria-label="FrequÃªncias"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8.01" y2="14"/><line x1="12" y1="14" x2="12.01" y2="14"/></svg><span>FrequÃªncias</span></button>
        <button class="nav-item" data-tab="referrals" aria-label="IndicaÃ§Ãµes"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg><span>IndicaÃ§Ãµes</span></button>
        <button class="nav-item" data-tab="profile" aria-label="Perfil"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Perfil</span></button>
      </nav>
    </aside>
    <main class="main-content">
      <div class="notif-banner hidden" id="main-notif-banner">
        <span style="font-size:18px;color:var(--destructive)">ğŸ””</span>
        <div style="flex:1"><div class="title" id="banner-title"></div><div class="desc">ObservaÃ§Ãµes de funcionÃ¡rios aguardam sua visualizaÃ§Ã£o</div></div>
        <button class="btn btn-outline btn-sm" id="btn-banner-ver">Ver</button>
      </div>

      <!-- DASHBOARD -->
      <div class="tab-content active" id="tab-dashboard">
        <div class="card mb-4">
          <div class="card-header"><h3>Filtros de PerÃ­odo</h3></div>
          <div class="card-body">
            <div class="grid-3" style="gap:12px">
              <div class="form-group" style="margin:0"><label>Data Inicial</label><input type="date" class="form-control" id="dash-start" value="2026-02-01"/></div>
              <div class="form-group" style="margin:0"><label>Data Final</label><input type="date" class="form-control" id="dash-end" value="2026-02-28"/></div>
              <div class="form-group" style="margin:0"><label>MÃªs/Ano</label><input type="month" class="form-control" id="dash-month" value="2026-02"/></div>
            </div>
          </div>
        </div>
        <div class="grid-4 mb-4" id="dash-stats"></div>
        <div class="grid-3 mb-4" id="dash-secondary"></div>
        <div class="charts-grid mb-4">
          <div class="card"><div class="card-header"><h3>ğŸ“Š Receita vs Custo M.O.</h3></div><div class="chart-container"><canvas id="chart-revenue-cost"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>ğŸ“ˆ Lucro por Trabalho</h3></div><div class="chart-container"><canvas id="chart-profit"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Ranking de Lucratividade por Cliente</h3><div style="display:flex;gap:6px"><button class="btn btn-outline btn-sm" id="btn-export-csv">ğŸ“¥ CSV</button><button class="btn btn-outline btn-sm" id="btn-print-dash">ğŸ–¨ Imprimir</button></div></div>
          <div class="card-body table-responsive">
            <table class="table"><thead><tr><th>#</th><th>Cliente</th><th>FrequÃªncia</th><th style="text-align:right">Valor Cobrado</th><th style="text-align:right">Custo M.O.</th><th style="text-align:right">Lucro</th></tr></thead><tbody id="ranking-body"></tbody></table>
          </div>
        </div>
      </div>

      <!-- SCHEDULE -->
      <div class="tab-content" id="tab-schedule">
        <div class="page-header">
          <h2>ğŸ“… Agenda Semanal</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-outline btn-sm" id="prev-week">â—€</button>
            <span id="week-label" style="font-size:13px;font-weight:600"></span>
            <button class="btn btn-outline btn-sm" id="next-week">â–¶</button>
            <button class="btn btn-primary btn-sm" id="btn-add-schedule">+ Adicionar</button>
          </div>
        </div>
        <div class="week-scroll-wrapper"><div class="week-grid" id="week-grid"></div></div>
        <div class="card mt-4"><div class="card-header"><h3>Lista de Agendamentos</h3><span id="schedule-count-badge" class="badge badge-gray" style="font-size:11px"></span></div><div class="card-body" id="schedule-list"></div></div>
      </div>

      <!-- CHECKLIST -->
      <div class="tab-content" id="tab-checklist">
        <div class="page-header">
          <h2>ğŸ’µ Registros de Trabalho</h2>
          <button class="btn btn-primary" id="btn-add-worklog">+ Novo Registro</button>
        </div>
        <div class="card mb-4">
          <div class="card-header"><h3>Filtros</h3></div>
          <div class="card-body">
            <div class="grid-3">
              <div class="form-group" style="margin:0"><label>Data Inicial</label><input type="date" class="form-control" id="cl-start" value="2026-02-01"/></div>
              <div class="form-group" style="margin:0"><label>Data Final</label><input type="date" class="form-control" id="cl-end" value="2026-02-28"/></div>
              <div class="form-group" style="margin:0"><label>MÃªs/Ano</label><input type="month" class="form-control" id="cl-month" value="2026-02"/></div>
            </div>
          </div>
        </div>
        <div class="grid-2 mb-4">
          <div class="card"><div class="card-header"><h3>Resumo por FuncionÃ¡ria</h3></div><div class="card-body" id="emp-payments-summary"></div></div>
          <div class="card"><div class="card-header"><h3>Status do PerÃ­odo</h3></div><div class="card-body" id="cl-period-stats"></div></div>
        </div>
        <div id="work-logs-list"></div>
      </div>

      <!-- CLIENTS -->
      <div class="tab-content" id="tab-clients">
        <div class="page-header"><h2>ğŸ‘¥ Clientes</h2><button class="btn btn-primary" id="btn-add-client">+ Adicionar Cliente</button></div>
        <div class="card"><div class="card-body table-responsive">
          <table class="table"><thead><tr><th>Nome</th><th>FrequÃªncia</th><th>Valor</th><th>FuncionÃ¡rias</th><th>Transporte</th><th>AÃ§Ãµes</th></tr></thead><tbody id="clients-table-body"></tbody></table>
        </div></div>
      </div>

      <!-- EMPLOYEES -->
      <div class="tab-content" id="tab-employees">
        <div class="tabs-nav">
          <div class="tab-btn active" id="emp-tab-active">FuncionÃ¡rios Ativos</div>
          <div class="tab-btn" id="emp-tab-pending">UsuÃ¡rios Pendentes</div>
        </div>
        <div id="active-emps">
          <div class="page-header"><h2>ğŸ’¼ FuncionÃ¡rios</h2><button class="btn btn-primary" id="btn-add-emp">+ Adicionar</button></div>
          <div class="card"><div class="card-body table-responsive">
            <table class="table"><thead><tr><th>Nome</th><th>Email</th><th>Papel</th><th>Desde</th><th>AÃ§Ãµes</th></tr></thead><tbody id="emp-table-body"></tbody></table>
          </div></div>
        </div>
        <div id="pending-users" class="hidden">
          <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">â³ UsuÃ¡rios Pendentes</h2>
          <div id="pending-list"></div>
        </div>
      </div>

      <!-- COSTS -->
      <div class="tab-content" id="tab-costs">
        <div class="page-header"><h2>ğŸ§¾ Custos</h2><button class="btn btn-primary" id="btn-add-cost">+ Adicionar Custo</button></div>
        <div class="grid-2 mb-4">
          <div class="stat-card" style="border-left:4px solid var(--primary)"><div class="stat-label">ğŸ”„ Recorrentes / mÃªs</div><div class="stat-value" style="color:var(--primary)" id="cost-recurrent">$0.00</div></div>
          <div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">âš¡ Ãšnicos</div><div class="stat-value" style="color:var(--warning)" id="cost-unique">$0.00</div></div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <button class="btn btn-outline btn-sm" style="border-radius:99px" id="filter-all">Todos</button>
          <button class="btn btn-outline btn-sm" style="border-radius:99px" id="filter-recorrente">Recorrentes</button>
          <button class="btn btn-outline btn-sm" style="border-radius:99px" id="filter-unico">Ãšnicos</button>
        </div>
        <div id="costs-list"></div>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="tab-content" id="tab-notifications">
        <div class="page-header">
          <h2>ğŸ”” NotificaÃ§Ãµes</h2>
          <span class="badge badge-destructive" id="notif-count-badge"></span>
        </div>
        <div id="notifications-list"></div>
      </div>

      <!-- FREQUENCIES -->
      <div class="tab-content" id="tab-frequencies">
        <div class="page-header"><h2>ğŸ“† FrequÃªncias</h2><button class="btn btn-primary" id="btn-add-freq">+ Adicionar</button></div>
        <div class="card"><div class="card-header"><h3>ğŸ“‹ Lista de FrequÃªncias</h3></div><div class="card-body" id="freq-list"></div></div>
      </div>

      <!-- REFERRALS -->
      <div class="tab-content" id="tab-referrals">
        <div class="page-header"><h2>ğŸ IndicaÃ§Ãµes</h2></div>
        <div class="grid-3 mb-4" id="referral-stats"></div>
        <div id="referrals-list"></div>
      </div>

      <!-- PROFILE -->
      <div class="tab-content" id="tab-profile">
        <h2 style="font-size:22px;font-weight:800;margin-bottom:20px">âš™ Perfil</h2>
        <div class="card" style="max-width:480px"><div class="card-body">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
            <div class="profile-avatar" id="profile-avatar">A</div>
            <div><div style="font-size:18px;font-weight:700" id="profile-name">Admin</div><div style="font-size:13px;color:var(--text-muted)" id="profile-email-disp"></div><span class="badge badge-primary" style="margin-top:4px">Administrador</span></div>
          </div>
          <hr class="divider">
          <div class="form-group"><label>Nova Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
          <div class="form-group"><label>Confirmar Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
          <button class="btn btn-primary" id="btn-save-profile">Salvar AlteraÃ§Ãµes</button>
        </div></div>
      </div>
    </main>
  </div>
</div>

<!-- â•â• EMPLOYEE APP â•â• -->
<div id="emp-app-page" class="hidden">
  <header class="app-header">
    <div class="header-logo"><span class="spark">âœ¦</span><div><h2>WR Cleaning</h2><span id="emp-header-sub">Colaboradora</span></div></div>
    <div class="header-right">
      <div class="user-info"><div class="name" id="emp-header-username"></div><div class="email" id="emp-header-email"></div></div>
      <button class="btn btn-outline btn-sm" id="btn-logout-emp">â¬¡ Sair</button>
    </div>
  </header>
  <div style="background:var(--card);border-bottom:1px solid var(--border);overflow-x:auto">
    <div style="display:flex;min-width:max-content;padding:0 16px">
      <button class="emp-tab-btn active" data-etab="emp-ganhos">ğŸ’° Ganhos</button>
      <button class="emp-tab-btn" data-etab="emp-agenda">ğŸ“… Agenda</button>
      <button class="emp-tab-btn" data-etab="emp-clientes">ğŸ‘¥ Clientes</button>
      <button class="emp-tab-btn" data-etab="emp-indique">ğŸ Indique</button>
      <button class="emp-tab-btn" data-etab="emp-perfil">âš™ï¸ Perfil</button>
    </div>
  </div>
  <main class="main-content">
    <!-- GANHOS -->
    <div class="tab-content active" id="tab-emp-ganhos">
      <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">ğŸ’° Meus Ganhos</h2>
      <div class="card mb-4"><div class="card-body" style="padding:12px 16px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-outline btn-sm" style="border-radius:99px" data-period="semana">Esta semana</button>
          <button class="btn btn-primary btn-sm" style="border-radius:99px" data-period="mes">Este mÃªs</button>
          <button class="btn btn-outline btn-sm" style="border-radius:99px" data-period="ano">Este ano</button>
        </div>
      </div></div>
      <div class="grid-3 mb-4" id="emp-stats"></div>
      <div class="card"><div class="card-header"><h3>HistÃ³rico de Trabalhos</h3></div><div class="card-body" id="emp-work-list"></div></div>
    </div>
    <!-- AGENDA -->
    <div class="tab-content" id="tab-emp-agenda">
      <div class="page-header">
        <h2>ğŸ“… Minha Agenda</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-outline btn-sm" id="emp-prev-week">â—€</button>
          <span id="emp-week-label" style="font-size:13px;font-weight:600"></span>
          <button class="btn btn-outline btn-sm" id="emp-next-week">â–¶</button>
        </div>
      </div>
      <div class="week-grid" id="emp-week-grid"></div>
      <div class="card mt-4"><div class="card-header"><h3>Agendamentos da Semana</h3></div><div class="card-body" id="emp-schedule-list"></div></div>
    </div>
    <!-- CLIENTES -->
    <div class="tab-content" id="tab-emp-clientes">
      <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">ğŸ‘¥ Meus Clientes</h2>
      <div id="emp-clients-list"></div>
      <div class="card mt-4">
        <div class="card-header"><h3>ğŸ’¬ Minhas ObservaÃ§Ãµes</h3><button class="btn btn-primary btn-sm" id="btn-emp-note">+ Nova ObservaÃ§Ã£o</button></div>
        <div class="card-body" id="emp-notes-list"></div>
      </div>
    </div>
    <!-- INDIQUE -->
    <div class="tab-content" id="tab-emp-indique">
      <div class="page-header"><h2>ğŸ IndicaÃ§Ãµes</h2><button class="btn btn-primary" id="btn-emp-ref">+ Nova IndicaÃ§Ã£o</button></div>
      <div class="card mb-4" style="border-left:4px solid var(--secondary);background:var(--secondary-light)">
        <div class="card-body"><div style="font-weight:700;color:var(--secondary);margin-bottom:4px">ğŸ Como funciona?</div><div style="font-size:13px;color:#065f46">Indique um amigo e receba bÃ´nus quando aprovado!</div></div>
      </div>
      <div class="grid-3 mb-4" id="emp-referrals-stats"></div>
      <div id="emp-referrals-list"></div>
    </div>
    <!-- PERFIL -->
    <div class="tab-content" id="tab-emp-perfil">
      <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">âš™ï¸ Meu Perfil</h2>
      <div class="card" style="max-width:480px"><div class="card-body">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
          <div class="profile-avatar" id="emp-profile-avatar">A</div>
          <div><div style="font-size:18px;font-weight:700" id="emp-profile-name">Colaboradora</div><div style="font-size:13px;color:var(--text-muted)" id="emp-profile-email"></div><span class="badge badge-gray" style="margin-top:4px">Colaborador</span></div>
        </div>
        <hr class="divider">
        <div class="form-group"><label>Nova Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
        <div class="form-group"><label>Confirmar Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
        <button class="btn btn-primary btn-sm" id="btn-save-emp-profile">Salvar Senha</button>
      </div></div>
    </div>
  </main>
</div>

<!-- â•â• MODALS â•â• -->
<div class="modal-overlay hidden" id="schedule-modal">
  <div class="modal modal-lg"><h2>ğŸ“… Novo Agendamento</h2>
    <div class="form-group"><label>Data</label><input type="date" class="form-control" id="sch-date"/></div>
    <div class="form-group"><label>Cliente</label><select class="form-control" id="sch-client"><option value="">Selecione...</option></select></div>
    <hr class="divider">
    <div style="margin-bottom:10px;font-weight:600;font-size:14px">FuncionÃ¡rias no Agendamento</div>
    <div id="sch-emp-rows"></div>
    <button class="btn btn-ghost btn-sm" id="btn-add-sch-emp-row">+ Adicionar FuncionÃ¡ria</button>
    <hr class="divider">
    <div class="form-group"><label>Status</label><select class="form-control" id="sch-status"><option value="pendente">Pendente</option><option value="confirmado">Confirmado</option><option value="cancelado">Cancelado</option></select></div>
    <div class="form-group"><label>ObservaÃ§Ãµes</label><textarea class="form-control" id="sch-notes" placeholder="Opcional..."></textarea></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-schedule">Salvar</button><button class="btn btn-outline" id="btn-cancel-schedule">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="checklist-modal">
  <div class="modal modal-lg">
    <h2 id="checklist-modal-title">ğŸ’µ Novo Registro de Trabalho</h2>
    <input type="hidden" id="cl-edit-id"/>
    <div class="form-group"><label>Cliente</label><select class="form-control" id="cl-client"><option value="">Selecione...</option></select></div>
    <div class="form-group"><label>Data</label><input type="date" class="form-control" id="cl-date"/></div>
    <div class="form-group"><label>Status</label>
      <select class="form-control" id="cl-status">
        <option value="Pendente">Pendente</option>
        <option value="Confirmado">Confirmado</option>
        <option value="Cancelado">Cancelado</option>
      </select>
    </div>
    <div class="form-group hidden" id="cl-reason-group"><label>Motivo do Cancelamento</label><textarea class="form-control" id="cl-reason"></textarea></div>
    <div class="form-group"><label>Receita (R$)</label><input type="number" class="form-control" id="cl-revenue" placeholder="0.00" step="0.01"/></div>
    <hr class="divider">
    <div style="margin-bottom:10px;font-weight:600;font-size:14px">FuncionÃ¡rias no Trabalho</div>
    <div id="cl-emp-rows"></div>
    <button class="btn btn-ghost btn-sm" id="btn-add-emp-row">+ Adicionar FuncionÃ¡ria</button>
    <div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" id="btn-save-worklog">Salvar</button><button class="btn btn-outline" id="btn-cancel-worklog">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="client-modal">
  <div class="modal modal-lg">
    <h2 id="client-modal-title">ğŸ‘¥ Adicionar Cliente</h2>
    <input type="hidden" id="client-edit-id"/>
    <div class="form-group"><label>Nome</label><input type="text" class="form-control" id="client-name" placeholder="Nome do cliente"/></div>
    <div class="form-group"><label>FrequÃªncia</label><select class="form-control" id="client-freq"><option value="">Selecione...</option></select></div>
    <div class="form-group"><label>Valor (R$)</label><input type="number" class="form-control" id="client-price" placeholder="0.00" step="0.01"/></div>
    <div class="form-group" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="client-transport" style="width:16px;height:16px"/><label for="client-transport" style="margin:0">Sem custo de transporte</label></div>
    <hr class="divider">
    <div style="font-weight:600;font-size:14px;margin-bottom:10px">FuncionÃ¡rias Designadas</div>
    <div id="client-emp-rows"></div>
    <button class="btn btn-ghost btn-sm" id="btn-add-client-emp">+ Adicionar FuncionÃ¡ria</button>
    <div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" id="btn-save-client">Salvar</button><button class="btn btn-outline" id="btn-cancel-client">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="emp-modal">
  <div class="modal">
    <h2>ğŸ’¼ Adicionar FuncionÃ¡rio</h2>
    <div class="form-group"><label>Nome completo</label><input type="text" class="form-control" id="emp-name" placeholder="Nome completo"/></div>
    <div class="form-group"><label>Email (login)</label><input type="email" class="form-control" id="emp-email" placeholder="email@exemplo.com"/></div>
    <div class="form-group">
      <label>Senha</label>
      <div class="pass-wrapper">
        <input type="password" class="form-control" id="emp-pass" placeholder="MÃ­nimo 6 caracteres"/>
        <button class="pass-toggle" type="button" onclick="toggleFieldPass('emp-pass',this)" aria-label="Mostrar senha">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>
    <div class="form-group"><label>Papel</label>
      <select class="form-control" id="emp-role">
        <option value="colaborador">Colaborador</option>
        <option value="adm">Administrador</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px"><button class="btn btn-primary" id="btn-save-emp">âœ… Criar FuncionÃ¡rio</button><button class="btn btn-outline" id="btn-cancel-emp">Cancelar</button></div>
  </div>
</div>

<!-- â•â• MODAL EDITAR FUNCIONÃRIO â•â• -->
<div class="modal-overlay hidden" id="edit-emp-modal">
  <div class="modal">
    <h2>âœï¸ Editar FuncionÃ¡rio</h2>
    <input type="hidden" id="edit-emp-id"/>
    <div class="form-group"><label>Nome completo</label><input type="text" class="form-control" id="edit-emp-name" placeholder="Nome completo"/></div>
    <div class="form-group"><label>Email (login)</label><input type="email" class="form-control" id="edit-emp-email" placeholder="email@exemplo.com"/></div>
    <div class="form-group">
      <label>Nova Senha <span style="font-size:11px;color:var(--text-muted)">(deixe em branco para manter)</span></label>
      <div class="pass-wrapper">
        <input type="password" class="form-control" id="edit-emp-pass" placeholder="Nova senha (opcional)"/>
        <button class="pass-toggle" type="button" onclick="toggleFieldPass('edit-emp-pass',this)" aria-label="Mostrar senha">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>
    <div class="form-group"><label>Papel</label>
      <select class="form-control" id="edit-emp-role">
        <option value="colaborador">Colaborador</option>
        <option value="adm">Administrador</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px"><button class="btn btn-primary" id="btn-save-edit-emp">ğŸ’¾ Salvar AlteraÃ§Ãµes</button><button class="btn btn-outline" id="btn-cancel-edit-emp">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="cost-modal">
  <div class="modal"><h2>ğŸ§¾ Adicionar Custo</h2>
    <div class="form-group"><label>Categoria</label><select class="form-control" id="cost-cat"><option>Transporte</option><option>Produtos de Limpeza</option><option>ManutenÃ§Ã£o</option><option>Outros</option></select></div>
    <div class="form-group"><label>DescriÃ§Ã£o</label><input type="text" class="form-control" id="cost-desc" placeholder="DescriÃ§Ã£o"/></div>
    <div class="form-group"><label>Valor (R$)</label><input type="number" class="form-control" id="cost-amount" placeholder="0.00" step="0.01"/></div>
    <div class="form-group"><label>Tipo</label><select class="form-control" id="cost-type"><option value="unico">Ãšnico</option><option value="recorrente">Recorrente</option></select></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-cost">Adicionar</button><button class="btn btn-outline" id="btn-cancel-cost">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="freq-modal">
  <div class="modal">
    <h2 id="freq-modal-title">ğŸ“† Adicionar FrequÃªncia</h2>
    <input type="hidden" id="freq-edit-id"/>
    <div class="form-group"><label>Nome</label><input type="text" class="form-control" id="freq-name" placeholder="Ex: Semanal, Quinzenal..."/></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-freq">Salvar</button><button class="btn btn-outline" id="btn-cancel-freq">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="approve-modal">
  <div class="modal"><h2>âœ… Aprovar UsuÃ¡rio</h2>
    <input type="hidden" id="approve-user-id"/>
    <div class="form-group"><label>Nome do FuncionÃ¡rio</label><input type="text" class="form-control" id="approve-name" placeholder="Nome completo"/></div>
    <div class="form-group">
      <label>Senha inicial</label>
      <div class="pass-wrapper">
        <input type="password" class="form-control" id="approve-pass" placeholder="MÃ­nimo 6 caracteres" value="123456"/>
        <button class="pass-toggle" type="button" onclick="toggleFieldPass('approve-pass',this)" aria-label="Mostrar senha">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>
    <div class="form-group"><label>Papel</label>
      <select class="form-control" id="approve-role">
        <option value="colaborador">Colaborador</option>
        <option value="adm">Administrador</option>
      </select>
    </div>
    <div style="display:flex;gap:8px"><button class="btn btn-secondary" id="btn-approve-user">âœ… Aprovar e Criar Login</button><button class="btn btn-outline" id="btn-cancel-approve">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="ref-modal">
  <div class="modal"><h2>ğŸ Aprovar IndicaÃ§Ã£o</h2>
    <input type="hidden" id="ref-edit-id"/>
    <div class="form-group"><label>Valor do BÃ´nus (R$)</label><input type="number" class="form-control" id="ref-bonus" placeholder="0.00" step="0.01"/></div>
    <div style="display:flex;gap:8px"><button class="btn btn-secondary" id="btn-approve-ref">Aprovar com BÃ´nus</button><button class="btn btn-outline" id="btn-cancel-ref">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="emp-note-modal">
  <div class="modal"><h2>ğŸ’¬ Nova ObservaÃ§Ã£o</h2>
    <div class="form-group"><label>Cliente</label><select class="form-control" id="note-client-sel"></select></div>
    <div class="form-group"><label>ObservaÃ§Ã£o</label><textarea class="form-control" id="note-text" rows="4" placeholder="Descreva sua observaÃ§Ã£o..."></textarea></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-note">Enviar</button><button class="btn btn-outline" id="btn-cancel-note">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="emp-ref-modal">
  <div class="modal"><h2>ğŸ Nova IndicaÃ§Ã£o</h2>
    <div class="form-group"><label>Nome do Cliente</label><input type="text" class="form-control" id="eref-name" placeholder="Nome completo"/></div>
    <div class="form-group"><label>Telefone</label><input type="text" class="form-control" id="eref-phone" placeholder="(11) 99999-9999"/></div>
    <div class="form-group"><label>EndereÃ§o</label><input type="text" class="form-control" id="eref-address" placeholder="Rua, nÃºmero, bairro"/></div>
    <div class="form-group"><label>CEP</label><input type="text" class="form-control" id="eref-zip" placeholder="00000-000"/></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-emp-ref">Enviar</button><button class="btn btn-outline" id="btn-cancel-emp-ref">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="edit-ref-modal">
  <div class="modal">
    <h2>âœï¸ Editar IndicaÃ§Ã£o</h2>
    <input type="hidden" id="edit-ref-id"/>
    <div class="form-group"><label>Nome do Cliente</label><input type="text" class="form-control" id="edit-ref-name"/></div>
    <div class="form-group"><label>Telefone</label><input type="text" class="form-control" id="edit-ref-phone"/></div>
    <div class="form-group"><label>EndereÃ§o</label><input type="text" class="form-control" id="edit-ref-address"/></div>
    <div class="form-group"><label>CEP</label><input type="text" class="form-control" id="edit-ref-zip"/></div>
    <div class="form-group"><label>Status</label>
      <select class="form-control" id="edit-ref-status">
        <option value="pending">Pendente</option>
        <option value="approved">Aprovada</option>
        <option value="rejected">Rejeitada</option>
      </select>
    </div>
    <div class="form-group" id="edit-ref-bonus-group"><label>BÃ´nus (R$)</label><input type="number" class="form-control" id="edit-ref-bonus" placeholder="0.00" step="0.01"/></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" id="btn-save-edit-ref">Salvar</button>
      <button class="btn btn-outline" id="btn-cancel-edit-ref">Cancelar</button>
    </div>
  </div>
</div>

<script>

// â•â•â•â•â•â•â•â•â•â•â• SUPABASE â•â•â•â•â•â•â•â•â•â•â•
var SUPA_URL='https://uolstjzzytcelyoflwpw.supabase.co';
var SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvbHN0anp6eXRjZWx5b2Zsd3B3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzY2MzksImV4cCI6MjA4NzYxMjYzOX0.roprEFZUN5r8Z5c-f_D06SHm0xSoSU0ecCjCiGDtqbU';
var sb=window.supabase.createClient(SUPA_URL,SUPA_KEY);

// â”€â”€ MAPPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mapEmp(r){return{id:r.id,name:r.name,email:r.email,createdAt:r.created_at};}
function mapClient(r){return{id:r.id,name:r.name,frequency:r.frequency,price:r.price,
  noTransportCost:r.no_transport_cost,
  clientEmployees:(r.client_employees||[]).map(function(ce){return{employeeId:ce.employee_id,paymentAmount:ce.payment_amount};})};}
function mapWorkLog(r){return{id:r.id,clientId:r.client_id,workDate:r.work_date,status:r.status,
  revenue:r.revenue,cancellationReason:r.cancellation_reason,
  workLogEmployees:(r.work_log_employees||[]).map(function(we){return{employeeId:we.employee_id,paymentAmount:we.payment_amount};})};}
function mapCost(r){return{id:r.id,category:r.category,description:r.description,amount:r.amount,costType:r.cost_type,createdAt:r.created_at};}
function mapSchedule(r){return{id:r.id,workDate:r.work_date,clientId:r.client_id,status:r.status,notes:r.notes,
  employeeIds:(r.schedule_employees||[]).map(function(se){return se.employee_id;})};}
function mapNotif(r){return{id:r.id,clientId:r.client_id,employeeId:r.employee_id,note:r.note,status:r.status,createdAt:r.created_at};}
function mapReferral(r){return{id:r.id,employeeId:r.employee_id,clientName:r.client_name,phone:r.phone,
  address:r.address,zipCode:r.zip_code,status:r.status,bonusAmount:r.bonus_amount,createdAt:r.created_at};}

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var db={employees:[],clients:[],workLogs:[],costs:[],scheduleEntries:[],notifications:[],referrals:[],frequencies:[]};
var currentUser=null,currentTab='dashboard',costsFilter='all',weekOffset=0,empWeekOffset=0,currentEmpId=null,empPeriod={start:'',end:''};

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var fmtV=function(v){return'R$Â '+Number(v||0).toFixed(2);};
var fmtDate=function(s){if(!s)return'';var d=new Date(s+(s.length===10?'T00:00:00':'')); return d.toLocaleDateString('pt-BR');};
var getClient=function(id){return db.clients.find(function(c){return c.id===id;});};
var getEmployee=function(id){return db.employees.find(function(e){return e.id===id;});};
var $=function(id){return document.getElementById(id);};

function toast(msg,type){
  type=type||'success';
  var c=$('toast-container');if(!c)return;
  var el=document.createElement('div');
  el.className='toast '+type;
  el.innerHTML=(type==='success'?'âœ“ ':type==='error'?'âœ— ':'â„¹ ')+msg;
  c.appendChild(el);setTimeout(function(){el.remove();},3500);
}
function openModal(id){var m=$(id);if(m)m.classList.remove('hidden');}
function closeModal(id){var m=$(id);if(m)m.classList.add('hidden');}
document.querySelectorAll('.modal-overlay').forEach(function(o){
  o.addEventListener('click',function(e){if(e.target===o)o.classList.add('hidden');});
});

// â”€â”€ LOADING OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoading(){
  if($('auth-loading'))return;
  var ov=document.createElement('div');ov.id='auth-loading';
  ov.innerHTML='<div class="spin"></div><p>Carregando...</p>';
  document.body.appendChild(ov);
  var lp=$('login-page');if(lp)lp.style.visibility='hidden';
}
function hideLoading(){
  var ov=$('auth-loading');if(ov)ov.remove();
  var lp=$('login-page');if(lp)lp.style.visibility='';
}

// â”€â”€ CARREGAR DADOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadAllData(cb){
  Promise.all([
    sb.from('employees').select('*').order('name'),
    sb.from('clients').select('*,client_employees(employee_id,payment_amount)').order('name'),
    sb.from('work_logs').select('*,work_log_employees(employee_id,payment_amount)').order('work_date',{ascending:false}),
    sb.from('costs').select('*').order('created_at',{ascending:false}),
    sb.from('schedule_entries').select('*,schedule_employees(employee_id)').order('work_date'),
    sb.from('notifications').select('*').order('created_at',{ascending:false}),
    sb.from('referrals').select('*').order('created_at',{ascending:false}),
    sb.from('frequencies').select('*').order('name'),
    sb.from('profiles').select('id,role,username,employee_id'),
  ]).then(function(r){
    var profilesList=(r[8].data||[]);
    db.employees=(r[0].data||[]).map(function(row){
      var prof=profilesList.find(function(p){return p.employee_id===row.id;})||null;
      return{id:row.id,name:row.name,email:row.email,createdAt:row.created_at,
        role:(prof?prof.role:null),authId:(prof?prof.id:null),hasLogin:!!(prof&&prof.id)};
    });
    db.clients        =(r[1].data||[]).map(mapClient);
    db.workLogs       =(r[2].data||[]).map(mapWorkLog);
    db.costs          =(r[3].data||[]).map(mapCost);
    db.scheduleEntries=(r[4].data||[]).map(mapSchedule);
    db.notifications  =(r[5].data||[]).map(mapNotif);
    db.referrals      =(r[6].data||[]).map(mapReferral);
    db.frequencies    =(r[7].data||[]).map(function(f){return{id:f.id,name:f.name};});
    if(cb)cb();
  }).catch(function(err){toast('Erro ao carregar: '+err.message,'error');});
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleView(v){
  ['login-form','register-form','forgot-form'].forEach(function(id){var el=$(id);if(el)el.classList.add('hidden');});
  var t=$(v);if(t)t.classList.remove('hidden');
}
function doLogin(){
  var emailEl=$('login-email'),passEl=$('login-pass');
  var errEmail=$('login-email-err'),errPass=$('login-pass-err');
  [emailEl,passEl].forEach(function(el){if(el)el.classList.remove('is-error');});
  [errEmail,errPass].forEach(function(el){if(el)el.classList.remove('show');});
  var email=(emailEl?emailEl.value:'').trim().toLowerCase();
  var pass=passEl?passEl.value:'';
  var ok=true;
  if(!email||!/\S+@\S+\.\S+/.test(email)){if(emailEl)emailEl.classList.add('is-error');if(errEmail)errEmail.classList.add('show');ok=false;}
  if(!pass){if(passEl)passEl.classList.add('is-error');if(errPass)errPass.classList.add('show');ok=false;}
  if(!ok)return;
  showLoading();
  sb.auth.signInWithPassword({email:email,password:pass}).then(function(res){
    if(res.error){hideLoading();toast('Erro: '+res.error.message,'error');return;}
    _loginSuccess(res.data.user);
  });
}
function _loginSuccess(user){
  sb.from('profiles').select('role,username,employee_id').eq('id',user.id).single().then(function(r){
    if(r.error||!r.data){
      hideLoading();
      sb.from('employees').select('id,name').eq('email',user.email).single().then(function(er){
        if(er.error||!er.data){toast('Acesso nÃ£o autorizado.','error');sb.auth.signOut();return;}
        sb.from('profiles').insert({id:user.id,role:'colaborador',username:er.data.name||user.email,employee_id:er.data.id}).then(function(ins){
          if(ins.error){toast('Erro ao configurar perfil.','error');sb.auth.signOut();return;}
          _startEmpApp(user,er.data.name||user.email,er.data.id);
        });
      });
      return;
    }
    var nome=r.data.username||user.email;
    currentUser={role:r.data.role,email:user.email,username:nome,userId:user.id,empRecordId:r.data.employee_id};
    var lp=$('login-page');if(lp)lp.classList.add('hidden');
    if(r.data.role==='adm'){
      var ap=$('app-page');if(ap)ap.classList.remove('hidden');
      if($('header-username'))$('header-username').textContent=nome;
      if($('header-email'))$('header-email').textContent=user.email;
      if($('profile-name'))$('profile-name').textContent=nome;
      if($('profile-email-disp'))$('profile-email-disp').textContent=user.email;
      if($('profile-avatar'))$('profile-avatar').textContent=nome.charAt(0).toUpperCase();
      initApp();
    }else{
      if(r.data.employee_id){
        _startEmpApp(user,nome,r.data.employee_id);
      }else{
        // fallback: busca pelo email
        sb.from('employees').select('id').eq('email',user.email).single().then(function(er){
          _startEmpApp(user,nome,er.data?er.data.id:null);
        });
      }
    }
  });
}
function _startEmpApp(user,nome,empRecordId){
  currentUser.empRecordId=empRecordId;
  var ep=$('emp-app-page');if(ep)ep.classList.remove('hidden');
  if($('emp-header-username'))$('emp-header-username').textContent=nome;
  if($('emp-header-email'))$('emp-header-email').textContent=user.email;
  if($('emp-profile-name'))$('emp-profile-name').textContent=nome;
  if($('emp-profile-avatar'))$('emp-profile-avatar').textContent=nome.charAt(0).toUpperCase();
  initEmpApp(empRecordId);
}
function doLogout(){
  sb.auth.signOut().then(function(){
    currentUser=null;currentEmpId=null;
    var ap=$('app-page');if(ap)ap.classList.add('hidden');
    var ep=$('emp-app-page');if(ep)ep.classList.add('hidden');
    var lp=$('login-page');if(lp){lp.classList.remove('hidden');lp.style.visibility='';}
  });
}

// â”€â”€ NAVEGAÃ‡ÃƒO ADM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigate(tab){
  document.querySelectorAll('.sidebar .nav-item').forEach(function(b){b.classList.remove('active');b.removeAttribute('aria-current');});
  var nb=document.querySelector('.sidebar [data-tab="'+tab+'"]');
  if(nb){nb.classList.add('active');nb.setAttribute('aria-current','page');}
  document.querySelectorAll('.tab-content').forEach(function(t){t.classList.remove('active');});
  var tc=$('tab-'+tab);if(tc)tc.classList.add('active');
  currentTab=tab;updateNotifBadge();renderTab(tab);
}
function renderTab(tab){
  var m={dashboard:renderDashboard,schedule:renderSchedule,checklist:renderChecklist,
    clients:renderClients,employees:renderEmployees,costs:renderCosts,
    notifications:renderNotifications,frequencies:renderFrequencies,referrals:renderReferrals};
  if(m[tab])m[tab]();
}

// â”€â”€ INIT ADM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp(){
  loadAllData(function(){
    hideLoading();
    populateSelects();
    updateNotifBadge();
    renderDashboard();
  });
}
function populateSelects(){
  var cOpts='<option value="">Selecione...</option>'
    +db.clients.map(function(c){return'<option value="'+c.id+'">'+c.name+'</option>';}).join('');
  ['sch-client','cl-client'].forEach(function(id){if($(id))$(id).innerHTML=cOpts;});
  if($('client-freq'))$('client-freq').innerHTML='<option value="">Selecione...</option>'
    +db.frequencies.map(function(f){return'<option value="'+f.name+'">'+f.name+'</option>';}).join('');
  var today=new Date().toISOString().split('T')[0];
  if($('sch-date')&&!$('sch-date').value)$('sch-date').value=today;
  if($('cl-date')&&!$('cl-date').value)$('cl-date').value=today;
}
function updateNotifBadge(){
  var p=db.notifications.filter(function(n){return n.status==='pending';}).length;
  var badge=$('notif-badge'),banner=$('main-notif-banner');
  if(p>0){
    if(badge){badge.textContent=p;badge.classList.remove('hidden');}
    if(banner&&currentTab!=='notifications'){
      banner.classList.remove('hidden');
      if($('banner-title'))$('banner-title').textContent=p+' Nova'+(p>1?'s NotificaÃ§Ãµes':' NotificaÃ§Ã£o');
    }
  }else{
    if(badge)badge.classList.add('hidden');
    if(banner)banner.classList.add('hidden');
  }
  var cb=$('notif-count-badge');if(cb)cb.textContent=p?p+' pendentes':'';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(){
  var start=$('dash-start')?$('dash-start').value:'',end=$('dash-end')?$('dash-end').value:'';
  if(!start||!end)return;
  var filtered=db.workLogs.filter(function(l){return l.workDate>=start&&l.workDate<=end;});
  var confirmed=filtered.filter(function(l){return l.status==='Confirmado';});
  var totalRevenue=confirmed.reduce(function(s,l){return s+l.revenue;},0);
  var totalPayments=confirmed.reduce(function(s,l){return s+l.workLogEmployees.reduce(function(ps,e){return ps+e.paymentAmount;},0);},0);
  var startD=new Date(start+'T00:00:00'),endD=new Date(end+'T00:00:00');
  var days=Math.max(1,Math.ceil((endD-startD)/86400000)+1);
  var recTot=db.costs.filter(function(c){return c.costType==='recorrente';}).reduce(function(s,c){return s+c.amount;},0);
  var propRec=recTot/30*days;
  var uniqTot=db.costs.filter(function(c){return c.costType==='unico'&&c.createdAt>=start&&c.createdAt<=end;}).reduce(function(s,c){return s+c.amount;},0);
  var totalCosts=propRec+uniqTot,netProfit=totalRevenue-totalPayments-totalCosts;
  if($('dash-stats'))$('dash-stats').innerHTML=
    '<div class="stat-card" style="border-left:4px solid var(--primary)"><div class="stat-label">Faturamento Real</div><div class="stat-value" style="color:var(--primary)">'+fmtV(totalRevenue)+'</div></div>'+
    '<div class="stat-card" style="border-left:4px solid var(--destructive)"><div class="stat-label">Pagamentos Equipe</div><div class="stat-value" style="color:var(--destructive)">'+fmtV(totalPayments)+'</div></div>'+
    '<div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">Custos do PerÃ­odo</div><div class="stat-value" style="color:var(--warning)">'+fmtV(totalCosts)+'</div></div>'+
    '<div class="stat-card" style="border-left:4px solid var(--secondary)"><div class="stat-label">Lucro LÃ­quido</div><div class="stat-value" style="color:var(--secondary)">'+fmtV(netProfit)+'</div></div>';
  if($('dash-secondary'))$('dash-secondary').innerHTML=
    '<div class="stat-card"><div class="stat-label">Total de Clientes</div><div class="stat-value">'+db.clients.length+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">Confirmados</div><div class="stat-value" style="color:var(--secondary)">'+confirmed.length+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">Cancelados</div><div class="stat-value" style="color:var(--destructive)">'+filtered.filter(function(l){return l.status==='Cancelado';}).length+'</div></div>';
  var ranking=db.clients.map(function(c){
    var lc=c.clientEmployees.reduce(function(s,ce){return s+ce.paymentAmount;},0);
    return Object.assign({},c,{laborCost:lc,profit:c.price-lc});
  }).sort(function(a,b){return b.profit-a.profit;});
  if($('ranking-body'))$('ranking-body').innerHTML=ranking.map(function(c,i){
    return'<tr><td>'+(i+1)+'</td><td><strong>'+c.name+'</strong></td><td><span class="badge badge-gray">'+c.frequency+'</span></td>'+
      '<td style="text-align:right">'+fmtV(c.price)+'</td><td style="text-align:right">'+fmtV(c.laborCost)+'</td>'+
      '<td style="text-align:right;font-weight:700;color:var(--secondary)">'+fmtV(c.profit)+'</td></tr>';
  }).join('');
}

// â”€â”€ AGENDA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getWeekStart(d){var dd=new Date(d);dd.setDate(dd.getDate()-dd.getDay());dd.setHours(0,0,0,0);return dd;}
function renderSchedule(){
  var base=getWeekStart(new Date());base.setDate(base.getDate()+weekOffset*7);
  var days=[];for(var i=0;i<7;i++){var d=new Date(base);d.setDate(base.getDate()+i);days.push(d);}
  var startStr=days[0].toISOString().split('T')[0],endStr=days[6].toISOString().split('T')[0];
  var todayStr=new Date().toISOString().split('T')[0];
  if($('week-label'))$('week-label').textContent=days[0].toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})+' â€“ '+days[6].toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'});
  var dn=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];
  if($('week-grid'))$('week-grid').innerHTML=days.map(function(d,i){
    var ds=d.toISOString().split('T')[0];
    var entries=db.scheduleEntries.filter(function(e){return e.workDate===ds;});
    return'<div class="day-col'+(ds===todayStr?' today':'')+'"><div class="day-label">'+dn[i]+'</div><div class="day-num">'+d.getDate()+'</div>'
      +entries.map(function(e){var cl=getClient(e.clientId);
        var names=e.employeeIds.map(function(id){var emp=getEmployee(id);return emp?emp.name:'?';}).join(', ');
        return'<div class="schedule-item '+e.status+'"><div style="font-weight:600">'+(cl?cl.name:'?')+'</div>'
          +(names?'<div style="font-size:10px;color:var(--text-muted)">'+names+'</div>':'')
          +'<span class="badge '+(e.status==='confirmado'?'badge-secondary':e.status==='cancelado'?'badge-destructive':'badge-warning')+'" style="font-size:10px">'+e.status+'</span></div>';
      }).join('')+'</div>';
  }).join('');
  var weekEntries=db.scheduleEntries.filter(function(e){return e.workDate>=startStr&&e.workDate<=endStr;}).sort(function(a,b){return a.workDate.localeCompare(b.workDate);});
  if($('schedule-count-badge'))$('schedule-count-badge').textContent=weekEntries.length;
  if($('schedule-list'))$('schedule-list').innerHTML=weekEntries.length===0
    ?'<div class="empty"><div class="icon">&#x1F4C5;</div>Nenhum agendamento esta semana</div>'
    :weekEntries.map(function(e){
      var cl=getClient(e.clientId);
      var empBadges=e.employeeIds.map(function(id){
        var emp=getEmployee(id);
        return emp?'<span style="font-size:11px;background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:99px;font-weight:600">'+emp.name+'</span>':'';
      }).join(' ');
      return'<div class="log-row"><div class="log-row-inner"><div style="flex:1">'
        +'<div class="log-date">'+fmtDate(e.workDate)+'</div>'
        +'<div class="log-client">'+(cl?cl.name:'?')+'</div>'
        +(empBadges?'<div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:4px">'+empBadges+'</div>':'')
        +(e.notes?'<div style="font-size:12px;color:var(--text-muted);font-style:italic;margin-top:2px">'+e.notes+'</div>':'')
        +'</div><div style="display:flex;align-items:center;gap:6px">'
        +'<span class="badge '+(e.status==='confirmado'?'badge-secondary':e.status==='cancelado'?'badge-destructive':'badge-warning')+'">'+e.status+'</span>'
        +'<button class="btn btn-ghost btn-icon btn-sm" data-edit-schedule="'+e.id+'">&#x270F;&#xFE0F;</button>'
        +'<button class="btn btn-danger btn-icon btn-sm" data-del-schedule="'+e.id+'">&#x1F5D1;&#xFE0F;</button>'
        +'</div></div></div>';
    }).join('');
}

function saveSchedule(){
  var clientId=$('sch-client')?$('sch-client').value:'';
  var date=$('sch-date')?$('sch-date').value:'';
  var status=$('sch-status')?$('sch-status').value:'pendente';
  var notes=$('sch-notes')?$('sch-notes').value:'';
  var empIds=[].slice.call(document.querySelectorAll('#sch-emp-rows .sch-row-emp')).map(function(s){return s.value;}).filter(Boolean);
  if(!clientId||!date){toast('Preencha cliente e data','error');return;}
  sb.from('schedule_entries').insert({client_id:clientId,work_date:date,status:status,notes:notes}).select().single().then(function(res){
    if(res.error){toast('Erro: '+res.error.message,'error');return;}
    var schedId=res.data.id;
    var ins=empIds.map(function(eid){return{schedule_id:schedId,employee_id:eid};});
    var p=ins.length>0?sb.from('schedule_employees').insert(ins):Promise.resolve();
    p.then(function(){toast('Agendamento salvo!','success');closeModal('schedule-modal');loadAllData(function(){renderSchedule();});});
  });
}
function openEditScheduleModal(schedId){
  var entry=db.scheduleEntries.find(function(e){return e.id===schedId;});if(!entry)return;
  if($('sch-date'))$('sch-date').value=entry.workDate;
  if($('sch-client'))$('sch-client').value=entry.clientId;
  if($('sch-status'))$('sch-status').value=entry.status;
  if($('sch-notes'))$('sch-notes').value=entry.notes||'';
  if($('sch-emp-rows')){
    $('sch-emp-rows').innerHTML='';
    if(entry.employeeIds.length===0){addSchEmpRow('');}else{entry.employeeIds.forEach(function(eid){addSchEmpRow(eid);});}
  }
  var h2=document.querySelector('#schedule-modal h2');
  if(h2)h2.innerHTML='&#x1F4C5; Editar Agendamento';
  var btn=$('btn-save-schedule');
  if(btn){btn.onclick=null;btn.onclick=function(){
    var nd=$('sch-date').value,nc=$('sch-client').value,ns=$('sch-status').value,nn=$('sch-notes').value||'';
    var nei=[].slice.call(document.querySelectorAll('#sch-emp-rows .sch-row-emp')).map(function(s){return s.value;}).filter(Boolean);
    if(!nc||!nd){toast('Preencha cliente e data','error');return;}
    sb.from('schedule_entries').update({client_id:nc,work_date:nd,status:ns,notes:nn}).eq('id',schedId).then(function(r){
      if(r.error){toast('Erro: '+r.error.message,'error');return;}
      sb.from('schedule_employees').delete().eq('schedule_id',schedId).then(function(){
        var ins=nei.map(function(eid){return{schedule_id:schedId,employee_id:eid};});
        var p=ins.length>0?sb.from('schedule_employees').insert(ins):Promise.resolve();
        p.then(function(){
          toast('Agendamento atualizado!','success');closeModal('schedule-modal');
          var b=$('btn-save-schedule');if(b){b.onclick=null;b.addEventListener('click',saveSchedule);}
          loadAllData(function(){renderSchedule();});
        });
      });
    });
  };}
  openModal('schedule-modal');
}
function openEditReferralModal(refId){
  var r=db.referrals.find(function(x){return x.id===refId;});if(!r)return;
  if($('edit-ref-id'))$('edit-ref-id').value=refId;
  if($('edit-ref-name'))$('edit-ref-name').value=r.clientName||'';
  if($('edit-ref-phone'))$('edit-ref-phone').value=r.phone||'';
  if($('edit-ref-address'))$('edit-ref-address').value=r.address||'';
  if($('edit-ref-zip'))$('edit-ref-zip').value=r.zipCode||'';
  if($('edit-ref-status'))$('edit-ref-status').value=r.status||'pending';
  if($('edit-ref-bonus'))$('edit-ref-bonus').value=r.bonusAmount||0;
  var bg=$('edit-ref-bonus-group');if(bg)bg.style.display=(r.status==='approved')?'block':'none';
  openModal('edit-ref-modal');
}
function saveEditReferral(){
  var id=$('edit-ref-id').value;
  var name=$('edit-ref-name').value.trim();
  if(!name){toast('Informe o nome','error');return;}
  var phone=$('edit-ref-phone').value.trim();
  var address=$('edit-ref-address').value.trim();
  var zip=$('edit-ref-zip').value.trim();
  var status=$('edit-ref-status').value;
  var bonus=parseFloat($('edit-ref-bonus').value)||0;
  sb.from('referrals').update({client_name:name,phone:phone,address:address,zip_code:zip,status:status,bonus_amount:bonus}).eq('id',id).then(function(r){
    if(r.error){toast('Erro: '+r.error.message,'error');return;}
    toast('IndicaÃ§Ã£o atualizada!','success');closeModal('edit-ref-modal');
    loadAllData(function(){renderReferrals();});
  });
}

// â”€â”€ CHECKLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChecklist(){
  var start=$('cl-start')?$('cl-start').value:'',end=$('cl-end')?$('cl-end').value:'';
  if(!start||!end)return;
  var filtered=db.workLogs.filter(function(l){return l.workDate>=start&&l.workDate<=end;}).sort(function(a,b){return b.workDate.localeCompare(a.workDate);});
  var empSummary=db.employees.map(function(e){
    var total=filtered.filter(function(l){return l.status==='Confirmado';}).reduce(function(s,l){
      var we=l.workLogEmployees.find(function(w){return w.employeeId===e.id;});return s+(we?we.paymentAmount:0);},0);
    var count=filtered.filter(function(l){return l.status==='Confirmado'&&l.workLogEmployees.some(function(w){return w.employeeId===e.id;});}).length;
    return Object.assign({},e,{total:total,count:count});
  }).filter(function(e){return e.total>0;});
  if($('emp-payments-summary'))$('emp-payments-summary').innerHTML=empSummary.length===0?'<p style="color:var(--text-muted);font-size:13px">Nenhum pagamento no perÃ­odo</p>':
    empSummary.map(function(e){return'<div class="summary-block"><div><div class="emp-name">'+e.name+'</div><div class="emp-count">'+e.count+' trabalhos</div></div><div class="emp-total">'+fmtV(e.total)+'</div></div>';}).join('');
  var confirmed=filtered.filter(function(l){return l.status==='Confirmado';}),cancelled=filtered.filter(function(l){return l.status==='Cancelado';}),pending=filtered.filter(function(l){return l.status==='Pendente';});
  var totalRev=confirmed.reduce(function(s,l){return s+l.revenue;},0),totalPay=confirmed.reduce(function(s,l){return s+l.workLogEmployees.reduce(function(ps,e){return ps+e.paymentAmount;},0);},0);
  if($('cl-period-stats'))$('cl-period-stats').innerHTML=
    '<div class="summary-block"><span>Pendentes</span><span class="badge badge-pending">'+pending.length+'</span></div>'+
    '<div class="summary-block"><span>Confirmados</span><span class="badge badge-secondary">'+confirmed.length+'</span></div>'+
    '<div class="summary-block"><span>Cancelados</span><span class="badge badge-destructive">'+cancelled.length+'</span></div>'+
    '<div class="summary-block"><span>Faturamento</span><strong style="color:var(--secondary)">'+fmtV(totalRev)+'</strong></div>'+
    '<div class="summary-block"><span>Pagamentos</span><strong style="color:var(--destructive)">'+fmtV(totalPay)+'</strong></div>';
  if($('work-logs-list'))$('work-logs-list').innerHTML=filtered.length===0?'<div class="empty"><div class="icon">ğŸ“‹</div>Nenhum registro no perÃ­odo</div>':
    filtered.map(function(l){
      var cl=getClient(l.clientId);
      var emps=l.workLogEmployees.map(function(we){var emp=getEmployee(we.employeeId);return(emp?emp.name:'?')+' '+fmtV(we.paymentAmount);}).join(', ');
      var sb2=l.status==='Confirmado'?'badge-secondary':l.status==='Cancelado'?'badge-destructive':'badge-pending';
      return'<div class="log-row"><div class="log-info"><div class="log-date">'+fmtDate(l.workDate)+'</div>'+
        '<div class="log-client">'+(cl?cl.name:'?')+'</div>'+(emps?'<div class="log-employees">'+emps+'</div>':'')+
        (l.cancellationReason?'<div style="font-size:12px;color:var(--destructive);margin-top:2px">Cancelado: '+l.cancellationReason+'</div>':'')+
        '</div><div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px">'+
        '<span class="badge '+sb2+'">'+l.status+'</span>'+(l.status==='Confirmado'?'<div class="log-revenue">'+fmtV(l.revenue)+'</div>':'')+
        '<div style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" data-edit-log="'+l.id+'">âœï¸</button>'+
        '<button class="btn btn-danger btn-icon btn-sm" data-del-log="'+l.id+'">ğŸ—‘</button></div></div></div>';
    }).join('');
}
function openAddWorkLog(){
  if($('checklist-modal-title'))$('checklist-modal-title').textContent='Novo Registro de Trabalho';
  if($('cl-edit-id'))$('cl-edit-id').value='';
  if($('cl-client'))$('cl-client').value='';
  if($('cl-date'))$('cl-date').value=new Date().toISOString().split('T')[0];
  if($('cl-status'))$('cl-status').value='Pendente';
  if($('cl-reason'))$('cl-reason').value='';
  if($('cl-reason-group'))$('cl-reason-group').classList.add('hidden');
  if($('cl-revenue'))$('cl-revenue').value='';
  if($('cl-emp-rows'))$('cl-emp-rows').innerHTML='';
  openModal('checklist-modal');
}
function editWorkLog(id){
  var l=db.workLogs.find(function(w){return w.id===id;});if(!l)return;
  if($('checklist-modal-title'))$('checklist-modal-title').textContent='Editar Registro';
  if($('cl-edit-id'))$('cl-edit-id').value=id;
  if($('cl-client'))$('cl-client').value=l.clientId;
  if($('cl-date'))$('cl-date').value=l.workDate;
  if($('cl-status'))$('cl-status').value=l.status;
  if($('cl-reason'))$('cl-reason').value=l.cancellationReason||'';
  if($('cl-reason-group'))$('cl-reason-group').classList.toggle('hidden',l.status!=='Cancelado');
  if($('cl-revenue'))$('cl-revenue').value=l.revenue;
  var c=$('cl-emp-rows');if(c){c.innerHTML='';
    l.workLogEmployees.forEach(function(we){
      var div=document.createElement('div');div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
      div.innerHTML='<select class="form-control emp-row-emp" style="flex:1">'+db.employees.map(function(e){return'<option value="'+e.id+'"'+(e.id===we.employeeId?' selected':'')+'>'+e.name+'</option>';}).join('')+'</select>'+
        '<input type="number" class="form-control emp-row-pay" value="'+we.paymentAmount+'" step="0.01" style="width:100px">'+
        '<button class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">ğŸ—‘</button>';
      c.appendChild(div);
    });
  }
  openModal('checklist-modal');
}
function addSchEmpRow(sel){
  var c=$('sch-emp-rows');if(!c)return;
  var div=document.createElement('div');
  div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
  var opts=db.employees.map(function(e){
    return'<option value="'+e.id+'"'+(sel&&sel===e.id?' selected':'')+'>'+e.name+'</option>';
  }).join('');
  div.innerHTML='<select class="form-control sch-row-emp" style="flex:1">'+opts+'</select>'
    +'<button class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">&#x1F5D1;&#xFE0F;</button>';
  c.appendChild(div);
}
function addEmpRow(){
  var c=$('cl-emp-rows');if(!c)return;
  var div=document.createElement('div');div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
  div.innerHTML='<select class="form-control emp-row-emp" style="flex:1">'+db.employees.map(function(e){return'<option value="'+e.id+'">'+e.name+'</option>';}).join('')+'</select>'+
    '<input type="number" class="form-control emp-row-pay" placeholder="R$" step="0.01" style="width:100px">'+
    '<button class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">ğŸ—‘</button>';
  c.appendChild(div);
}
function saveWorkLog(){
  var editId=$('cl-edit-id').value,clientId=$('cl-client').value,date=$('cl-date').value;
  var status=$('cl-status').value,reason=$('cl-reason').value,revenue=parseFloat($('cl-revenue').value)||0;
  if(!clientId||!date){toast('Preencha cliente e data','error');return;}
  var emps=[].slice.call(document.querySelectorAll('#cl-emp-rows div')).map(function(div){
    return{employee_id:div.querySelector('.emp-row-emp').value,payment_amount:parseFloat(div.querySelector('.emp-row-pay').value)||0};
  });
  var record={client_id:clientId,work_date:date,status:status,cancellation_reason:reason,revenue:status==='Confirmado'?revenue:0};
  function afterSave(wid){
    sb.from('work_log_employees').delete().eq('work_log_id',wid).then(function(){
      var rows=emps.map(function(e){return Object.assign({work_log_id:wid},e);});
      (rows.length>0?sb.from('work_log_employees').insert(rows):Promise.resolve()).then(function(){
        toast(editId?'Registro atualizado!':'Registro adicionado!','success');
        closeModal('checklist-modal');
        loadAllData(function(){renderChecklist();renderDashboard();});
      });
    });
  }
  if(editId){sb.from('work_logs').update(record).eq('id',editId).then(function(r){if(r.error){toast('Erro: '+r.error.message,'error');return;}afterSave(editId);});}
  else{sb.from('work_logs').insert(record).select().single().then(function(r){if(r.error){toast('Erro: '+r.error.message,'error');return;}afterSave(r.data.id);});}
}

// â”€â”€ CLIENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClients(){
  if(!$('clients-table-body'))return;
  $('clients-table-body').innerHTML=db.clients.map(function(c){
    var emps=c.clientEmployees.map(function(ce){var e=getEmployee(ce.employeeId);return'<span class="emp-pill">'+(e?e.name:'?')+' '+fmtV(ce.paymentAmount)+'</span>';}).join('');
    return'<tr><td><strong>'+c.name+'</strong></td><td><span class="badge badge-gray">'+c.frequency+'</span></td>'+
      '<td><strong style="color:var(--secondary)">'+fmtV(c.price)+'</strong></td><td>'+(emps||'<span style="color:var(--text-muted)">Nenhuma</span>')+'</td>'+
      '<td>'+(c.noTransportCost?'<span class="badge badge-secondary">Sim</span>':'<span class="badge badge-gray">NÃ£o</span>')+'</td>'+
      '<td><div style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" data-edit-client="'+c.id+'">âœï¸</button>'+
      '<button class="btn btn-danger btn-icon btn-sm" data-del-client="'+c.id+'">ğŸ—‘</button></div></td></tr>';
  }).join('');
}
function addClientEmpRow(empId,pay){
  empId=empId||'';pay=pay||'';
  var c=$('client-emp-rows');if(!c)return;
  var div=document.createElement('div');div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
  div.innerHTML='<select class="form-control cemp-row-emp" style="flex:1">'+db.employees.map(function(e){return'<option value="'+e.id+'"'+(e.id===empId?' selected':'')+'>'+e.name+'</option>';}).join('')+'</select>'+
    '<input type="number" class="form-control cemp-row-pay" value="'+pay+'" placeholder="R$" step="0.01" style="width:100px">'+
    '<button class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">ğŸ—‘</button>';
  c.appendChild(div);
}
function openAddClient(){
  if($('client-modal-title'))$('client-modal-title').textContent='Adicionar Cliente';
  if($('client-edit-id'))$('client-edit-id').value='';
  ['client-name','client-price'].forEach(function(id){if($(id))$(id).value='';});
  if($('client-freq'))$('client-freq').value='';
  if($('client-transport'))$('client-transport').checked=false;
  if($('client-emp-rows'))$('client-emp-rows').innerHTML='';
  openModal('client-modal');
}
function editClient(id){
  var c=db.clients.find(function(cl){return cl.id===id;});if(!c)return;
  if($('client-modal-title'))$('client-modal-title').textContent='Editar Cliente';
  if($('client-edit-id'))$('client-edit-id').value=id;
  if($('client-name'))$('client-name').value=c.name;
  if($('client-freq'))$('client-freq').value=c.frequency;
  if($('client-price'))$('client-price').value=c.price;
  if($('client-transport'))$('client-transport').checked=c.noTransportCost;
  if($('client-emp-rows'))$('client-emp-rows').innerHTML='';
  c.clientEmployees.forEach(function(ce){addClientEmpRow(ce.employeeId,ce.paymentAmount);});
  openModal('client-modal');
}
function saveClient(){
  var id=$('client-edit-id').value,name=$('client-name').value.trim();
  var freq=$('client-freq').value,price=parseFloat($('client-price').value)||0;
  var noT=$('client-transport').checked;
  if(!name||!freq){toast('Preencha nome e frequÃªncia','error');return;}
  var emps=[].slice.call(document.querySelectorAll('#client-emp-rows div')).map(function(div){
    return{employee_id:div.querySelector('.cemp-row-emp').value,payment_amount:parseFloat(div.querySelector('.cemp-row-pay').value)||0};
  });
  var record={name:name,frequency:freq,price:price,no_transport_cost:noT};
  function afterSave(cid){
    sb.from('client_employees').delete().eq('client_id',cid).then(function(){
      var rows=emps.map(function(e){return Object.assign({client_id:cid},e);});
      (rows.length>0?sb.from('client_employees').insert(rows):Promise.resolve()).then(function(){
        toast(id?'Cliente atualizado!':'Cliente adicionado!','success');
        closeModal('client-modal');
        loadAllData(function(){renderClients();populateSelects();});
      });
    });
  }
  if(id){sb.from('clients').update(record).eq('id',id).then(function(r){if(r.error){toast('Erro: '+r.error.message,'error');return;}afterSave(id);});}
  else{sb.from('clients').insert(record).select().single().then(function(r){if(r.error){toast('Erro: '+r.error.message,'error');return;}afterSave(r.data.id);});}
}

// â”€â”€ FUNCIONÃRIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEmployees(){
  if(!$('emp-table-body'))return;
  if(db.employees.length===0){
    $('emp-table-body').innerHTML='<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--text-muted)">Nenhum funcionÃ¡rio cadastrado</td></tr>';
  }else{
    $('emp-table-body').innerHTML=db.employees.map(function(e){
      var roleBadge=(e.role==='adm')?'<span class="role-badge-adm">Admin</span>':'<span class="role-badge-col">Colaborador</span>';
      var loginBadge=e.hasLogin
        ?'<span style="font-size:10px;background:#d1fae5;color:#065f46;padding:2px 7px;border-radius:99px;font-weight:600">Com login</span>'
        :'<span style="font-size:10px;background:#fff7ed;color:#c2410c;padding:2px 7px;border-radius:99px;font-weight:600">Sem login</span>';
      return'<tr><td><strong>'+e.name+'</strong><br><div style="margin-top:3px">'+loginBadge+'</div></td>'
        +'<td style="font-size:12px">'+e.email+'</td><td>'+roleBadge+'</td><td>'+fmtDate(e.createdAt)+'</td>'
        +'<td><div style="display:flex;gap:4px">'
        +'<button class="btn btn-ghost btn-icon btn-sm" data-edit-emp="'+e.id+'">&#x270F;&#xFE0F;</button>'
        +'<button class="btn btn-danger btn-icon btn-sm" data-del-emp="'+e.id+'">&#x1F5D1;&#xFE0F;</button>'
        +'</div></td></tr>';
    }).join('');
  }
  var semLogin=db.employees.filter(function(e){return !e.hasLogin;});
  if($('pending-list')){
    $('pending-list').innerHTML=semLogin.length===0
      ?'<div class="empty">Todos os funcionÃ¡rios tÃªm login ativo</div>'
      :semLogin.map(function(e){
          return'<div class="log-row"><div class="log-row-inner">'
            +'<div><div class="log-client">'+e.name+'</div><div class="log-employees">'+e.email+'</div></div>'
            +'<button class="btn btn-primary btn-sm" onclick="promptCreateLoginFor(\''+e.id+'\',\''+e.name+'\',\''+e.email+'\')">Criar Login</button>'
            +'</div></div>';
        }).join('');
  }
  var tp=document.getElementById('emp-tab-pending');
  if(tp)tp.textContent='UsuÃ¡rios Pendentes'+(semLogin.length>0?' ('+semLogin.length+')':'');
}
function promptCreateLoginFor(empId,empName,empEmail){
  var pass=prompt('Criar login para '+empName+'. Senha (mÃ­nimo 6 caracteres):');
  if(pass===null)return;
  if(!pass||pass.length<6){toast('Senha muito curta','error');return;}
  sb.auth.getSession().then(function(res){
    var session=res.data.session;if(!session){toast('SessÃ£o expirada','error');return;}
    fetch(SUPA_URL+'/functions/v1/admin-create-user',{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token},
      body:JSON.stringify({name:empName,email:empEmail,password:pass,role:'colaborador',existing_employee_id:empId})
    }).then(function(r){return r.json();})
    .then(function(data){
      if(data.error){toast('Erro: '+data.error,'error');return;}
      toast('Login criado para '+empName+'!','success');
      loadAllData(function(){renderEmployees();populateSelects();});
    }).catch(function(err){toast('Erro: '+err.message,'error');});
  });
}
function saveEmployee(){
  var name=$('emp-name').value.trim(),email=$('emp-email').value.trim().toLowerCase();
  var pass=$('emp-pass').value,role=$('emp-role').value;
  if(!name||!email){toast('Preencha nome e email','error');return;}
  if(!pass||pass.length<6){toast('Senha: mÃ­nimo 6 caracteres','error');return;}
  var btn=$('btn-save-emp');if(btn){btn.disabled=true;btn.textContent='Aguarde...';}
  sb.auth.getSession().then(function(res){
    var session=res.data.session;
    if(!session){toast('SessÃ£o expirada.','error');if(btn){btn.disabled=false;btn.textContent='Criar FuncionÃ¡rio';}return;}
    fetch(SUPA_URL+'/functions/v1/admin-create-user',{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+session.access_token},
      body:JSON.stringify({name:name,email:email,password:pass,role:role})
    }).then(function(r){return r.json();})
    .then(function(data){
      if(data.error){toast('Erro: '+data.error,'error');if(btn){btn.disabled=false;btn.textContent='Criar FuncionÃ¡rio';}return;}
      toast('FuncionÃ¡rio criado!','success');closeModal('emp-modal');
      loadAllData(function(){renderEmployees();populateSelects();});
    }).catch(function(err){toast('Erro: '+err.message,'error');if(btn){btn.disabled=false;btn.textContent='Criar FuncionÃ¡rio';}});
  });
}

// â”€â”€ CUSTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCosts(){
  var rec=db.costs.filter(function(c){return c.costType==='recorrente';}).reduce(function(s,c){return s+c.amount;},0);
  var uniq=db.costs.filter(function(c){return c.costType==='unico';}).reduce(function(s,c){return s+c.amount;},0);
  if($('cost-recurrent'))$('cost-recurrent').textContent=fmtV(rec);
  if($('cost-unique'))$('cost-unique').textContent=fmtV(uniq);
  var list=costsFilter==='all'?db.costs:db.costs.filter(function(c){return c.costType===costsFilter;});
  if($('costs-list'))$('costs-list').innerHTML=list.length===0?'<div class="empty"><div class="icon">ğŸ’°</div>Nenhum custo</div>':
    list.map(function(c){
      return'<div class="cost-item"><div><div class="cost-cat">'+c.category+
        ' <span class="badge '+(c.costType==='recorrente'?'badge-primary':'badge-warning')+'">'+c.costType+'</span></div>'+
        '<div class="cost-desc">'+c.description+'</div></div>'+
        '<div style="display:flex;align-items:center;gap:10px"><div class="cost-amount" style="color:'+(c.costType==='recorrente'?'var(--primary)':'var(--warning)')+'">'+fmtV(c.amount)+'</div>'+
        '<button class="btn btn-danger btn-icon btn-sm" data-del-cost="'+c.id+'">ğŸ—‘</button></div></div>';
    }).join('');
}
function saveCost(){
  var cat=$('cost-cat').value,desc=$('cost-desc').value,amount=parseFloat($('cost-amount').value)||0,type=$('cost-type').value;
  if(!cat||!amount){toast('Preencha categoria e valor','error');return;}
  sb.from('costs').insert({category:cat,description:desc,amount:amount,cost_type:type}).then(function(r){
    if(r.error){toast('Erro: '+r.error.message,'error');return;}
    toast('Custo adicionado!','success');closeModal('cost-modal');
    loadAllData(function(){renderCosts();});
  });
}

// â”€â”€ NOTIFICAÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNotifications(){
  if(!$('notifications-list'))return;
  $('notifications-list').innerHTML=db.notifications.length===0?'<div class="empty"><div class="icon">ğŸ””</div>Nenhuma notificaÃ§Ã£o</div>':
    db.notifications.map(function(n){
      var cl=getClient(n.clientId),emp=getEmployee(n.employeeId);
      return'<div class="notif-item '+n.status+'">'+
        '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">'+
        '<div><div style="font-weight:600;font-size:13px">'+(cl?cl.name:'?')+'</div>'+
        '<div style="font-size:12px;color:var(--text-muted)">'+(emp?emp.name:'?')+' â€¢ '+fmtDate((n.createdAt||'').split('T')[0])+'</div>'+
        '<div style="margin-top:6px;font-size:13px">'+n.note+'</div></div>'+
        '<div style="display:flex;gap:4px;flex-shrink:0">'+
        (n.status==='pending'?'<button class="btn btn-secondary btn-sm" data-read-notif="'+n.id+'">âœ“ Lido</button>':'')+
        '<button class="btn btn-danger btn-icon btn-sm" data-del-notif="'+n.id+'">ğŸ—‘</button></div></div></div>';
    }).join('');
  var cnt=$('notif-count-badge');
  if(cnt){var p=db.notifications.filter(function(n){return n.status==='pending';}).length;cnt.textContent=p?p+' pendentes':'';}
}

// â”€â”€ FREQUÃŠNCIAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFrequencies(){
  if(!$('freq-list'))return;
  $('freq-list').innerHTML=db.frequencies.length===0?'<div class="empty"><div class="icon">ğŸ“…</div>Nenhuma frequÃªncia</div>':
    db.frequencies.map(function(f){
      return'<div class="freq-item"><span style="font-weight:500">'+f.name+'</span>'+
        '<button class="btn btn-danger btn-icon btn-sm" data-del-freq="'+f.id+'">ğŸ—‘</button></div>';
    }).join('');
}
function saveFreq(){
  var name=$('freq-name')?$('freq-name').value.trim():'';
  if(!name){toast('Informe o nome','error');return;}
  var editId=$('freq-edit-id')?$('freq-edit-id').value:'';
  (editId?sb.from('frequencies').update({name:name}).eq('id',editId):sb.from('frequencies').insert({name:name})).then(function(r){
    if(r.error){toast('Erro: '+r.error.message,'error');return;}
    toast('FrequÃªncia salva!','success');closeModal('freq-modal');
    loadAllData(function(){renderFrequencies();populateSelects();});
  });
}

// â”€â”€ INDICAÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReferrals(){
  var stats={pending:0,approved:0,totalBonus:0};
  db.referrals.forEach(function(r){
    if(r.status==='pending')stats.pending++;
    if(r.status==='approved'){stats.approved++;stats.totalBonus+=r.bonusAmount;}
  });
  if($('referral-stats'))$('referral-stats').innerHTML=
    '<div class="stat-card"><div class="stat-label">Pendentes</div><div class="stat-value" style="color:var(--warning)">'+stats.pending+'</div></div>'
    +'<div class="stat-card"><div class="stat-label">Aprovadas</div><div class="stat-value" style="color:var(--secondary)">'+stats.approved+'</div></div>'
    +'<div class="stat-card"><div class="stat-label">BÃ´nus Pago</div><div class="stat-value" style="color:var(--primary)">'+fmtV(stats.totalBonus)+'</div></div>';
  if($('referrals-list'))$('referrals-list').innerHTML=db.referrals.length===0
    ?'<div class="empty"><div class="icon">&#x1F381;</div>Nenhuma indicaÃ§Ã£o</div>'
    :db.referrals.map(function(r){
      var emp=getEmployee(r.employeeId);
      return'<div class="referral-item '+r.status+'">'
        +'<div style="display:flex;justify-content:space-between;align-items:flex-start">'
        +'<div>'
        +'<div style="font-weight:600">'+r.clientName+'</div>'
        +'<div style="font-size:12px;color:var(--text-muted)">'+(emp?emp.name:'?')+' â€¢ '+r.phone+'</div>'
        +'<div style="font-size:12px;color:var(--text-muted)">'+r.address+(r.zipCode?' â€¢ CEP '+r.zipCode:'')+'</div>'
        +'</div>'
        +'<div style="display:flex;align-items:center;gap:6px">'
        +'<span class="badge '+(r.status==='pending'?'badge-warning':r.status==='approved'?'badge-secondary':'badge-destructive')+'">'
        +(r.status==='pending'?'Pendente':r.status==='approved'?'Aprovada':'Rejeitada')
        +'</span>'
        +'<button class="btn btn-ghost btn-icon btn-sm" data-edit-ref="'+r.id+'">&#x270F;&#xFE0F;</button>'
        +'<button class="btn btn-danger btn-icon btn-sm" data-del-ref="'+r.id+'">&#x1F5D1;&#xFE0F;</button>'
        +'</div>'
        +'</div>'
        +(r.status==='pending'
          ?'<div style="display:flex;gap:6px;margin-top:10px">'
            +'<button class="btn btn-secondary btn-sm" data-approve-ref="'+r.id+'">âœ“ Aprovar</button>'
            +'<button class="btn btn-danger btn-sm" data-reject-ref="'+r.id+'">âœ— Rejeitar</button>'
            +'</div>'
          :r.status==='approved'
            ?'<div style="font-size:12px;color:var(--secondary);margin-top:4px">BÃ´nus: '+fmtV(r.bonusAmount)+'</div>'
            :'')
        +'</div>';
    }).join('');
}


// â”€â”€ APP COLABORADORA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initEmpApp(empId){
  currentEmpId=empId;
  var today=new Date();
  var ms=new Date(today.getFullYear(),today.getMonth(),1).toISOString().split('T')[0];
  var me=new Date(today.getFullYear(),today.getMonth()+1,0).toISOString().split('T')[0];
  empPeriod={start:ms,end:me};

  // Registrar abas sem duplicar listeners
  document.querySelectorAll('.emp-tab-btn').forEach(function(b){
    var fresh=b.cloneNode(true);b.parentNode.replaceChild(fresh,b);
  });
  document.querySelectorAll('.emp-tab-btn').forEach(function(b){
    b.addEventListener('click',function(){
      document.querySelectorAll('.emp-tab-btn').forEach(function(x){x.classList.remove('active');});
      b.classList.add('active');
      document.querySelectorAll('#emp-app-page .tab-content').forEach(function(t){t.classList.remove('active');});
      var tc=$('tab-'+b.dataset.etab);if(tc)tc.classList.add('active');
      // Recarregar dados ao trocar aba
      loadAllData(function(){
        var m={'emp-ganhos':renderEmpGanhos,'emp-agenda':renderEmpAgenda,'emp-clientes':renderEmpClients,'emp-indique':renderEmpReferrals,'emp-perfil':function(){}};
        if(m[b.dataset.etab])m[b.dataset.etab]();
      });
    });
  });

  function _doLoad(){
    loadAllData(function(){
      hideLoading();
      renderEmpGanhos();
    });
  }

  // Se nÃ£o tem empId, tentar achar pelo email
  if(!currentEmpId&&currentUser&&currentUser.email){
    sb.from('employees').select('id').eq('email',currentUser.email).single().then(function(er){
      if(er.data){
        currentEmpId=er.data.id;
        // Salvar no perfil para prÃ³xima vez
        if(currentUser.userId)sb.from('profiles').update({employee_id:er.data.id}).eq('id',currentUser.userId).then(function(){});
      }
      _doLoad();
    });
  }else{
    _doLoad();
  }
}
function setEmpPeriod(period,btn){
  document.querySelectorAll('[data-period]').forEach(function(b){b.className='btn btn-outline btn-sm';b.style.borderRadius='99px';});
  if(btn){btn.className='btn btn-primary btn-sm';btn.style.borderRadius='99px';}
  var today=new Date();
  if(period==='semana'){
    var ws=getWeekStart(today),we=new Date(ws);we.setDate(ws.getDate()+6);
    empPeriod={start:ws.toISOString().split('T')[0],end:we.toISOString().split('T')[0]};
  }else if(period==='mes'){
    empPeriod={start:new Date(today.getFullYear(),today.getMonth(),1).toISOString().split('T')[0],end:new Date(today.getFullYear(),today.getMonth()+1,0).toISOString().split('T')[0]};
  }else{
    empPeriod={start:today.getFullYear()+'-01-01',end:today.getFullYear()+'-12-31'};
  }
  renderEmpGanhos();
}
function renderEmpGanhos(){
  var myLogs=db.workLogs.filter(function(l){
    return l.workDate>=empPeriod.start&&l.workDate<=empPeriod.end&&
      l.status==='Confirmado'&&(!currentEmpId||l.workLogEmployees.some(function(we){return we.employeeId===currentEmpId;}));
  });
  var total=myLogs.reduce(function(s,l){
    if(!currentEmpId)return s+l.workLogEmployees.reduce(function(ps,e){return ps+e.paymentAmount;},0);
    var we=l.workLogEmployees.find(function(w){return w.employeeId===currentEmpId;});
    return s+(we?we.paymentAmount:0);
  },0);
  if($('emp-stats'))$('emp-stats').innerHTML=
    '<div class="stat-card" style="border-left:4px solid var(--secondary)"><div class="stat-label">Total Recebido</div><div class="stat-value" style="color:var(--secondary)">'+fmtV(total)+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">Trabalhos</div><div class="stat-value">'+myLogs.length+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">PerÃ­odo</div><div class="stat-value" style="font-size:12px">'+fmtDate(empPeriod.start)+' â€“ '+fmtDate(empPeriod.end)+'</div></div>';
  if($('emp-work-list'))$('emp-work-list').innerHTML=myLogs.length===0?'<div class="empty"><div class="icon">ğŸ’¼</div>Nenhum trabalho no perÃ­odo</div>':
    myLogs.map(function(l){
      var cl=getClient(l.clientId);
      var we=currentEmpId?l.workLogEmployees.find(function(w){return w.employeeId===currentEmpId;}):null;
      var pay=we?we.paymentAmount:l.workLogEmployees.reduce(function(s,e){return s+e.paymentAmount;},0);
      return'<div class="log-row"><div class="log-info"><div class="log-date">'+fmtDate(l.workDate)+'</div>'+
        '<div class="log-client">'+(cl?cl.name:'?')+'</div></div>'+
        '<div class="log-revenue">'+fmtV(pay)+'</div></div>';
    }).join('');
}
function renderEmpAgenda(){
  var base=getWeekStart(new Date());base.setDate(base.getDate()+empWeekOffset*7);
  var days=[];for(var i=0;i<7;i++){var d=new Date(base);d.setDate(base.getDate()+i);days.push(d);}
  var startStr=days[0].toISOString().split('T')[0],endStr=days[6].toISOString().split('T')[0];
  var todayStr=new Date().toISOString().split('T')[0];
  if($('emp-week-label'))$('emp-week-label').textContent=days[0].toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})+' â€“ '+days[6].toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'});
  var mySch=db.scheduleEntries.filter(function(e){
    return e.workDate>=startStr&&e.workDate<=endStr&&(!currentEmpId||e.employeeIds.includes(currentEmpId));
  });
  var dn=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];
  if($('emp-week-grid'))$('emp-week-grid').innerHTML=days.map(function(d,i){
    var ds=d.toISOString().split('T')[0];
    var de=mySch.filter(function(e){return e.workDate===ds;});
    return'<div class="day-col'+(ds===todayStr?' today':'')+'"><div class="day-label">'+dn[i]+'</div><div class="day-num">'+d.getDate()+'</div>'+
      de.map(function(e){var cl=getClient(e.clientId);return'<div class="schedule-item '+e.status+'">'+(cl?cl.name:'?')+'</div>';}).join('')+'</div>';
  }).join('');
  if($('emp-schedule-list'))$('emp-schedule-list').innerHTML=mySch.length===0?'<div class="empty"><div class="icon">ğŸ“…</div>Nenhum agendamento</div>':
    mySch.map(function(e){
      var cl=getClient(e.clientId);
      return'<div class="log-row"><div class="log-info"><div class="log-date">'+fmtDate(e.workDate)+'</div>'+
        '<div class="log-client">'+(cl?cl.name:'?')+'</div></div>'+
        '<span class="badge '+(e.status==='confirmado'?'badge-secondary':e.status==='cancelado'?'badge-destructive':'badge-warning')+'">'+e.status+'</span></div>';
    }).join('');
}
function renderEmpClients(){
  var myIds=[...new Set(db.workLogs.filter(function(l){return!currentEmpId||l.workLogEmployees.some(function(we){return we.employeeId===currentEmpId;});}).map(function(l){return l.clientId;}) )];
  var myC=db.clients.filter(function(c){return myIds.includes(c.id);});
  if($('emp-clients-list'))$('emp-clients-list').innerHTML=myC.length===0?'<div class="empty"><div class="icon">ğŸ </div>Nenhum cliente ainda</div>':
    myC.map(function(c){
      var ce=currentEmpId?c.clientEmployees.find(function(x){return x.employeeId===currentEmpId;}):null;
      return'<div class="freq-item"><div><div style="font-weight:600">'+c.name+'</div>'+
        '<div style="font-size:12px;color:var(--text-muted)">'+c.frequency+'</div></div>'+
        '<strong style="color:var(--secondary)">'+fmtV(ce?ce.paymentAmount:0)+'</strong></div>';
    }).join('');
  var myN=db.notifications.filter(function(n){return!currentEmpId||n.employeeId===currentEmpId;});
  if($('emp-notes-list'))$('emp-notes-list').innerHTML=myN.length===0?'<div class="empty"><div class="icon">ğŸ“</div>Nenhuma observaÃ§Ã£o</div>':
    myN.map(function(n){
      var cl=getClient(n.clientId);
      return'<div class="notif-item '+n.status+'"><div style="font-weight:600;font-size:13px">'+(cl?cl.name:'?')+'</div>'+
        '<div style="font-size:12px;color:var(--text-muted)">'+fmtDate((n.createdAt||'').split('T')[0])+'</div>'+
        '<div style="margin-top:4px">'+n.note+'</div></div>';
    }).join('');
}
function renderEmpReferrals(){
  var myR=db.referrals.filter(function(r){return!currentEmpId||r.employeeId===currentEmpId;});
  var bonus=myR.filter(function(r){return r.status==='approved';}).reduce(function(s,r){return s+r.bonusAmount;},0);
  if($('emp-referrals-stats'))$('emp-referrals-stats').innerHTML=
    '<div class="stat-card"><div class="stat-label">Minhas IndicaÃ§Ãµes</div><div class="stat-value">'+myR.length+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">Aprovadas</div><div class="stat-value" style="color:var(--secondary)">'+myR.filter(function(r){return r.status==='approved';}).length+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">BÃ´nus Total</div><div class="stat-value" style="color:var(--primary)">'+fmtV(bonus)+'</div></div>';
  if($('emp-referrals-list'))$('emp-referrals-list').innerHTML=myR.length===0?'<div class="empty"><div class="icon">ğŸ</div>Nenhuma indicaÃ§Ã£o ainda</div>':
    myR.map(function(r){
      return'<div class="referral-item '+r.status+'"><div style="font-weight:600">'+r.clientName+'</div>'+
        '<div style="font-size:12px;color:var(--text-muted)">'+r.phone+'</div>'+
        '<span class="badge '+(r.status==='pending'?'badge-warning':r.status==='approved'?'badge-secondary':'badge-destructive')+'">'+r.status+'</span>'+
        (r.status==='approved'?'<div style="font-size:12px;color:var(--secondary);margin-top:4px">BÃ´nus: '+fmtV(r.bonusAmount)+'</div>':'')+
        '</div>';
    }).join('');
}
function saveEmpNote(){
  var clientId=$('note-client-sel')?$('note-client-sel').value:'';
  var note=$('note-text')?$('note-text').value.trim():'';
  if(!clientId||!note){toast('Preencha cliente e observaÃ§Ã£o','error');return;}
  sb.from('notifications').insert({client_id:clientId,employee_id:currentEmpId,note:note,status:'pending'}).then(function(r){
    if(r.error){toast('Erro: '+r.error.message,'error');return;}
    toast('ObservaÃ§Ã£o enviada!','success');closeModal('emp-note-modal');
    loadAllData(function(){renderEmpClients();});
  });
}
function saveEmpReferral(){
  var name=$('eref-name')?$('eref-name').value.trim():'';
  var phone=$('eref-phone')?$('eref-phone').value.trim():'';
  var address=$('eref-address')?$('eref-address').value.trim():'';
  var zip=$('eref-zip')?$('eref-zip').value.trim():'';
  if(!name){toast('Informe o nome do cliente','error');return;}
  sb.from('referrals').insert({employee_id:currentEmpId,client_name:name,phone:phone,address:address,zip_code:zip,status:'pending',bonus_amount:0}).then(function(r){
    if(r.error){toast('Erro: '+r.error.message,'error');return;}
    toast('IndicaÃ§Ã£o enviada!','success');closeModal('emp-ref-modal');
    loadAllData(function(){renderEmpReferrals();});
  });
}

// â”€â”€ EDITAR FUNCIONÃRIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFieldPass(fieldId,btn){
  var f=$(fieldId);if(!f)return;
  var show=f.type==='password';f.type=show?'text':'password';
  if(btn)btn.innerHTML=show?'ğŸ™ˆ':'ğŸ‘';
}
function openEditEmpModal(empId){
  var e=db.employees.find(function(x){return x.id===empId;});if(!e)return;
  if($('edit-emp-id'))$('edit-emp-id').value=empId;
  if($('edit-emp-name'))$('edit-emp-name').value=e.name;
  if($('edit-emp-email'))$('edit-emp-email').value=e.email;
  if($('edit-emp-pass'))$('edit-emp-pass').value='';
  if($('edit-emp-role'))$('edit-emp-role').value=(e.role||'colaborador');
  openModal('edit-emp-modal');
}
function saveEditEmployee(){
  var empId=$('edit-emp-id').value,name=$('edit-emp-name').value.trim();
  var email=$('edit-emp-email').value.trim().toLowerCase();
  if(!name||!email){toast('Preencha nome e email','error');return;}
  sb.from('employees').update({name:name,email:email}).eq('id',empId).then(function(r){
    if(r.error){toast('Erro: '+r.error.message,'error');return;}
    toast('Dados de "'+name+'" atualizados!','success');
    closeModal('edit-emp-modal');
    loadAllData(function(){renderEmployees();populateSelects();});
  });
}

// â”€â”€ EXPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportRankingCSV(){
  var start=$('dash-start')?$('dash-start').value:'',end=$('dash-end')?$('dash-end').value:'';
  var confirmed=db.workLogs.filter(function(l){return l.workDate>=start&&l.workDate<=end&&l.status==='Confirmado';});
  var cm={};
  confirmed.forEach(function(l){
    var c=getClient(l.clientId);if(!c)return;
    if(!cm[c.id])cm[c.id]={name:c.name,freq:c.frequency,rev:0,pay:0};
    cm[c.id].rev+=l.revenue;
    cm[c.id].pay+=l.workLogEmployees.reduce(function(s,e){return s+e.paymentAmount;},0);
  });
  var rows=[['#','Cliente','FrequÃªncia','Receita','Custo M.O.','Lucro']];
  Object.values(cm).sort(function(a,b){return(b.rev-b.pay)-(a.rev-a.pay);}).forEach(function(c,i){
    rows.push([i+1,c.name,c.freq,c.rev.toFixed(2),c.pay.toFixed(2),(c.rev-c.pay).toFixed(2)]);
  });
  var csv=rows.map(function(r){return r.map(function(v){return'"'+v+'"';}).join(',');}).join('\n');
  var blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='ranking-'+start+'-'+end+'.csv';a.click();
}

// â”€â”€ DOM CONTENT LOADED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded',function(){
  // â”€â”€ Loading overlay â”€â”€
  showLoading();

  // â”€â”€ Restaurar sessÃ£o (evita flicker no F5) â”€â”€
  sb.auth.getSession().then(function(res){
    var session=res.data&&res.data.session;
    if(!session){
      hideLoading();
      return; // mostra tela de login
    }
    _loginSuccess(session.user); // hideLoading Ã© chamado dentro de initApp/initEmpApp
  });

  // Senha toggle
  var tp=$('toggle-pass');
  if(tp)tp.addEventListener('click',function(){
    var f=$('login-pass');if(!f)return;
    var show=f.type==='password';f.type=show?'text':'password';
    var ic=$('eye-icon');if(ic)ic.setAttribute('opacity',show?'0.5':'1');
  });

  // Sidebar
  document.querySelectorAll('.sidebar .nav-item').forEach(function(b){
    b.addEventListener('click',function(){navigate(b.dataset.tab);});
  });

  // Menu mobile
  var mt=$('menu-toggle'),so=$('sidebar-overlay'),sb2=$('sidebar');
  if(mt)mt.addEventListener('click',function(){if(sb2)sb2.classList.toggle('open');if(so)so.classList.toggle('open');});
  if(so)so.addEventListener('click',function(){if(sb2)sb2.classList.remove('open');so.classList.remove('open');});

  // Login/Logout
  if($('btn-login'))$('btn-login').addEventListener('click',doLogin);
  if($('login-pass'))$('login-pass').addEventListener('keydown',function(e){if(e.key==='Enter')doLogin();});
  if($('btn-logout-adm'))$('btn-logout-adm').addEventListener('click',doLogout);
  if($('btn-logout-emp'))$('btn-logout-emp').addEventListener('click',doLogout);
  if($('btn-to-forgot'))$('btn-to-forgot').addEventListener('click',function(){toggleView('forgot-form');});
  if($('btn-to-register'))$('btn-to-register').addEventListener('click',function(){toggleView('register-form');});
  if($('btn-reg-back'))$('btn-reg-back').addEventListener('click',function(){toggleView('login-form');});
  if($('btn-forgot-back'))$('btn-forgot-back').addEventListener('click',function(){toggleView('login-form');});

  // Dashboard
  if($('dash-start'))$('dash-start').addEventListener('change',renderDashboard);
  if($('dash-end'))$('dash-end').addEventListener('change',renderDashboard);
  if($('dash-month'))$('dash-month').addEventListener('change',function(){
    var v=$('dash-month').value;if(!v)return;
    var y=v.split('-')[0],m=v.split('-')[1];
    if($('dash-start'))$('dash-start').value=y+'-'+m+'-01';
    if($('dash-end'))$('dash-end').value=y+'-'+m+'-'+String(new Date(y,m,0).getDate()).padStart(2,'0');
    renderDashboard();
  });
  if($('btn-export-csv'))$('btn-export-csv').addEventListener('click',exportRankingCSV);
  if($('btn-print-dash'))$('btn-print-dash').addEventListener('click',function(){window.print();});
  if($('btn-banner-ver'))$('btn-banner-ver').addEventListener('click',function(){navigate('notifications');});

  // Agenda
  if($('btn-add-sch-emp-row'))$('btn-add-sch-emp-row').addEventListener('click',function(){addSchEmpRow('');});
  if($('btn-add-schedule'))$('btn-add-schedule').addEventListener('click',function(){
    if($('sch-emp-rows'))$('sch-emp-rows').innerHTML='';
    if($('sch-date'))$('sch-date').value=new Date().toISOString().split('T')[0];
    if($('sch-client'))$('sch-client').value='';
    if($('sch-status'))$('sch-status').value='pendente';
    if($('sch-notes'))$('sch-notes').value='';
    var h2=document.querySelector('#schedule-modal h2');
    if(h2)h2.innerHTML='&#x1F4C5; Novo Agendamento';
    openModal('schedule-modal');
  });
  if($('btn-save-schedule'))$('btn-save-schedule').addEventListener('click',saveSchedule);
  if($('btn-cancel-schedule'))$('btn-cancel-schedule').addEventListener('click',function(){
    closeModal('schedule-modal');
    var btn=$('btn-save-schedule');if(btn){btn.onclick=null;btn.addEventListener('click',saveSchedule);}
  });
  if($('prev-week'))$('prev-week').addEventListener('click',function(){weekOffset--;renderSchedule();});
  if($('next-week'))$('next-week').addEventListener('click',function(){weekOffset++;renderSchedule();});

  // Checklist
  if($('btn-add-worklog'))$('btn-add-worklog').addEventListener('click',openAddWorkLog);
  if($('btn-save-worklog'))$('btn-save-worklog').addEventListener('click',saveWorkLog);
  if($('btn-cancel-worklog'))$('btn-cancel-worklog').addEventListener('click',function(){closeModal('checklist-modal');});
  if($('btn-add-emp-row'))$('btn-add-emp-row').addEventListener('click',addEmpRow);
  if($('cl-start'))$('cl-start').addEventListener('change',renderChecklist);
  if($('cl-end'))$('cl-end').addEventListener('change',renderChecklist);
  if($('cl-month'))$('cl-month').addEventListener('change',function(){
    var v=$('cl-month').value;if(!v)return;
    var y=v.split('-')[0],m=v.split('-')[1];
    if($('cl-start'))$('cl-start').value=y+'-'+m+'-01';
    if($('cl-end'))$('cl-end').value=y+'-'+m+'-'+String(new Date(y,m,0).getDate()).padStart(2,'0');
    renderChecklist();
  });
  if($('cl-status'))$('cl-status').addEventListener('change',function(){
    if($('cl-reason-group'))$('cl-reason-group').classList.toggle('hidden',$('cl-status').value!=='Cancelado');
  });

  // Clientes
  if($('btn-add-client'))$('btn-add-client').addEventListener('click',openAddClient);
  if($('btn-save-client'))$('btn-save-client').addEventListener('click',saveClient);
  if($('btn-cancel-client'))$('btn-cancel-client').addEventListener('click',function(){closeModal('client-modal');});
  if($('btn-add-client-emp'))$('btn-add-client-emp').addEventListener('click',function(){addClientEmpRow();});

  // FuncionÃ¡rios
  if($('btn-add-emp'))$('btn-add-emp').addEventListener('click',function(){openModal('emp-modal');});
  if($('btn-save-emp'))$('btn-save-emp').addEventListener('click',saveEmployee);
  if($('btn-cancel-emp'))$('btn-cancel-emp').addEventListener('click',function(){closeModal('emp-modal');});
  if($('btn-save-edit-emp'))$('btn-save-edit-emp').addEventListener('click',saveEditEmployee);
  if($('btn-cancel-edit-emp'))$('btn-cancel-edit-emp').addEventListener('click',function(){closeModal('edit-emp-modal');});
  var etabs=document.querySelectorAll('.tabs-nav .tab-btn');
  if(etabs.length>=2){
    etabs[0].addEventListener('click',function(){etabs.forEach(function(b){b.classList.remove('active');});etabs[0].classList.add('active');if($('active-emps'))$('active-emps').classList.remove('hidden');if($('pending-users'))$('pending-users').classList.add('hidden');});
    etabs[1].addEventListener('click',function(){etabs.forEach(function(b){b.classList.remove('active');});etabs[1].classList.add('active');if($('active-emps'))$('active-emps').classList.add('hidden');if($('pending-users'))$('pending-users').classList.remove('hidden');});
  }

  // Custos
  if($('btn-add-cost'))$('btn-add-cost').addEventListener('click',function(){openModal('cost-modal');});
  if($('btn-save-cost'))$('btn-save-cost').addEventListener('click',saveCost);
  if($('btn-cancel-cost'))$('btn-cancel-cost').addEventListener('click',function(){closeModal('cost-modal');});
  ['filter-all','filter-recorrente','filter-unico'].forEach(function(id){
    if($(id))$(id).addEventListener('click',function(){
      costsFilter=id==='filter-all'?'all':id.replace('filter-','');renderCosts();
    });
  });

  // FrequÃªncias
  if($('btn-add-freq'))$('btn-add-freq').addEventListener('click',function(){
    if($('freq-edit-id'))$('freq-edit-id').value='';
    if($('freq-name'))$('freq-name').value='';
    if($('freq-modal-title'))$('freq-modal-title').textContent='Adicionar FrequÃªncia';
    openModal('freq-modal');
  });
  if($('btn-save-freq'))$('btn-save-freq').addEventListener('click',saveFreq);
  if($('btn-cancel-freq'))$('btn-cancel-freq').addEventListener('click',function(){closeModal('freq-modal');});

  // Perfil
  if($('btn-save-profile'))$('btn-save-profile').addEventListener('click',function(){toast('Para alterar a senha use "Esqueci minha senha" na tela de login.','info');});

  // Employee app
  if($('emp-prev-week'))$('emp-prev-week').addEventListener('click',function(){empWeekOffset--;renderEmpAgenda();});
  if($('emp-next-week'))$('emp-next-week').addEventListener('click',function(){empWeekOffset++;renderEmpAgenda();});
  if($('btn-emp-note'))$('btn-emp-note').addEventListener('click',function(){
    if($('note-client-sel'))$('note-client-sel').innerHTML=db.clients.map(function(c){return'<option value="'+c.id+'">'+c.name+'</option>';}).join('');
    if($('note-text'))$('note-text').value='';openModal('emp-note-modal');
  });
  if($('btn-save-note'))$('btn-save-note').addEventListener('click',saveEmpNote);
  if($('btn-cancel-note'))$('btn-cancel-note').addEventListener('click',function(){closeModal('emp-note-modal');});
  if($('btn-emp-ref'))$('btn-emp-ref').addEventListener('click',function(){openModal('emp-ref-modal');});
  if($('btn-save-emp-ref'))$('btn-save-emp-ref').addEventListener('click',saveEmpReferral);
  if($('btn-cancel-emp-ref'))$('btn-cancel-emp-ref').addEventListener('click',function(){closeModal('emp-ref-modal');});
  if($('btn-save-edit-ref'))$('btn-save-edit-ref').addEventListener('click',saveEditReferral);
  if($('btn-cancel-edit-ref'))$('btn-cancel-edit-ref').addEventListener('click',function(){closeModal('edit-ref-modal');});
  if($('edit-ref-status'))$('edit-ref-status').addEventListener('change',function(){
    var bg=$('edit-ref-bonus-group');if(bg)bg.style.display=(this.value==='approved')?'block':'none';
  });
  document.querySelectorAll('[data-period]').forEach(function(b){
    b.addEventListener('click',function(){setEmpPeriod(b.dataset.period,b);});
  });
  if($('btn-save-emp-profile'))$('btn-save-emp-profile').addEventListener('click',function(){toast('Para alterar a senha use "Esqueci minha senha" na tela de login.','info');});

  // â”€â”€ DelegaÃ§Ã£o global de cliques (delete/edit/approve) â”€â”€
  document.addEventListener('click',function(e){
    var t;

    if((t=e.target.closest('[data-del-log]'))){
      var id=t.dataset.delLog;
      sb.from('work_log_employees').delete().eq('work_log_id',id).then(function(){
        sb.from('work_logs').delete().eq('id',id).then(function(){loadAllData(function(){renderChecklist();renderDashboard();});});
      });return;
    }
    if((t=e.target.closest('[data-edit-log]'))){editWorkLog(t.dataset.editLog);return;}
    if((t=e.target.closest('[data-del-client]'))){
      var id=t.dataset.delClient;
      sb.from('client_employees').delete().eq('client_id',id).then(function(){
        sb.from('clients').delete().eq('id',id).then(function(){loadAllData(function(){renderClients();populateSelects();});});
      });return;
    }
    if((t=e.target.closest('[data-edit-client]'))){editClient(t.dataset.editClient);return;}
    if((t=e.target.closest('[data-del-emp]'))){
      sb.from('employees').delete().eq('id',t.dataset.delEmp).then(function(){loadAllData(function(){renderEmployees();populateSelects();});});return;
    }
    if((t=e.target.closest('[data-edit-emp]'))){openEditEmpModal(t.dataset.editEmp);return;}
    if((t=e.target.closest('[data-del-cost]'))){
      sb.from('costs').delete().eq('id',t.dataset.delCost).then(function(){loadAllData(function(){renderCosts();});});return;
    }
    if((t=e.target.closest('[data-del-freq]'))){
      sb.from('frequencies').delete().eq('id',t.dataset.delFreq).then(function(){loadAllData(function(){renderFrequencies();populateSelects();});});return;
    }
    if((t=e.target.closest('[data-edit-schedule]'))){
      openEditScheduleModal(t.dataset.editSchedule);return;
    }
    if((t=e.target.closest('[data-del-schedule]'))){
      if(!confirm('Excluir este agendamento?'))return;
      var id=t.dataset.delSchedule;
      sb.from('schedule_employees').delete().eq('schedule_id',id).then(function(){
        sb.from('schedule_entries').delete().eq('id',id).then(function(){loadAllData(function(){renderSchedule();});});
      });return;
    }
    if((t=e.target.closest('[data-edit-ref]'))){
      openEditReferralModal(t.dataset.editRef);return;
    }
    if((t=e.target.closest('[data-del-ref]'))){
      if(!confirm('Excluir esta indicaÃ§Ã£o?'))return;
      sb.from('referrals').delete().eq('id',t.dataset.delRef).then(function(){
        toast('IndicaÃ§Ã£o excluÃ­da!','success');
        loadAllData(function(){renderReferrals();});
      });return;
    }
    if((t=e.target.closest('[data-read-notif]'))){
      sb.from('notifications').update({status:'read'}).eq('id',t.dataset.readNotif).then(function(){loadAllData(function(){renderNotifications();updateNotifBadge();});});return;
    }
    if((t=e.target.closest('[data-del-notif]'))){
      sb.from('notifications').delete().eq('id',t.dataset.delNotif).then(function(){loadAllData(function(){renderNotifications();updateNotifBadge();});});return;
    }
    if((t=e.target.closest('[data-approve-ref]'))){
      var id=t.dataset.approveRef;
      var bonus=parseFloat(prompt('Valor do bÃ´nus (R$):','0'))||0;
      sb.from('referrals').update({status:'approved',bonus_amount:bonus}).eq('id',id).then(function(){loadAllData(function(){renderReferrals();});});return;
    }
    if((t=e.target.closest('[data-reject-ref]'))){
      sb.from('referrals').update({status:'rejected'}).eq('id',t.dataset.rejectRef).then(function(){loadAllData(function(){renderReferrals();});});return;
    }
  });
});

</script>
</body>
</html>
