<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="description" content="WR Cleaning Service â€” Sistema de GestÃ£o Financeira.">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WR Cleaning Service</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--primary:#2563eb;--primary-light:#dbeafe;--primary-dark:#1d4ed8;--secondary:#10b981;--secondary-light:#d1fae5;--destructive:#ef4444;--destructive-light:#fee2e2;--warning:#f97316;--warning-light:#ffedd5;--bg:#f8fafc;--card:#ffffff;--border:#e2e8f0;--text:#0f172a;--text-muted:#64748b;--sidebar-w:240px;--header-h:64px;--radius:10px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
button{cursor:pointer;font-family:inherit;border:none;background:none}
input,select,textarea{font-family:inherit}
.hidden{display:none!important}
.mb-4{margin-bottom:16px}.mt-4{margin-top:16px}

/* TOAST */
#toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;font-size:13px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.12);min-width:260px;display:flex;align-items:center;gap:8px;animation:slideIn .25s ease}
.toast.success{border-left:4px solid var(--secondary)}
.toast.error{border-left:4px solid var(--destructive)}
@keyframes slideIn{from{transform:translateX(60px);opacity:0}to{transform:translateX(0);opacity:1}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;animation:fadeIn .15s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--card);border-radius:14px;padding:28px;width:100%;max-width:460px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.18)}
.modal h2{font-size:18px;font-weight:700;margin-bottom:20px}
.modal-lg{max-width:600px}

/* FORMS */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:5px}
.form-control{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;outline:none;transition:border-color .15s;background:#fff}
.form-control:focus{border-color:var(--primary)}
select.form-control{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
textarea.form-control{resize:vertical;min-height:80px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;transition:all .15s;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff;border:1.5px solid var(--primary)}
.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{background:var(--secondary);color:#fff;border:1.5px solid var(--secondary)}
.btn-outline{background:transparent;color:var(--text);border:1.5px solid var(--border)}
.btn-outline:hover{background:var(--bg)}
.btn-ghost{background:transparent;color:var(--text-muted);border:1.5px solid transparent;padding:6px 10px}
.btn-ghost:hover{background:var(--bg);color:var(--text)}
.btn-danger{background:var(--destructive-light);color:var(--destructive);border:1.5px solid transparent}
.btn-danger:hover{background:var(--destructive);color:#fff}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-icon{padding:7px;border-radius:7px}
.btn-full{width:100%}

/* BADGE */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:99px;font-size:11px;font-weight:600}
.badge-primary{background:var(--primary-light);color:var(--primary)}
.badge-secondary{background:var(--secondary-light);color:var(--secondary)}
.badge-destructive{background:var(--destructive-light);color:var(--destructive)}
.badge-warning{background:var(--warning-light);color:var(--warning)}
.badge-gray{background:#f1f5f9;color:var(--text-muted)}
.badge-pending{background:var(--primary-light);color:var(--primary)}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.card-header{padding:16px 20px 8px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-header h3{font-size:15px;font-weight:700}
.card-body{padding:16px 20px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px}
.stat-card .stat-label{font-size:12px;font-weight:500;color:var(--text-muted);margin-bottom:4px}
.stat-card .stat-value{font-size:26px;font-weight:700}

/* TABLE */
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th{text-align:left;padding:10px 12px;font-weight:600;border-bottom:2px solid var(--border);color:var(--text-muted);font-size:12px}
.table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
.table tr:last-child td{border-bottom:none}
.table tr:hover td{background:var(--bg)}
.table-responsive{overflow-x:auto}

/* LOGIN */
#login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary-light) 0%,#fff 50%,var(--secondary-light) 100%);padding:20px}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:40px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(37,99,235,.1)}
.login-logo{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:28px}
.login-logo .spark{color:var(--primary);font-size:36px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.login-logo h1{font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center}
.login-logo p{font-size:13px;color:var(--text-muted)}
.login-switch{text-align:center;font-size:13px;color:var(--text-muted);margin-top:10px}
.login-switch button{color:var(--primary);font-weight:600;cursor:pointer}
.login-switch button:hover{text-decoration:underline}

/* APP */
#app-page,#emp-app-page{display:flex;flex-direction:column;min-height:100vh}
.app-header{height:var(--header-h);background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:100;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.header-logo{display:flex;align-items:center;gap:10px}
.header-logo .spark{color:var(--primary);font-size:22px}
.header-logo h2{font-size:16px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-logo span{font-size:10px;color:var(--text-muted);display:block}
.header-right{display:flex;align-items:center;gap:12px}
.user-info .name{font-size:13px;font-weight:600}
.user-info .email{font-size:11px;color:var(--text-muted)}
.app-body{display:flex;flex:1}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);background:var(--card);border-right:1px solid var(--border);padding:12px 10px;position:sticky;top:var(--header-h);height:calc(100vh - var(--header-h));overflow-y:auto;flex-shrink:0}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;font-size:13px;font-weight:500;color:var(--text-muted);cursor:pointer;transition:all .15s;width:100%}
.nav-item:hover{background:var(--bg);color:var(--text)}
.nav-item.active{background:var(--primary);color:#fff}
.nav-item .icon{font-size:16px;flex-shrink:0}
.nav-badge{margin-left:auto;background:var(--destructive);color:#fff;font-size:10px;font-weight:700;border-radius:99px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;padding:0 4px}
.main-content{flex:1;padding:24px;overflow-x:hidden}

/* TABS */
.tab-content{display:none;animation:fadeUp .2s ease}
.tab-content.active{display:block}
@keyframes fadeUp{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.page-header h2{font-size:22px;font-weight:800}

/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0}

/* NOTIF BANNER */
.notif-banner{background:var(--destructive-light);border:1px solid #fca5a5;border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:20px}
.notif-banner .title{font-weight:700;color:var(--destructive);font-size:14px}
.notif-banner .desc{font-size:12px;color:var(--text-muted)}

/* LOG ROW */
.log-row{border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.log-row:hover{border-color:var(--primary)}
.log-row .log-date{font-size:12px;color:var(--text-muted)}
.log-row .log-client{font-size:14px;font-weight:600}
.log-row .log-employees{font-size:12px;color:var(--text-muted);margin-top:4px}
.log-row .log-revenue{font-size:16px;font-weight:700;color:var(--secondary)}

/* WEEK SCHEDULE */
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day-col{border:1px solid var(--border);border-radius:8px;min-height:100px;padding:8px}
.day-col .day-label{font-size:11px;font-weight:700;text-align:center;color:var(--text-muted);margin-bottom:6px}
.day-col .day-num{font-size:16px;font-weight:700;text-align:center;margin-bottom:8px}
.day-col.today{border-color:var(--primary);background:var(--primary-light)}
.schedule-item{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:11px;margin-bottom:4px}
.schedule-item.confirmado{border-left:3px solid var(--secondary)}
.schedule-item.pendente{border-left:3px solid var(--warning)}
.schedule-item.cancelado{border-left:3px solid var(--destructive);opacity:.7}

/* COST */
.cost-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px}
.cost-item:hover{border-color:var(--primary)}
.cost-item .cost-cat{font-size:11px;font-weight:600;color:var(--text-muted)}
.cost-item .cost-desc{font-size:14px;font-weight:500}
.cost-item .cost-amount{font-size:16px;font-weight:700}

/* REFERRAL */
.referral-item{border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px}
.referral-item.pending{border-left:4px solid var(--warning)}
.referral-item.approved{border-left:4px solid var(--secondary)}
.referral-item.rejected{border-left:4px solid var(--destructive)}

/* SUMMARY */
.summary-block{background:var(--bg);border-radius:8px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.summary-block .emp-name{font-size:13px;font-weight:600}
.summary-block .emp-count{font-size:12px;color:var(--text-muted)}
.summary-block .emp-total{font-size:16px;font-weight:700;color:var(--primary)}

/* PROFILE */
.profile-avatar{width:72px;height:72px;border-radius:99px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;font-weight:700}

/* FREQ */
.freq-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.freq-item:hover{border-color:var(--primary);background:var(--bg)}

/* NOTIF ITEM */
.notif-item{border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px}
.notif-item.pending{border-left:4px solid var(--destructive)}
.notif-item.read{border-left:4px solid var(--border);opacity:.8}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--text-muted);font-size:14px}
.empty .icon{font-size:40px;margin-bottom:8px}

/* TABS NAV */
.tabs-nav{display:flex;gap:4px;background:var(--bg);border-radius:8px;padding:4px;margin-bottom:16px}
.tab-btn{flex:1;padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;color:var(--text-muted);text-align:center;cursor:pointer;transition:all .15s}
.tab-btn.active{background:var(--card);color:var(--primary);box-shadow:0 1px 4px rgba(0,0,0,.1)}

/* EMP TAB */
.emp-tab-btn{padding:12px 16px;font-size:13px;font-weight:600;color:var(--text-muted);border-bottom:2px solid transparent;cursor:pointer;background:none;border-top:none;border-left:none;border-right:none;white-space:nowrap;transition:all .15s}
.emp-tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.emp-tab-btn:hover{color:var(--text);background:var(--bg)}
.emp-pill{display:inline-flex;align-items:center;gap:6px;background:var(--primary-light);color:var(--primary);border-radius:99px;padding:3px 10px;font-size:12px;font-weight:500}

/* MOBILE */
.mobile-menu-btn{display:none}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:150;top:var(--header-h)}
@media(max-width:768px){
  .sidebar{display:none;position:fixed;left:0;top:var(--header-h);height:calc(100vh - var(--header-h));z-index:200;transform:translateX(-100%);transition:transform .25s}
  .sidebar.open{display:flex;flex-direction:column;transform:translateX(0)}
  .mobile-menu-btn{display:flex}
  .main-content{padding:16px}
  .grid-4{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr 1fr}
  .grid-2{grid-template-columns:1fr}
  .week-grid{grid-template-columns:repeat(4,1fr)}
  .user-info{display:none}
  .sidebar-overlay.open{display:block}
}

/* PASSWORD TOGGLE */
.pass-wrapper{position:relative}.pass-wrapper .form-control{padding-right:44px}
.pass-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;display:flex;align-items:center}.pass-toggle:hover{color:var(--primary)}
/* FORM VALIDATION */
.form-control.is-error{border-color:var(--destructive)!important;box-shadow:0 0 0 3px rgba(239,68,68,.12)}
.form-error{color:var(--destructive);font-size:11px;margin-top:4px;display:none;font-weight:500}.form-error.show{display:block}
/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.chart-container{position:relative;height:270px;padding:4px 8px 12px}
/* USER ROLE BADGE */
.role-badge-adm{background:#dbeafe;color:#1d4ed8;font-size:10px;padding:2px 7px;border-radius:99px;font-weight:700}
.role-badge-col{background:#d1fae5;color:#065f46;font-size:10px;padding:2px 7px;border-radius:99px;font-weight:700}
.no-login-badge{background:#f1f5f9;color:#94a3b8;font-size:10px;padding:2px 7px;border-radius:99px;font-weight:600}
/* AGENDA MOBILE */
.week-scroll-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
.week-scroll-wrapper::-webkit-scrollbar{height:4px}
.week-scroll-wrapper::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.day-col{min-width:120px}
.schedule-header-row{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.schedule-nav-group{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.log-row-inner{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
/* PRINT */
@media print{.sidebar,.app-header,.mobile-menu-btn,.charts-grid,.notif-banner,.btn{display:none!important}.main-content{padding:0}body{background:#fff}}
@media(max-width:768px){
  .schedule-header-row{flex-direction:column;align-items:flex-start}
  .week-grid{grid-template-columns:repeat(7,minmax(108px,1fr));min-width:756px}
  .log-row-inner{flex-direction:column;gap:6px}
}
@media(max-width:480px){
  .grid-4{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr}.grid-2{grid-template-columns:1fr}
  .charts-grid{grid-template-columns:1fr}.stat-card .stat-value{font-size:20px}
  .main-content{padding:10px}.modal{padding:16px 14px}.login-card{padding:28px 18px}
  .week-grid{grid-template-columns:repeat(7,minmax(90px,1fr));min-width:630px}
  .day-col{padding:6px;min-width:90px}.schedule-nav-group{width:100%;justify-content:space-between}
  .log-row{flex-direction:column;gap:8px}.page-header{flex-direction:column;align-items:flex-start;gap:8px}
  .page-header > div{width:100%;justify-content:space-between}.card-header{flex-wrap:wrap;gap:6px}
}
@media(prefers-color-scheme:dark){
  :root{--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--text-muted:#94a3b8;--border:#334155;--primary-light:#1e3a5f;--secondary-light:#064e3b;--destructive-light:#450a0a;--warning-light:#431407}
  .form-control{background:#0f172a;color:var(--text);border-color:var(--border)}
  select.form-control option{background:#1e293b;color:#f1f5f9}
  .login-logo h1,.header-logo h2{-webkit-text-fill-color:unset;background:none;color:var(--primary)}
  #login-page{background:linear-gradient(135deg,#1e293b 0%,#0f172a 60%,#064e3b 100%)}
  .tab-btn.active{background:var(--card)}.schedule-item{background:#1e293b}
  .day-col.today{background:#1e3a5f;border-color:var(--primary)}.summary-block{background:#1e3a5f}
  .table tr:hover td{background:#1e3a5f}
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="toast-container"></div>

<!-- â•â• LOGIN â•â• -->
<div id="login-page">
  <div class="login-card">
    <div class="login-logo">
      <div class="spark">âœ¦</div>
      <h1>WR Cleaning Service</h1>
      <p>Sistema de GestÃ£o Financeira</p>
    </div>
    <div id="login-form">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" class="form-control" id="login-email" placeholder="seu@email.com" autocomplete="email"/>
        <span class="form-error" id="login-email-err">Por favor, insira um email vÃ¡lido</span>
      </div>
      <div class="form-group">
        <label for="login-pass">Senha</label>
        <div class="pass-wrapper">
          <input type="password" class="form-control" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
          <button class="pass-toggle" id="toggle-pass" type="button" aria-label="Mostrar senha">
            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <span class="form-error" id="login-pass-err">Senha nÃ£o pode estar vazia</span>
      </div>
      <button class="btn btn-primary btn-full" id="btn-login">Entrar</button>
      <div class="login-switch"><button id="btn-to-forgot">Esqueci minha senha</button></div>
      <div class="login-switch">NÃ£o tem conta? <button id="btn-to-register">Criar conta</button></div>
    </div>
    <div id="register-form" class="hidden">
      <div class="form-group"><label>Email</label><input type="email" class="form-control" placeholder="seu@email.com"/></div>
      <button class="btn btn-primary btn-full" id="btn-send-otp">Enviar CÃ³digo</button>
      <div class="login-switch"><button id="btn-reg-back">Voltar ao Login</button></div>
    </div>
    <div id="forgot-form" class="hidden">
      <div class="form-group"><label>Email</label><input type="email" class="form-control" placeholder="seu@email.com"/></div>
      <button class="btn btn-primary btn-full" id="btn-send-forgot">Enviar CÃ³digo de VerificaÃ§Ã£o</button>
      <div class="login-switch"><button id="btn-forgot-back">Voltar ao login</button></div>
    </div>
  </div>
</div>

<!-- â•â• ADM APP â•â• -->
<div id="app-page" class="hidden">
  <header class="app-header">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="btn btn-ghost btn-icon mobile-menu-btn" id="menu-toggle">â˜°</button>
      <div class="header-logo">
        <span class="spark">âœ¦</span>
        <div><h2>WR Cleaning Service</h2><span>Painel Administrativo</span></div>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div class="name" id="header-username"></div>
        <div class="email" id="header-email"></div>
      </div>
      <button class="btn btn-outline btn-sm" id="btn-logout-adm">â¬¡ Sair</button>
    </div>
  </header>
  <div class="app-body">
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="sidebar" id="sidebar">
      <nav role="navigation" aria-label="NavegaÃ§Ã£o principal">
        <button class="nav-item active" data-tab="dashboard" aria-label="Dashboard" aria-current="page"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg><span>Dashboard</span></button>
        <button class="nav-item" data-tab="schedule" aria-label="Agenda"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Agenda</span></button>
        <button class="nav-item" data-tab="checklist" aria-label="Pagamentos"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 1 0 0 7h5a3.5 3.5 0 1 1 0 7H6"/></svg><span>Pagamentos</span></button>
        <button class="nav-item" data-tab="clients" aria-label="Clientes"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Clientes</span></button>
        <button class="nav-item" data-tab="employees" aria-label="FuncionÃ¡rios"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>FuncionÃ¡rios</span></button>
        <button class="nav-item" data-tab="costs" aria-label="Custos"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span>Custos</span></button>
        <button class="nav-item" data-tab="notifications" aria-label="NotificaÃ§Ãµes"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>NotificaÃ§Ãµes</span><span class="nav-badge hidden" id="notif-badge">0</span></button>
        <button class="nav-item" data-tab="frequencies" aria-label="FrequÃªncias"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8.01" y2="14"/><line x1="12" y1="14" x2="12.01" y2="14"/></svg><span>FrequÃªncias</span></button>
        <button class="nav-item" data-tab="referrals" aria-label="IndicaÃ§Ãµes"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg><span>IndicaÃ§Ãµes</span></button>
        <button class="nav-item" data-tab="profile" aria-label="Perfil"><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Perfil</span></button>
      </nav>
    </aside>
    <main class="main-content">
      <div class="notif-banner hidden" id="main-notif-banner">
        <span style="font-size:18px;color:var(--destructive)">ğŸ””</span>
        <div style="flex:1"><div class="title" id="banner-title"></div><div class="desc">ObservaÃ§Ãµes de funcionÃ¡rios aguardam sua visualizaÃ§Ã£o</div></div>
        <button class="btn btn-outline btn-sm" id="btn-banner-ver">Ver</button>
      </div>

      <!-- DASHBOARD -->
      <div class="tab-content active" id="tab-dashboard">
        <div class="card mb-4">
          <div class="card-header"><h3>Filtros de PerÃ­odo</h3></div>
          <div class="card-body">
            <div class="grid-3" style="gap:12px">
              <div class="form-group" style="margin:0"><label>Data Inicial</label><input type="date" class="form-control" id="dash-start" value="2026-02-01"/></div>
              <div class="form-group" style="margin:0"><label>Data Final</label><input type="date" class="form-control" id="dash-end" value="2026-02-28"/></div>
              <div class="form-group" style="margin:0"><label>MÃªs/Ano</label><input type="month" class="form-control" id="dash-month" value="2026-02"/></div>
            </div>
          </div>
        </div>
        <div class="grid-4 mb-4" id="dash-stats"></div>
        <div class="grid-3 mb-4" id="dash-secondary"></div>
        <div class="charts-grid mb-4">
          <div class="card"><div class="card-header"><h3>ğŸ“Š Receita vs Custo M.O.</h3></div><div class="chart-container"><canvas id="chart-revenue-cost"></canvas></div></div>
          <div class="card"><div class="card-header"><h3>ğŸ“ˆ Lucro por Trabalho</h3></div><div class="chart-container"><canvas id="chart-profit"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Ranking de Lucratividade por Cliente</h3><div style="display:flex;gap:6px"><button class="btn btn-outline btn-sm" id="btn-export-csv">ğŸ“¥ CSV</button><button class="btn btn-outline btn-sm" id="btn-print-dash">ğŸ–¨ Imprimir</button></div></div>
          <div class="card-body table-responsive">
            <table class="table"><thead><tr><th>#</th><th>Cliente</th><th>FrequÃªncia</th><th style="text-align:right">Valor Cobrado</th><th style="text-align:right">Custo M.O.</th><th style="text-align:right">Lucro</th></tr></thead><tbody id="ranking-body"></tbody></table>
          </div>
        </div>
      </div>

      <!-- SCHEDULE -->
      <div class="tab-content" id="tab-schedule">
        <div class="page-header">
          <h2>ğŸ“… Agenda Semanal</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-outline btn-sm" id="prev-week">â—€</button>
            <span id="week-label" style="font-size:13px;font-weight:600"></span>
            <button class="btn btn-outline btn-sm" id="next-week">â–¶</button>
            <button class="btn btn-primary btn-sm" id="btn-add-schedule">+ Adicionar</button>
          </div>
        </div>
        <div class="week-scroll-wrapper"><div class="week-grid" id="week-grid"></div></div>
        <div class="card mt-4"><div class="card-header"><h3>Lista de Agendamentos</h3><span id="schedule-count-badge" class="badge badge-gray" style="font-size:11px"></span></div><div class="card-body" id="schedule-list"></div></div>
      </div>

      <!-- CHECKLIST -->
      <div class="tab-content" id="tab-checklist">
        <div class="page-header">
          <h2>ğŸ’µ Registros de Trabalho</h2>
          <button class="btn btn-primary" id="btn-add-worklog">+ Novo Registro</button>
        </div>
        <div class="card mb-4">
          <div class="card-header"><h3>Filtros</h3></div>
          <div class="card-body">
            <div class="grid-3">
              <div class="form-group" style="margin:0"><label>Data Inicial</label><input type="date" class="form-control" id="cl-start" value="2026-02-01"/></div>
              <div class="form-group" style="margin:0"><label>Data Final</label><input type="date" class="form-control" id="cl-end" value="2026-02-28"/></div>
              <div class="form-group" style="margin:0"><label>MÃªs/Ano</label><input type="month" class="form-control" id="cl-month" value="2026-02"/></div>
            </div>
          </div>
        </div>
        <div class="grid-2 mb-4">
          <div class="card"><div class="card-header"><h3>Resumo por FuncionÃ¡ria</h3></div><div class="card-body" id="emp-payments-summary"></div></div>
          <div class="card"><div class="card-header"><h3>Status do PerÃ­odo</h3></div><div class="card-body" id="cl-period-stats"></div></div>
        </div>
        <div id="work-logs-list"></div>
      </div>

      <!-- CLIENTS -->
      <div class="tab-content" id="tab-clients">
        <div class="page-header"><h2>ğŸ‘¥ Clientes</h2><button class="btn btn-primary" id="btn-add-client">+ Adicionar Cliente</button></div>
        <div class="card"><div class="card-body table-responsive">
          <table class="table"><thead><tr><th>Nome</th><th>FrequÃªncia</th><th>Valor</th><th>FuncionÃ¡rias</th><th>Transporte</th><th>AÃ§Ãµes</th></tr></thead><tbody id="clients-table-body"></tbody></table>
        </div></div>
      </div>

      <!-- EMPLOYEES -->
      <div class="tab-content" id="tab-employees">
        <div class="tabs-nav">
          <div class="tab-btn active" id="emp-tab-active">FuncionÃ¡rios Ativos</div>
          <div class="tab-btn" id="emp-tab-pending">UsuÃ¡rios Pendentes</div>
        </div>
        <div id="active-emps">
          <div class="page-header"><h2>ğŸ’¼ FuncionÃ¡rios</h2><button class="btn btn-primary" id="btn-add-emp">+ Adicionar</button></div>
          <div class="card"><div class="card-body table-responsive">
            <table class="table"><thead><tr><th>Nome</th><th>Email</th><th>Papel</th><th>Desde</th><th>AÃ§Ãµes</th></tr></thead><tbody id="emp-table-body"></tbody></table>
          </div></div>
        </div>
        <div id="pending-users" class="hidden">
          <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">â³ UsuÃ¡rios Pendentes</h2>
          <div id="pending-list"></div>
        </div>
      </div>

      <!-- COSTS -->
      <div class="tab-content" id="tab-costs">
        <div class="page-header"><h2>ğŸ§¾ Custos</h2><button class="btn btn-primary" id="btn-add-cost">+ Adicionar Custo</button></div>
        <div class="grid-2 mb-4">
          <div class="stat-card" style="border-left:4px solid var(--primary)"><div class="stat-label">ğŸ”„ Recorrentes / mÃªs</div><div class="stat-value" style="color:var(--primary)" id="cost-recurrent">$0.00</div></div>
          <div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">âš¡ Ãšnicos</div><div class="stat-value" style="color:var(--warning)" id="cost-unique">$0.00</div></div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <button class="btn btn-outline btn-sm" style="border-radius:99px" id="filter-all">Todos</button>
          <button class="btn btn-outline btn-sm" style="border-radius:99px" id="filter-recorrente">Recorrentes</button>
          <button class="btn btn-outline btn-sm" style="border-radius:99px" id="filter-unico">Ãšnicos</button>
        </div>
        <div id="costs-list"></div>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="tab-content" id="tab-notifications">
        <div class="page-header">
          <h2>ğŸ”” NotificaÃ§Ãµes</h2>
          <span class="badge badge-destructive" id="notif-count-badge"></span>
        </div>
        <div id="notifications-list"></div>
      </div>

      <!-- FREQUENCIES -->
      <div class="tab-content" id="tab-frequencies">
        <div class="page-header"><h2>ğŸ“† FrequÃªncias</h2><button class="btn btn-primary" id="btn-add-freq">+ Adicionar</button></div>
        <div class="card"><div class="card-header"><h3>ğŸ“‹ Lista de FrequÃªncias</h3></div><div class="card-body" id="freq-list"></div></div>
      </div>

      <!-- REFERRALS -->
      <div class="tab-content" id="tab-referrals">
        <div class="page-header"><h2>ğŸ IndicaÃ§Ãµes</h2></div>
        <div class="grid-3 mb-4" id="referral-stats"></div>
        <div id="referrals-list"></div>
      </div>

      <!-- PROFILE -->
      <div class="tab-content" id="tab-profile">
        <h2 style="font-size:22px;font-weight:800;margin-bottom:20px">âš™ Perfil</h2>
        <div class="card" style="max-width:480px"><div class="card-body">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
            <div class="profile-avatar" id="profile-avatar">A</div>
            <div><div style="font-size:18px;font-weight:700" id="profile-name">Admin</div><div style="font-size:13px;color:var(--text-muted)" id="profile-email-disp"></div><span class="badge badge-primary" style="margin-top:4px">Administrador</span></div>
          </div>
          <hr class="divider">
          <div class="form-group"><label>Nova Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
          <div class="form-group"><label>Confirmar Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
          <button class="btn btn-primary" id="btn-save-profile">Salvar AlteraÃ§Ãµes</button>
        </div></div>
      </div>
    </main>
  </div>
</div>

<!-- â•â• EMPLOYEE APP â•â• -->
<div id="emp-app-page" class="hidden">
  <header class="app-header">
    <div class="header-logo"><span class="spark">âœ¦</span><div><h2>WR Cleaning</h2><span id="emp-header-sub">Colaboradora</span></div></div>
    <div class="header-right">
      <div class="user-info"><div class="name" id="emp-header-username"></div><div class="email" id="emp-header-email"></div></div>
      <button class="btn btn-outline btn-sm" id="btn-logout-emp">â¬¡ Sair</button>
    </div>
  </header>
  <div style="background:var(--card);border-bottom:1px solid var(--border);overflow-x:auto">
    <div style="display:flex;min-width:max-content;padding:0 16px">
      <button class="emp-tab-btn active" data-etab="emp-ganhos">ğŸ’° Ganhos</button>
      <button class="emp-tab-btn" data-etab="emp-agenda">ğŸ“… Agenda</button>
      <button class="emp-tab-btn" data-etab="emp-clientes">ğŸ‘¥ Clientes</button>
      <button class="emp-tab-btn" data-etab="emp-indique">ğŸ Indique</button>
      <button class="emp-tab-btn" data-etab="emp-perfil">âš™ï¸ Perfil</button>
    </div>
  </div>
  <main class="main-content">
    <!-- GANHOS -->
    <div class="tab-content active" id="tab-emp-ganhos">
      <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">ğŸ’° Meus Ganhos</h2>
      <div class="card mb-4"><div class="card-body" style="padding:12px 16px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-outline btn-sm" style="border-radius:99px" data-period="semana">Esta semana</button>
          <button class="btn btn-primary btn-sm" style="border-radius:99px" data-period="mes">Este mÃªs</button>
          <button class="btn btn-outline btn-sm" style="border-radius:99px" data-period="ano">Este ano</button>
        </div>
      </div></div>
      <div class="grid-3 mb-4" id="emp-stats"></div>
      <div class="card"><div class="card-header"><h3>HistÃ³rico de Trabalhos</h3></div><div class="card-body" id="emp-work-list"></div></div>
    </div>
    <!-- AGENDA -->
    <div class="tab-content" id="tab-emp-agenda">
      <div class="page-header">
        <h2>ğŸ“… Minha Agenda</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-outline btn-sm" id="emp-prev-week">â—€</button>
          <span id="emp-week-label" style="font-size:13px;font-weight:600"></span>
          <button class="btn btn-outline btn-sm" id="emp-next-week">â–¶</button>
        </div>
      </div>
      <div class="week-grid" id="emp-week-grid"></div>
      <div class="card mt-4"><div class="card-header"><h3>Agendamentos da Semana</h3></div><div class="card-body" id="emp-schedule-list"></div></div>
    </div>
    <!-- CLIENTES -->
    <div class="tab-content" id="tab-emp-clientes">
      <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">ğŸ‘¥ Meus Clientes</h2>
      <div id="emp-clients-list"></div>
      <div class="card mt-4">
        <div class="card-header"><h3>ğŸ’¬ Minhas ObservaÃ§Ãµes</h3><button class="btn btn-primary btn-sm" id="btn-emp-note">+ Nova ObservaÃ§Ã£o</button></div>
        <div class="card-body" id="emp-notes-list"></div>
      </div>
    </div>
    <!-- INDIQUE -->
    <div class="tab-content" id="tab-emp-indique">
      <div class="page-header"><h2>ğŸ IndicaÃ§Ãµes</h2><button class="btn btn-primary" id="btn-emp-ref">+ Nova IndicaÃ§Ã£o</button></div>
      <div class="card mb-4" style="border-left:4px solid var(--secondary);background:var(--secondary-light)">
        <div class="card-body"><div style="font-weight:700;color:var(--secondary);margin-bottom:4px">ğŸ Como funciona?</div><div style="font-size:13px;color:#065f46">Indique um amigo e receba bÃ´nus quando aprovado!</div></div>
      </div>
      <div class="grid-3 mb-4" id="emp-referrals-stats"></div>
      <div id="emp-referrals-list"></div>
    </div>
    <!-- PERFIL -->
    <div class="tab-content" id="tab-emp-perfil">
      <h2 style="font-size:20px;font-weight:800;margin-bottom:16px">âš™ï¸ Meu Perfil</h2>
      <div class="card" style="max-width:480px"><div class="card-body">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
          <div class="profile-avatar" id="emp-profile-avatar">A</div>
          <div><div style="font-size:18px;font-weight:700" id="emp-profile-name">Colaboradora</div><div style="font-size:13px;color:var(--text-muted)" id="emp-profile-email"></div><span class="badge badge-gray" style="margin-top:4px">Colaborador</span></div>
        </div>
        <hr class="divider">
        <div class="form-group"><label>Nova Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
        <div class="form-group"><label>Confirmar Senha</label><input type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
        <button class="btn btn-primary btn-sm" id="btn-save-emp-profile">Salvar Senha</button>
      </div></div>
    </div>
  </main>
</div>

<!-- â•â• MODALS â•â• -->
<div class="modal-overlay hidden" id="schedule-modal">
  <div class="modal modal-lg"><h2>ğŸ“… Novo Agendamento</h2>
    <div class="form-group"><label>Data</label><input type="date" class="form-control" id="sch-date"/></div>
    <div class="form-group"><label>Cliente</label><select class="form-control" id="sch-client"><option value="">Selecione...</option></select></div>
    <div class="form-group"><label>FuncionÃ¡ria</label><select class="form-control" id="sch-emp"><option value="">Selecione...</option></select></div>
    <div class="form-group"><label>Status</label><select class="form-control" id="sch-status"><option value="pendente">Pendente</option><option value="confirmado">Confirmado</option><option value="cancelado">Cancelado</option></select></div>
    <div class="form-group"><label>ObservaÃ§Ãµes</label><textarea class="form-control" id="sch-notes" placeholder="Opcional..."></textarea></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-schedule">Salvar</button><button class="btn btn-outline" id="btn-cancel-schedule">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="checklist-modal">
  <div class="modal modal-lg">
    <h2 id="checklist-modal-title">ğŸ’µ Novo Registro de Trabalho</h2>
    <input type="hidden" id="cl-edit-id"/>
    <div class="form-group"><label>Cliente</label><select class="form-control" id="cl-client"><option value="">Selecione...</option></select></div>
    <div class="form-group"><label>Data</label><input type="date" class="form-control" id="cl-date"/></div>
    <div class="form-group"><label>Status</label>
      <select class="form-control" id="cl-status">
        <option value="Pendente">Pendente</option>
        <option value="Confirmado">Confirmado</option>
        <option value="Cancelado">Cancelado</option>
      </select>
    </div>
    <div class="form-group hidden" id="cl-reason-group"><label>Motivo do Cancelamento</label><textarea class="form-control" id="cl-reason"></textarea></div>
    <div class="form-group"><label>Receita (R$)</label><input type="number" class="form-control" id="cl-revenue" placeholder="0.00" step="0.01"/></div>
    <hr class="divider">
    <div style="margin-bottom:10px;font-weight:600;font-size:14px">FuncionÃ¡rias no Trabalho</div>
    <div id="cl-emp-rows"></div>
    <button class="btn btn-ghost btn-sm" id="btn-add-emp-row">+ Adicionar FuncionÃ¡ria</button>
    <div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" id="btn-save-worklog">Salvar</button><button class="btn btn-outline" id="btn-cancel-worklog">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="client-modal">
  <div class="modal modal-lg">
    <h2 id="client-modal-title">ğŸ‘¥ Adicionar Cliente</h2>
    <input type="hidden" id="client-edit-id"/>
    <div class="form-group"><label>Nome</label><input type="text" class="form-control" id="client-name" placeholder="Nome do cliente"/></div>
    <div class="form-group"><label>FrequÃªncia</label><select class="form-control" id="client-freq"><option value="">Selecione...</option></select></div>
    <div class="form-group"><label>Valor (R$)</label><input type="number" class="form-control" id="client-price" placeholder="0.00" step="0.01"/></div>
    <div class="form-group" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="client-transport" style="width:16px;height:16px"/><label for="client-transport" style="margin:0">Sem custo de transporte</label></div>
    <hr class="divider">
    <div style="font-weight:600;font-size:14px;margin-bottom:10px">FuncionÃ¡rias Designadas</div>
    <div id="client-emp-rows"></div>
    <button class="btn btn-ghost btn-sm" id="btn-add-client-emp">+ Adicionar FuncionÃ¡ria</button>
    <div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" id="btn-save-client">Salvar</button><button class="btn btn-outline" id="btn-cancel-client">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="emp-modal">
  <div class="modal">
    <h2>ğŸ’¼ Adicionar FuncionÃ¡rio</h2>
    <div class="form-group"><label>Nome completo</label><input type="text" class="form-control" id="emp-name" placeholder="Nome completo"/></div>
    <div class="form-group"><label>Email (login)</label><input type="email" class="form-control" id="emp-email" placeholder="email@exemplo.com"/></div>
    <div class="form-group">
      <label>Senha</label>
      <div class="pass-wrapper">
        <input type="password" class="form-control" id="emp-pass" placeholder="MÃ­nimo 6 caracteres"/>
        <button class="pass-toggle" type="button" onclick="toggleFieldPass('emp-pass',this)" aria-label="Mostrar senha">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>
    <div class="form-group"><label>Papel</label>
      <select class="form-control" id="emp-role">
        <option value="colaborador">Colaborador</option>
        <option value="adm">Administrador</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px"><button class="btn btn-primary" id="btn-save-emp">âœ… Criar FuncionÃ¡rio</button><button class="btn btn-outline" id="btn-cancel-emp">Cancelar</button></div>
  </div>
</div>

<!-- â•â• MODAL EDITAR FUNCIONÃRIO â•â• -->
<div class="modal-overlay hidden" id="edit-emp-modal">
  <div class="modal">
    <h2>âœï¸ Editar FuncionÃ¡rio</h2>
    <input type="hidden" id="edit-emp-id"/>
    <div class="form-group"><label>Nome completo</label><input type="text" class="form-control" id="edit-emp-name" placeholder="Nome completo"/></div>
    <div class="form-group"><label>Email (login)</label><input type="email" class="form-control" id="edit-emp-email" placeholder="email@exemplo.com"/></div>
    <div class="form-group">
      <label>Nova Senha <span style="font-size:11px;color:var(--text-muted)">(deixe em branco para manter)</span></label>
      <div class="pass-wrapper">
        <input type="password" class="form-control" id="edit-emp-pass" placeholder="Nova senha (opcional)"/>
        <button class="pass-toggle" type="button" onclick="toggleFieldPass('edit-emp-pass',this)" aria-label="Mostrar senha">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>
    <div class="form-group"><label>Papel</label>
      <select class="form-control" id="edit-emp-role">
        <option value="colaborador">Colaborador</option>
        <option value="adm">Administrador</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px"><button class="btn btn-primary" id="btn-save-edit-emp">ğŸ’¾ Salvar AlteraÃ§Ãµes</button><button class="btn btn-outline" id="btn-cancel-edit-emp">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="cost-modal">
  <div class="modal"><h2>ğŸ§¾ Adicionar Custo</h2>
    <div class="form-group"><label>Categoria</label><select class="form-control" id="cost-cat"><option>Transporte</option><option>Produtos de Limpeza</option><option>ManutenÃ§Ã£o</option><option>Outros</option></select></div>
    <div class="form-group"><label>DescriÃ§Ã£o</label><input type="text" class="form-control" id="cost-desc" placeholder="DescriÃ§Ã£o"/></div>
    <div class="form-group"><label>Valor (R$)</label><input type="number" class="form-control" id="cost-amount" placeholder="0.00" step="0.01"/></div>
    <div class="form-group"><label>Tipo</label><select class="form-control" id="cost-type"><option value="unico">Ãšnico</option><option value="recorrente">Recorrente</option></select></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-cost">Adicionar</button><button class="btn btn-outline" id="btn-cancel-cost">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="freq-modal">
  <div class="modal">
    <h2 id="freq-modal-title">ğŸ“† Adicionar FrequÃªncia</h2>
    <input type="hidden" id="freq-edit-id"/>
    <div class="form-group"><label>Nome</label><input type="text" class="form-control" id="freq-name" placeholder="Ex: Semanal, Quinzenal..."/></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-freq">Salvar</button><button class="btn btn-outline" id="btn-cancel-freq">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="approve-modal">
  <div class="modal"><h2>âœ… Aprovar UsuÃ¡rio</h2>
    <input type="hidden" id="approve-user-id"/>
    <div class="form-group"><label>Nome do FuncionÃ¡rio</label><input type="text" class="form-control" id="approve-name" placeholder="Nome completo"/></div>
    <div class="form-group">
      <label>Senha inicial</label>
      <div class="pass-wrapper">
        <input type="password" class="form-control" id="approve-pass" placeholder="MÃ­nimo 6 caracteres" value="123456"/>
        <button class="pass-toggle" type="button" onclick="toggleFieldPass('approve-pass',this)" aria-label="Mostrar senha">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>
    <div class="form-group"><label>Papel</label>
      <select class="form-control" id="approve-role">
        <option value="colaborador">Colaborador</option>
        <option value="adm">Administrador</option>
      </select>
    </div>
    <div style="display:flex;gap:8px"><button class="btn btn-secondary" id="btn-approve-user">âœ… Aprovar e Criar Login</button><button class="btn btn-outline" id="btn-cancel-approve">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="ref-modal">
  <div class="modal"><h2>ğŸ Aprovar IndicaÃ§Ã£o</h2>
    <input type="hidden" id="ref-edit-id"/>
    <div class="form-group"><label>Valor do BÃ´nus (R$)</label><input type="number" class="form-control" id="ref-bonus" placeholder="0.00" step="0.01"/></div>
    <div style="display:flex;gap:8px"><button class="btn btn-secondary" id="btn-approve-ref">Aprovar com BÃ´nus</button><button class="btn btn-outline" id="btn-cancel-ref">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="emp-note-modal">
  <div class="modal"><h2>ğŸ’¬ Nova ObservaÃ§Ã£o</h2>
    <div class="form-group"><label>Cliente</label><select class="form-control" id="note-client-sel"></select></div>
    <div class="form-group"><label>ObservaÃ§Ã£o</label><textarea class="form-control" id="note-text" rows="4" placeholder="Descreva sua observaÃ§Ã£o..."></textarea></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-note">Enviar</button><button class="btn btn-outline" id="btn-cancel-note">Cancelar</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="emp-ref-modal">
  <div class="modal"><h2>ğŸ Nova IndicaÃ§Ã£o</h2>
    <div class="form-group"><label>Nome do Cliente</label><input type="text" class="form-control" id="eref-name" placeholder="Nome completo"/></div>
    <div class="form-group"><label>Telefone</label><input type="text" class="form-control" id="eref-phone" placeholder="(11) 99999-9999"/></div>
    <div class="form-group"><label>EndereÃ§o</label><input type="text" class="form-control" id="eref-address" placeholder="Rua, nÃºmero, bairro"/></div>
    <div class="form-group"><label>CEP</label><input type="text" class="form-control" id="eref-zip" placeholder="00000-000"/></div>
    <div style="display:flex;gap:8px"><button class="btn btn-primary" id="btn-save-emp-ref">Enviar</button><button class="btn btn-outline" id="btn-cancel-emp-ref">Cancelar</button></div>
  </div>
</div>

<script>

// â•â•â•â•â•â•â•â•â•â•â• SUPABASE CONFIG â•â•â•â•â•â•â•â•â•â•â•
var SUPA_URL = 'https://uolstjzzytcelyoflwpw.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvbHN0anp6eXRjZWx5b2Zsd3B3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzY2MzksImV4cCI6MjA4NzYxMjYzOX0.roprEFZUN5r8Z5c-f_D06SHm0xSoSU0ecCjCiGDtqbU';
var sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â• DATA â•â•â•â•â•â•â•â•â•â•â•â•
const db = {
  employees:[
    {id:'e1',name:'Ana Silva',email:'ana@exemplo.com',created_at:'2025-01-10'},
    {id:'e2',name:'Maria Santos',email:'maria@exemplo.com',created_at:'2025-02-15'},
    {id:'e3',name:'Renata Oliveira',email:'renata@exemplo.com',created_at:'2025-03-20'},
  ],
  frequencies:[{id:'f1',name:'Semanal'},{id:'f2',name:'Quinzenal'},{id:'f3',name:'Mensal'},{id:'f4',name:'A cada 3 semanas'}],
  clients:[
    {id:'c1',name:'FamÃ­lia Johnson',frequency:'Semanal',price:180,no_transport_cost:false,client_employees:[{employee_id:'e1',payment_amount:60},{employee_id:'e2',payment_amount:60}]},
    {id:'c2',name:'EscritÃ³rio Tech Co',frequency:'Quinzenal',price:320,no_transport_cost:true,client_employees:[{employee_id:'e1',payment_amount:90},{employee_id:'e3',payment_amount:80}]},
    {id:'c3',name:'Sra. Williams',frequency:'Mensal',price:150,no_transport_cost:false,client_employees:[{employee_id:'e2',payment_amount:55}]},
    {id:'c4',name:'Apartamento Davis',frequency:'Quinzenal',price:200,no_transport_cost:false,client_employees:[{employee_id:'e3',payment_amount:70}]},
    {id:'c5',name:'Casa Martinez',frequency:'Semanal',price:160,no_transport_cost:false,client_employees:[{employee_id:'e1',payment_amount:50},{employee_id:'e2',payment_amount:50}]},
  ],
  costs:[
    {id:'co1',category:'Transporte',description:'Gasolina mensal',amount:150,cost_type:'recorrente',created_at:'2026-02-01'},
    {id:'co2',category:'Produtos de Limpeza',description:'Fornecedor mensal',amount:220,cost_type:'recorrente',created_at:'2026-02-01'},
    {id:'co3',category:'ManutenÃ§Ã£o',description:'Aspirador de pÃ³ novo',amount:350,cost_type:'unico',created_at:'2026-02-10'},
    {id:'co4',category:'Outros',description:'Uniformes',amount:180,cost_type:'unico',created_at:'2026-02-14'},
  ],
  workLogs:[
    {id:'w1',client_id:'c1',work_date:'2026-02-03',status:'Confirmado',revenue:180,work_log_employees:[{employee_id:'e1',payment_amount:60},{employee_id:'e2',payment_amount:60}]},
    {id:'w2',client_id:'c2',work_date:'2026-02-05',status:'Confirmado',revenue:320,work_log_employees:[{employee_id:'e1',payment_amount:90},{employee_id:'e3',payment_amount:80}]},
    {id:'w3',client_id:'c3',work_date:'2026-02-07',status:'Pendente',revenue:150,work_log_employees:[{employee_id:'e2',payment_amount:55}]},
    {id:'w4',client_id:'c4',work_date:'2026-02-10',status:'Confirmado',revenue:200,work_log_employees:[{employee_id:'e3',payment_amount:70}]},
    {id:'w5',client_id:'c1',work_date:'2026-02-10',status:'Confirmado',revenue:180,work_log_employees:[{employee_id:'e1',payment_amount:60},{employee_id:'e2',payment_amount:60}]},
    {id:'w6',client_id:'c5',work_date:'2026-02-12',status:'Cancelado',revenue:0,cancellation_reason:'Cliente desmarcou',work_log_employees:[]},
    {id:'w7',client_id:'c5',work_date:'2026-02-17',status:'Confirmado',revenue:160,work_log_employees:[{employee_id:'e1',payment_amount:50},{employee_id:'e2',payment_amount:50}]},
    {id:'w8',client_id:'c2',work_date:'2026-02-19',status:'Pendente',revenue:320,work_log_employees:[{employee_id:'e1',payment_amount:90},{employee_id:'e3',payment_amount:80}]},
  ],
  scheduleEntries:[
    {id:'s1',work_date:'2026-02-23',client_id:'c1',employee_ids:['e1','e2'],status:'confirmado',notes:''},
    {id:'s2',work_date:'2026-02-24',client_id:'c2',employee_ids:['e1','e3'],status:'confirmado',notes:''},
    {id:'s3',work_date:'2026-02-25',client_id:'c3',employee_ids:['e2'],status:'pendente',notes:'Ligar antes'},
    {id:'s4',work_date:'2026-02-26',client_id:'c5',employee_ids:['e1','e2'],status:'cancelado',notes:''},
  ],
  notifications:[
    {id:'n1',client_id:'c1',employee_id:'e1',note:'Cliente pediu produto especÃ­fico.',status:'pending',created_at:'2026-02-22T10:30:00'},
    {id:'n2',client_id:'c3',employee_id:'e2',note:'Porta do banheiro com problema.',status:'pending',created_at:'2026-02-23T14:00:00'},
    {id:'n3',client_id:'c2',employee_id:'e3',note:'Chave extra na recepÃ§Ã£o.',status:'read',created_at:'2026-02-20T09:00:00'},
  ],
  referrals:[
    {id:'r1',employee_id:'e1',client_name:'FamÃ­lia Brown',phone:'(11) 99999-1111',address:'Rua das Flores, 123',zip_code:'01234-567',status:'pending',bonus_amount:0,created_at:'2026-02-20'},
    {id:'r2',employee_id:'e2',client_name:'Sr. Anderson',phone:'(11) 88888-2222',address:'Av. Principal, 456',zip_code:'04567-890',status:'approved',bonus_amount:50,created_at:'2026-02-15'},
    {id:'r3',employee_id:'e3',client_name:'EscritÃ³rio XYZ',phone:'(11) 77777-3333',address:'Centro, 789',zip_code:'07890-123',status:'rejected',bonus_amount:0,created_at:'2026-02-10'},
  ],
  pendingUsers:[{id:'pu1',email:'novafunc@exemplo.com',created_at:'2026-02-23T08:00:00'}],
};

const USERS={
  'adm':{role:'adm',email:'adm@wrcleaning.com',username:'Admin',password:'123456'},
  'adm@wrcleaning.com':{role:'adm',email:'adm@wrcleaning.com',username:'Admin',password:'123456'},
  'renatawaldehm@gmail.com':{role:'adm',email:'renatawaldehm@gmail.com',username:'Renata',password:'angelina123@'},
  'belami.viagens@gmail.com':{role:'colaborador',email:'belami.viagens@gmail.com',username:'Ana Silva',employeeId:'e1',password:'123456'},
  'vd273108@gmail.com':{role:'colaborador',email:'vd273108@gmail.com',username:'Maria Santos',employeeId:'e2',password:'123456'},
};

let currentUser=null,currentTab='dashboard',costsFilter='all',weekOffset=0,empWeekOffset=0,currentEmpId=null,empPeriodDates={start:'',end:''};

// â•â•â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•
const fmt=v=>'R$ '+Number(v).toFixed(2);
const fmtDate=s=>{const d=new Date(s+(s.length===10?'T00:00:00':''));return d.toLocaleDateString('pt-BR')};
const uid=()=>'_'+Math.random().toString(36).substr(2,9);
const getClient=id=>db.clients.find(c=>c.id===id);
const getEmployee=id=>db.employees.find(e=>e.id===id);
const $=id=>document.getElementById(id);

function toast(msg,type='success'){
  const c=$('toast-container'),el=document.createElement('div');
  el.className=`toast ${type}`;el.innerHTML=`${type==='success'?'âœ“':'âœ•'} ${msg}`;
  c.appendChild(el);setTimeout(()=>el.remove(),3500);
}
function openModal(id){$(id).classList.remove('hidden')}
function closeModal(id){$(id).classList.add('hidden')}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.add('hidden')}));

// â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•
function toggleView(v){
  $('login-form').classList.add('hidden');
  $('register-form').classList.add('hidden');
  $('forgot-form').classList.add('hidden');
  $(v).classList.remove('hidden');
}

function doLogin(){
  var emailEl=$('login-email'), passEl=$('login-pass');
  var errEmail=$('login-email-err'), errPass=$('login-pass-err');
  [emailEl,passEl].forEach(function(el){if(el)el.classList.remove('is-error');});
  [errEmail,errPass].forEach(function(el){if(el)el.classList.remove('show');});
  var email=(emailEl?emailEl.value:'').trim().toLowerCase();
  var pass=passEl?passEl.value:'';
  var ok=true;
  if(!email||!/\S+@\S+\.\S+/.test(email)){if(emailEl)emailEl.classList.add('is-error');if(errEmail)errEmail.classList.add('show');ok=false;}
  if(!pass){if(passEl)passEl.classList.add('is-error');if(errPass)errPass.classList.add('show');ok=false;}
  if(!ok)return;

  sb.auth.signInWithPassword({email:email,password:pass}).then(function(res){
    if(res.error){
      toast('Erro login: '+res.error.message,'error');
      return;
    }
    var user=res.data.user;
    sb.from('profiles').select('role,display_name').eq('id',user.id).single().then(function(r){
      if(r.error||!r.data){
        toast('Perfil nÃ£o encontrado (erro: '+(r.error?r.error.message:'null')+')','error');
        return;
      }
      var profile=r.data;
      currentUser={role:profile.role,email:user.email,username:profile.display_name,employeeId:user.id};
      $('login-page').classList.add('hidden');
      if(profile.role==='adm'){
        $('app-page').classList.remove('hidden');
        if($('header-username'))$('header-username').textContent=profile.display_name;
        if($('header-email'))$('header-email').textContent=user.email;
        if($('profile-name'))$('profile-name').textContent=profile.display_name;
        if($('profile-email-disp'))$('profile-email-disp').textContent=user.email;
        if($('profile-avatar'))$('profile-avatar').textContent=profile.display_name.charAt(0).toUpperCase();
        initApp();
      } else {
        $('emp-app-page').classList.remove('hidden');
        if($('emp-header-username'))$('emp-header-username').textContent=profile.display_name;
        if($('emp-header-email'))$('emp-header-email').textContent=user.email;
        if($('emp-profile-name'))$('emp-profile-name').textContent=profile.display_name;
        if($('emp-profile-avatar'))$('emp-profile-avatar').textContent=profile.display_name.charAt(0).toUpperCase();
        initEmpApp(user.id);
      }
    });
  });
}


function doLogout(){
  sb.auth.signOut().then(function(){
    currentUser=null;
    $('app-page').classList.add('hidden');
    $('emp-app-page').classList.add('hidden');
    $('login-page').classList.remove('hidden');
  });
}


function navigate(tab){
  document.querySelectorAll('#sidebar .nav-item').forEach(b=>{b.classList.remove('active');b.removeAttribute('aria-current')});
  const nb=document.querySelector(`#sidebar [data-tab="${tab}"]`);
  nb.classList.add('active');nb.setAttribute('aria-current','page');
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  $('tab-'+tab).classList.add('active');
  currentTab=tab;
  updateNotifBadge();
  renderTab(tab);
}

function renderTab(tab){
  ({dashboard:renderDashboard,schedule:renderSchedule,checklist:renderChecklist,clients:renderClients,employees:renderEmployees,costs:renderCosts,notifications:renderNotifications,frequencies:renderFrequencies,referrals:renderReferrals}[tab]||(() => {}))();
}

// â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•
function initApp(){
  populateSelects();updateNotifBadge();renderDashboard();
}

function populateSelects(){
  const clientOpts='<option value="">Selecione...</option>'+db.clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  $('sch-client').innerHTML=clientOpts;
  $('cl-client').innerHTML=clientOpts;
  const empOpts='<option value="">Selecione...</option>'+db.employees.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
  $('sch-emp').innerHTML=empOpts;
  $('client-freq').innerHTML='<option value="">Selecione...</option>'+db.frequencies.map(f=>`<option value="${f.name}">${f.name}</option>`).join('');
  const today=new Date().toISOString().split('T')[0];
  if(!$('sch-date').value)$('sch-date').value=today;
  if(!$('cl-date').value)$('cl-date').value=today;
}

function updateNotifBadge(){
  const p=db.notifications.filter(n=>n.status==='pending').length;
  const badge=$('notif-badge');
  const banner=$('main-notif-banner');
  if(p>0){badge.textContent=p;badge.classList.remove('hidden');if(currentTab!=='notifications'){banner.classList.remove('hidden');$('banner-title').textContent=`${p} Nova${p>1?'s':''} NotificaÃ§${p>1?'Ãµes':'Ã£o'}`}}
  else{badge.classList.add('hidden');banner.classList.add('hidden')}
  const cb=$('notif-count-badge');if(cb)cb.textContent=p?`${p} pendentes`:'';
}

// â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const start=$('dash-start').value,end=$('dash-end').value;
  const filtered=db.workLogs.filter(l=>l.work_date>=start&&l.work_date<=end);
  const confirmed=filtered.filter(l=>l.status==='Confirmado');
  const totalRevenue=confirmed.reduce((s,l)=>s+l.revenue,0);
  const totalPayments=confirmed.reduce((s,l)=>s+(l.work_log_employees||[]).reduce((ps,e)=>ps+e.payment_amount,0),0);
  const startD=new Date(start+'T00:00:00'),endD=new Date(end+'T00:00:00');
  const days=Math.ceil((endD-startD)/86400000)+1;
  const recurrentTotal=db.costs.filter(c=>c.cost_type==='recorrente').reduce((s,c)=>s+c.amount,0);
  const propRecurrent=(recurrentTotal/30)*days;
  const uniqueTotal=db.costs.filter(c=>c.cost_type==='unico'&&c.created_at>=start&&c.created_at<=end).reduce((s,c)=>s+c.amount,0);
  const totalCosts=propRecurrent+uniqueTotal;
  const netProfit=totalRevenue-totalPayments-totalCosts;
  $('dash-stats').innerHTML=`
    <div class="stat-card" style="border-left:4px solid var(--primary)"><div class="stat-label">ğŸ’µ Faturamento Real</div><div class="stat-value" style="color:var(--primary)">${fmt(totalRevenue)}</div></div>
    <div class="stat-card" style="border-left:4px solid var(--destructive)"><div class="stat-label">ğŸ“¤ Pagamentos Equipe</div><div class="stat-value" style="color:var(--destructive)">${fmt(totalPayments)}</div></div>
    <div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">ğŸ§¾ Custos do PerÃ­odo</div><div class="stat-value" style="color:var(--warning)">${fmt(totalCosts)}</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px">Recorrente: ${fmt(propRecurrent)} | Ãšnico: ${fmt(uniqueTotal)}<br><span style="opacity:.7">${days} dias</span></div></div>
    <div class="stat-card" style="border-left:4px solid var(--secondary)"><div class="stat-label">ğŸ“ˆ Lucro LÃ­quido</div><div class="stat-value" style="color:var(--secondary)">${fmt(netProfit)}</div></div>`;
  $('dash-secondary').innerHTML=`
    <div class="stat-card"><div class="stat-label">ğŸ‘¥ Total de Clientes</div><div class="stat-value">${db.clients.length}</div></div>
    <div class="stat-card"><div class="stat-label">âœ… Confirmados</div><div class="stat-value" style="color:var(--secondary)">${confirmed.length}</div></div>
    <div class="stat-card"><div class="stat-label">âŒ Cancelados</div><div class="stat-value" style="color:var(--destructive)">${filtered.filter(l=>l.status==='Cancelado').length}</div></div>`;
  const ranking=db.clients.map(c=>{const lc=(c.client_employees||[]).reduce((s,ce)=>s+ce.payment_amount,0);return{...c,laborCost:lc,profit:c.price-lc}}).sort((a,b)=>b.profit-a.profit);
  $('ranking-body').innerHTML=ranking.map((c,i)=>`<tr><td>${i+1}</td><td><strong>${c.name}</strong></td><td><span class="badge badge-gray">${c.frequency}</span></td><td style="text-align:right">${fmt(c.price)}</td><td style="text-align:right">${fmt(c.laborCost)}</td><td style="text-align:right;font-weight:700;color:var(--secondary)">${fmt(c.profit)}</td></tr>`).join('');
  renderCharts(confirmed);
}

// â•â•â•â•â•â•â•â•â•â•â•â• SCHEDULE â•â•â•â•â•â•â•â•â•â•â•â•
function getWeekStart(d){const dd=new Date(d);dd.setDate(dd.getDate()-dd.getDay());dd.setHours(0,0,0,0);return dd}

function renderSchedule(){
  const base=getWeekStart(new Date());base.setDate(base.getDate()+weekOffset*7);
  const days=[];for(let i=0;i<7;i++){const d=new Date(base);d.setDate(base.getDate()+i);days.push(d)}
  const startStr=days[0].toISOString().split('T')[0],endStr=days[6].toISOString().split('T')[0],todayStr=new Date().toISOString().split('T')[0];
  $('week-label').textContent=`${days[0].toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})} â€“ ${days[6].toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'})}`;
  const dn=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];
  $('week-grid').innerHTML=days.map((d,i)=>{const ds=d.toISOString().split('T')[0];const entries=db.scheduleEntries.filter(e=>e.work_date===ds);return`<div class="day-col ${ds===todayStr?'today':''}"><div class="day-label">${dn[i]}</div><div class="day-num">${d.getDate()}</div>${entries.map(e=>{const cl=getClient(e.client_id);return`<div class="schedule-item ${e.status}"><div style="font-weight:600">${cl?cl.name:'?'}</div><span class="badge ${e.status==='confirmado'?'badge-secondary':e.status==='cancelado'?'badge-destructive':'badge-warning'}" style="font-size:10px">${e.status}</span></div>`}).join('')}</div>`}).join('');
  const weekEntries=db.scheduleEntries.filter(e=>e.work_date>=startStr&&e.work_date<=endStr).sort((a,b)=>a.work_date.localeCompare(b.work_date));
  $('schedule-list').innerHTML=weekEntries.length===0?'<div class="empty"><div class="icon">ğŸ“…</div>Nenhum agendamento esta semana</div>':weekEntries.map(e=>{const cl=getClient(e.client_id);const emps=(e.employee_ids||[]).map(id=>getEmployee(id)?.name||id).join(', ');return`<div class="log-row"><div class="log-info"><div class="log-date">${fmtDate(e.work_date)}</div><div class="log-client">${cl?cl.name:'?'}</div><div class="log-employees">ğŸ‘¤ ${emps||'Nenhuma'}</div>${e.notes?`<div style="font-size:12px;color:var(--text-muted);font-style:italic">"${e.notes}"</div>`:''}</div><div style="display:flex;align-items:center;gap:8px"><span class="badge ${e.status==='confirmado'?'badge-secondary':e.status==='cancelado'?'badge-destructive':'badge-warning'}">${e.status}</span><button class="btn btn-danger btn-icon btn-sm" data-del-schedule="${e.id}">ğŸ—‘</button></div></div>`}).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â• CHECKLIST â•â•â•â•â•â•â•â•â•â•â•â•
function renderChecklist(){
  const start=$('cl-start').value,end=$('cl-end').value;
  const filtered=db.workLogs.filter(l=>l.work_date>=start&&l.work_date<=end).sort((a,b)=>b.work_date.localeCompare(a.work_date));
  const empSummary=db.employees.map(e=>{
    const total=filtered.filter(l=>l.status==='Confirmado').reduce((s,l)=>s+((l.work_log_employees||[]).find(we=>we.employee_id===e.id)?.payment_amount||0),0);
    const count=filtered.filter(l=>l.status==='Confirmado'&&(l.work_log_employees||[]).some(we=>we.employee_id===e.id)).length;
    return{...e,total,count};
  }).filter(e=>e.total>0);
  $('emp-payments-summary').innerHTML=empSummary.length===0?'<p style="color:var(--text-muted);font-size:13px">Nenhum pagamento no perÃ­odo</p>':empSummary.map(e=>`<div class="summary-block"><div><div class="emp-name">${e.name}</div><div class="emp-count">${e.count} trabalho(s)</div></div><div class="emp-total">${fmt(e.total)}</div></div>`).join('');
  const confirmed=filtered.filter(l=>l.status==='Confirmado'),cancelled=filtered.filter(l=>l.status==='Cancelado'),pending=filtered.filter(l=>l.status==='Pendente');
  const totalRev=confirmed.reduce((s,l)=>s+l.revenue,0),totalPay=confirmed.reduce((s,l)=>s+(l.work_log_employees||[]).reduce((ps,e)=>ps+e.payment_amount,0),0);
  $('cl-period-stats').innerHTML=`
    <div class="summary-block"><span>Pendentes</span><span class="badge badge-pending">${pending.length}</span></div>
    <div class="summary-block"><span>Confirmados</span><span class="badge badge-secondary">${confirmed.length}</span></div>
    <div class="summary-block"><span>Cancelados</span><span class="badge badge-destructive">${cancelled.length}</span></div>
    <div class="summary-block"><span>Faturamento</span><strong style="color:var(--secondary)">${fmt(totalRev)}</strong></div>
    <div class="summary-block"><span>Pagamentos</span><strong style="color:var(--destructive)">${fmt(totalPay)}</strong></div>`;
  $('work-logs-list').innerHTML=filtered.length===0?'<div class="empty"><div class="icon">ğŸ“‹</div>Nenhum registro no perÃ­odo</div>':filtered.map(l=>{
    const cl=getClient(l.client_id);
    const emps=(l.work_log_employees||[]).map(we=>`${getEmployee(we.employee_id)?.name||'?'}: ${fmt(we.payment_amount)}`).join(' | ');
    const sb=l.status==='Confirmado'?'badge-secondary':l.status==='Cancelado'?'badge-destructive':'badge-pending';
    return`<div class="log-row"><div class="log-info"><div class="log-date">${fmtDate(l.work_date)}</div><div class="log-client">${cl?.name||'?'}</div>${emps?`<div class="log-employees">${emps}</div>`:''} ${l.cancellation_reason?`<div style="font-size:12px;color:var(--destructive);margin-top:2px">Cancelado: ${l.cancellation_reason}</div>`:''}</div><div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:6px"><span class="badge ${sb}">${l.status}</span>${l.status==='Confirmado'?`<div class="log-revenue">${fmt(l.revenue)}</div>`:''}<div style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" data-edit-log="${l.id}" title="Editar">âœ</button><button class="btn btn-danger btn-icon btn-sm" data-del-log="${l.id}" title="Apagar">ğŸ—‘</button></div></div></div>`;
  }).join('');
}

function openAddWorkLog(){
  $('checklist-modal-title').textContent='ğŸ’µ Novo Registro de Trabalho';
  $('cl-edit-id').value='';$('cl-client').value='';$('cl-date').value=new Date().toISOString().split('T')[0];
  $('cl-status').value='Pendente';$('cl-reason').value='';$('cl-reason-group').classList.add('hidden');
  $('cl-revenue').value='';$('cl-emp-rows').innerHTML='';openModal('checklist-modal');
}

function editWorkLog(id){
  const l=db.workLogs.find(w=>w.id===id);if(!l)return;
  $('checklist-modal-title').textContent='âœ Editar Registro';$('cl-edit-id').value=id;
  $('cl-client').value=l.client_id;$('cl-date').value=l.work_date;$('cl-status').value=l.status;
  $('cl-reason').value=l.cancellation_reason||'';
  $('cl-reason-group').classList.toggle('hidden',l.status!=='Cancelado');
  $('cl-revenue').value=l.revenue||'';
  const c=$('cl-emp-rows');c.innerHTML='';
  (l.work_log_employees||[]).forEach(we=>{
    const div=document.createElement('div');div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
    div.innerHTML=`<select class="form-control emp-row-emp" style="flex:1">${db.employees.map(e=>`<option value="${e.id}"${e.id===we.employee_id?' selected':''}>${e.name}</option>`).join('')}</select><input type="number" class="form-control emp-row-pay" value="${we.payment_amount}" step="0.01" style="width:100px"/><button class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">âœ•</button>`;
    c.appendChild(div);
  });openModal('checklist-modal');
}

function addEmpRow(){
  const c=$('cl-emp-rows');const div=document.createElement('div');div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
  div.innerHTML=`<select class="form-control emp-row-emp" style="flex:1">${db.employees.map(e=>`<option value="${e.id}">${e.name}</option>`).join('')}</select><input type="number" class="form-control emp-row-pay" placeholder="R$" step="0.01" style="width:100px"/><button class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">âœ•</button>`;
  c.appendChild(div);
}

function saveWorkLog(){
  const editId=$('cl-edit-id').value,clientId=$('cl-client').value,date=$('cl-date').value,status=$('cl-status').value,reason=$('cl-reason').value,revenue=parseFloat($('cl-revenue').value)||0;
  if(!clientId||!date){toast('Preencha cliente e data','error');return;}
  const emps=[...document.querySelectorAll('#cl-emp-rows > div')].map(div=>({employee_id:div.querySelector('.emp-row-emp').value,payment_amount:parseFloat(div.querySelector('.emp-row-pay').value)||0}));
  if(editId){const l=db.workLogs.find(w=>w.id===editId);if(l){l.client_id=clientId;l.work_date=date;l.status=status;l.cancellation_reason=reason;l.revenue=status==='Confirmado'?revenue:0;l.work_log_employees=emps;}toast('Registro atualizado!','success');}
  else{db.workLogs.push({id:uid(),client_id:clientId,work_date:date,status,cancellation_reason:reason,revenue:status==='Confirmado'?revenue:0,work_log_employees:emps});toast('Registro adicionado!','success');}
  closeModal('checklist-modal');$('cl-emp-rows').innerHTML='';renderChecklist();renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â• CLIENTS â•â•â•â•â•â•â•â•â•â•â•â•
function renderClients(){
  $('clients-table-body').innerHTML=db.clients.map(c=>{
    const emps=(c.client_employees||[]).map(ce=>`<span class="emp-pill">${getEmployee(ce.employee_id)?.name||'?'} ${fmt(ce.payment_amount)}</span>`).join(' ');
    return`<tr><td><strong>${c.name}</strong></td><td><span class="badge badge-gray">${c.frequency}</span></td><td><strong style="color:var(--secondary)">${fmt(c.price)}</strong></td><td>${emps||'<span style="color:var(--text-muted)">Nenhuma</span>'}</td><td>${c.no_transport_cost?'<span class="badge badge-secondary">Sim</span>':'<span class="badge badge-gray">NÃ£o</span>'}</td><td><div style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" data-edit-client="${c.id}">âœ</button><button class="btn btn-danger btn-icon btn-sm" data-del-client="${c.id}">ğŸ—‘</button></div></td></tr>`;
  }).join('');
}

function addClientEmpRow(empId='',pay=''){
  const c=$('client-emp-rows');const div=document.createElement('div');div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
  div.innerHTML=`<select class="form-control cemp-row-emp" style="flex:1">${db.employees.map(e=>`<option value="${e.id}"${e.id===empId?' selected':''}>${e.name}</option>`).join('')}</select><input type="number" class="form-control cemp-row-pay" value="${pay}" placeholder="R$" step="0.01" style="width:100px"/><button class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">âœ•</button>`;
  c.appendChild(div);
}

function openAddClient(){
  $('client-modal-title').textContent='ğŸ‘¥ Adicionar Cliente';$('client-edit-id').value='';
  $('client-name').value='';$('client-freq').value='';$('client-price').value='';$('client-transport').checked=false;$('client-emp-rows').innerHTML='';openModal('client-modal');
}

function editClient(id){
  const c=db.clients.find(cl=>cl.id===id);if(!c)return;
  $('client-modal-title').textContent='âœ Editar Cliente';$('client-edit-id').value=id;
  $('client-name').value=c.name;$('client-freq').value=c.frequency;$('client-price').value=c.price;$('client-transport').checked=c.no_transport_cost;
  $('client-emp-rows').innerHTML='';(c.client_employees||[]).forEach(ce=>addClientEmpRow(ce.employee_id,ce.payment_amount));openModal('client-modal');
}

function saveClient(){
  const id=$('client-edit-id').value,name=$('client-name').value.trim(),freq=$('client-freq').value,price=parseFloat($('client-price').value)||0,noT=$('client-transport').checked;
  if(!name||!freq){toast('Preencha nome e frequÃªncia','error');return;}
  const emps=[...document.querySelectorAll('#client-emp-rows > div')].map(div=>({employee_id:div.querySelector('.cemp-row-emp').value,payment_amount:parseFloat(div.querySelector('.cemp-row-pay').value)||0}));
  if(id){const c=db.clients.find(cl=>cl.id===id);if(c){c.name=name;c.frequency=freq;c.price=price;c.no_transport_cost=noT;c.client_employees=emps;}toast('Cliente atualizado!','success');}
  else{db.clients.push({id:uid(),name,frequency:freq,price,no_transport_cost:noT,client_employees:emps});toast('Cliente adicionado!','success');}
  closeModal('client-modal');renderClients();populateSelects();
}

// â•â•â•â•â•â•â•â•â•â•â•â• EMPLOYEES â•â•â•â•â•â•â•â•â•â•â•â•
function renderEmployees(){
  $('emp-table-body').innerHTML=db.employees.map(e=>{
    const u=Object.values(USERS).find(u=>u.email===e.email);
    const roleBadge=u?(u.role==='adm'?`<span class="role-badge-adm">Admin</span>`:`<span class="role-badge-col">Colaborador</span>`):`<span class="no-login-badge">Sem login</span>`;
    return`<tr>
      <td><strong>${e.name}</strong></td>
      <td style="font-size:12px">${e.email}</td>
      <td>${roleBadge}</td>
      <td>${fmtDate(e.created_at)}</td>
      <td><div style="display:flex;gap:4px">
        <button class="btn btn-ghost btn-icon btn-sm" data-edit-emp="${e.id}" title="Editar">âœï¸</button>
        <button class="btn btn-danger btn-icon btn-sm" data-del-emp="${e.id}" title="Remover">ğŸ—‘</button>
      </div></td>
    </tr>`;
  }).join('');
  $('pending-list').innerHTML=db.pendingUsers.length===0?'<div class="empty"><div class="icon">âœ…</div>Nenhum usuÃ¡rio pendente</div>':db.pendingUsers.map(u=>`<div class="log-row"><div class="log-info"><div class="log-client">${u.email}</div><div class="log-date">${fmtDate(u.created_at.split('T')[0])}</div></div><div style="display:flex;gap:6px"><button class="btn btn-secondary btn-sm" data-approve-user="${u.id}" data-approve-email="${u.email}">âœ… Aprovar</button><button class="btn btn-danger btn-sm" data-reject-user="${u.id}">âŒ Rejeitar</button></div></div>`).join('');
}

function saveEmployee(){
  const name=$('emp-name').value.trim();
  const email=$('emp-email').value.trim().toLowerCase();
  const pass=$('emp-pass').value;
  const role=$('emp-role').value;
  if(!name||!email){toast('Preencha nome e email','error');return;}
  if(!pass||pass.length<6){toast('Senha precisa ter pelo menos 6 caracteres','error');return;}
  if(USERS[email]){toast('Este email jÃ¡ estÃ¡ cadastrado','error');return;}
  const newId=uid();
  const empRecord={id:newId,name,email,created_at:new Date().toISOString().split('T')[0]};
  db.employees.push(empRecord);
  // Cria login vÃ¡lido no USERS
  USERS[email]={role,email,username:name,password:pass,employeeId:newId};
  closeModal('emp-modal');
  $('emp-name').value='';$('emp-email').value='';$('emp-pass').value='';$('emp-role').value='colaborador';
  toast(`FuncionÃ¡rio "${name}" criado com login!`,'success');
  renderEmployees();populateSelects();
}

function approveUser(){
  const id=$('approve-user-id').value;
  const name=$('approve-name').value.trim();
  const pass=$('approve-pass').value||'123456';
  const role=$('approve-role').value||'colaborador';
  if(!name){toast('Informe o nome','error');return;}
  const u=db.pendingUsers.find(p=>p.id===id);
  if(u){
    const newId=uid();
    db.employees.push({id:newId,name,email:u.email,created_at:new Date().toISOString().split('T')[0]});
    db.pendingUsers=db.pendingUsers.filter(p=>p.id!==id);
    // Cria login vÃ¡lido no USERS
    USERS[u.email]={role,email:u.email,username:name,password:pass,employeeId:newId};
    toast(`"${name}" aprovado(a) com login criado!`,'success');
  }
  closeModal('approve-modal');renderEmployees();
}

// â•â•â•â•â•â•â•â•â•â•â•â• COSTS â•â•â•â•â•â•â•â•â•â•â•â•
function renderCosts(){
  const rec=db.costs.filter(c=>c.cost_type==='recorrente').reduce((s,c)=>s+c.amount,0);
  const uniq=db.costs.filter(c=>c.cost_type==='unico').reduce((s,c)=>s+c.amount,0);
  $('cost-recurrent').textContent=fmt(rec);$('cost-unique').textContent=fmt(uniq);
  const list=costsFilter==='all'?db.costs:db.costs.filter(c=>c.cost_type===costsFilter);
  $('costs-list').innerHTML=list.length===0?'<div class="empty"><div class="icon">ğŸ§¾</div>Nenhum custo encontrado</div>':list.map(c=>`<div class="cost-item"><div><div class="cost-cat">${c.category} â€¢ <span class="badge ${c.cost_type==='recorrente'?'badge-primary':'badge-warning'}">${c.cost_type}</span></div><div class="cost-desc">${c.description}</div></div><div style="display:flex;align-items:center;gap:10px"><div class="cost-amount" style="color:${c.cost_type==='recorrente'?'var(--primary)':'var(--warning)'}">${fmt(c.amount)}</div><button class="btn btn-danger btn-icon btn-sm" data-del-cost="${c.id}">ğŸ—‘</button></div></div>`).join('');
}

function saveCost(){
  const cat=$('cost-cat').value,desc=$('cost-desc').value.trim(),amount=parseFloat($('cost-amount').value)||0,type=$('cost-type').value;
  if(!desc||amount<=0){toast('Preencha todos os campos','error');return;}
  db.costs.push({id:uid(),category:cat,description:desc,amount,cost_type:type,created_at:new Date().toISOString().split('T')[0]});
  closeModal('cost-modal');toast('Custo adicionado!','success');renderCosts();
}

// â•â•â•â•â•â•â•â•â•â•â•â• NOTIFICATIONS â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotifications(){
  const pending=db.notifications.filter(n=>n.status==='pending'),read=db.notifications.filter(n=>n.status==='read');
  const html=n=>{const cl=getClient(n.client_id),emp=getEmployee(n.employee_id),d=new Date(n.created_at);return`<div class="notif-item ${n.status}"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px"><div><div style="font-weight:700">Cliente: ${cl?.name||'?'}</div><div style="font-size:13px;color:var(--primary);margin-top:2px">ğŸ‘¤ ${emp?.name||'?'}</div></div><div style="font-size:11px;color:var(--text-muted)">${d.toLocaleDateString('pt-BR')} ${d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</div></div><div style="background:var(--bg);border-radius:6px;padding:10px;font-size:13px;margin-bottom:10px">"${n.note}"</div><div style="display:flex;gap:6px">${n.status==='pending'?`<button class="btn btn-primary btn-sm" data-notif-read="${n.id}">âœ“ Marcar como lida</button>`:''}<button class="btn btn-danger btn-sm" data-notif-del="${n.id}">ğŸ—‘ Excluir</button></div></div>`};
  $('notifications-list').innerHTML=(pending.length?`<h3 style="font-size:16px;font-weight:700;color:var(--destructive);margin-bottom:10px">Pendentes</h3>`+pending.map(html).join(''):'')+(read.length?`<hr class="divider"><h3 style="font-size:16px;font-weight:700;color:var(--text-muted);margin-bottom:10px">Lidas</h3>`+read.map(html).join(''):'')||'<div class="empty"><div class="icon">ğŸ””</div>Nenhuma notificaÃ§Ã£o</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â• FREQUENCIES â•â•â•â•â•â•â•â•â•â•â•â•
function renderFrequencies(){
  $('freq-list').innerHTML=db.frequencies.length===0?'<div class="empty"><div class="icon">ğŸ“†</div>Nenhuma frequÃªncia</div>':db.frequencies.map(f=>`<div class="freq-item"><span style="font-weight:600">${f.name}</span><div style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" data-edit-freq="${f.id}">âœ</button><button class="btn btn-danger btn-icon btn-sm" data-del-freq="${f.id}">ğŸ—‘</button></div></div>`).join('');
}

function saveFreq(){
  const id=$('freq-edit-id').value,name=$('freq-name').value.trim();
  if(!name){toast('Digite o nome','error');return;}
  if(id){const f=db.frequencies.find(f=>f.id===id);if(f)f.name=name;toast('FrequÃªncia atualizada!','success');}
  else{db.frequencies.push({id:uid(),name});toast('FrequÃªncia adicionada!','success');}
  closeModal('freq-modal');$('freq-edit-id').value='';$('freq-name').value='';renderFrequencies();populateSelects();
}

// â•â•â•â•â•â•â•â•â•â•â•â• REFERRALS â•â•â•â•â•â•â•â•â•â•â•â•
function renderReferrals(){
  const pending=db.referrals.filter(r=>r.status==='pending'),approved=db.referrals.filter(r=>r.status==='approved'),rejected=db.referrals.filter(r=>r.status==='rejected');
  $('referral-stats').innerHTML=`
    <div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">â³ Pendentes</div><div class="stat-value">${pending.length}</div></div>
    <div class="stat-card" style="border-left:4px solid var(--secondary)"><div class="stat-label">âœ… Aprovadas</div><div class="stat-value" style="color:var(--secondary)">${approved.length}</div></div>
    <div class="stat-card" style="border-left:4px solid var(--destructive)"><div class="stat-label">âŒ Rejeitadas</div><div class="stat-value" style="color:var(--destructive)">${rejected.length}</div></div>`;
  const refHtml=r=>{const emp=getEmployee(r.employee_id);return`<div class="referral-item ${r.status}" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px"><div><div style="font-weight:700;font-size:15px">${r.client_name}</div><div style="font-size:12px;color:var(--text-muted)">ğŸ‘¤ ${emp?.name||'?'}</div></div><div style="display:flex;align-items:center;gap:6px"><span class="badge ${r.status==='pending'?'badge-warning':r.status==='approved'?'badge-secondary':'badge-destructive'}">${r.status==='pending'?'Pendente':r.status==='approved'?'Aprovado':'Rejeitado'}</span><button class="btn btn-danger btn-icon btn-sm" data-del-ref="${r.id}">ğŸ—‘</button></div></div><div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">ğŸ“ ${r.phone} | ğŸ“ ${r.address} | ğŸ“® ${r.zip_code}</div>${r.bonus_amount>0?`<div style="font-size:13px;font-weight:600;color:var(--secondary);margin-bottom:8px">ğŸ BÃ´nus: ${fmt(r.bonus_amount)}</div>`:''}<div style="display:flex;gap:6px;flex-wrap:wrap">${r.status==='pending'?`<button class="btn btn-secondary btn-sm" data-approve-ref="${r.id}">âœ… Aprovar</button><button class="btn btn-danger btn-sm" data-reject-ref="${r.id}">âŒ Rejeitar</button>`:''}${r.status==='approved'?`<button class="btn btn-outline btn-sm" data-pending-ref="${r.id}">â†© Pendente</button><button class="btn btn-danger btn-sm" data-reject-ref="${r.id}">âŒ Rejeitar</button>`:''}${r.status==='rejected'?`<button class="btn btn-outline btn-sm" data-pending-ref="${r.id}">â†© Pendente</button><button class="btn btn-secondary btn-sm" data-approve-ref="${r.id}">âœ… Aprovar</button>`:''}</div></div>`};
  $('referrals-list').innerHTML=(pending.length?`<h3 style="font-weight:700;margin-bottom:10px;color:var(--warning)">Pendentes</h3>`+pending.map(refHtml).join(''):'')+(approved.length?`<h3 style="font-weight:700;margin:16px 0 10px;color:var(--secondary)">Aprovadas</h3>`+approved.map(refHtml).join(''):'')+(rejected.length?`<h3 style="font-weight:700;margin:16px 0 10px;color:var(--destructive)">Rejeitadas</h3>`+rejected.map(refHtml).join(''):'')||'<div class="empty"><div class="icon">ğŸ</div>Nenhuma indicaÃ§Ã£o</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â• EMPLOYEE APP â•â•â•â•â•â•â•â•â•â•â•â•
function initEmpApp(empId){
  currentEmpId=empId;
  const myClients=db.clients.filter(c=>(c.client_employees||[]).some(ce=>ce.employee_id===empId));
  $('note-client-sel').innerHTML=myClients.length
    ?myClients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')
    :'<option value="">Nenhum cliente</option>';
  setEmpPeriod('mes',null); // chama renderEmpGanhos internamente
  renderEmpAgenda();renderEmpClients();renderEmpReferrals();
  const empObj=db.employees.find(e=>e.id===empId);
  if(empObj)$('emp-header-sub').textContent=empObj.name;
}

function empNavigate(tab){
  document.querySelectorAll('.emp-tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.emp-tab-btn[data-etab="${tab}"]`).classList.add('active');
  document.querySelectorAll('#emp-app-page .tab-content').forEach(t=>t.classList.remove('active'));
  $('tab-'+tab).classList.add('active');
  const renders={'emp-ganhos':renderEmpGanhos,'emp-agenda':renderEmpAgenda,'emp-clientes':renderEmpClients,'emp-indique':renderEmpReferrals};
  if(renders[tab])renders[tab]();
}

function setEmpPeriod(period,btn){
  const now=new Date();
  if(btn){document.querySelectorAll('#tab-emp-ganhos .btn').forEach(b=>{b.className=b.className.replace('btn-primary','btn-outline')});btn.className=btn.className.replace('btn-outline','btn-primary')}
  if(period==='semana'){const ws=new Date(now);ws.setDate(now.getDate()-now.getDay());const we=new Date(ws);we.setDate(ws.getDate()+6);empPeriodDates={start:ws.toISOString().split('T')[0],end:we.toISOString().split('T')[0]};}
  else if(period==='mes'){empPeriodDates={start:new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0],end:new Date(now.getFullYear(),now.getMonth()+1,0).toISOString().split('T')[0]};}
  else{empPeriodDates={start:new Date(now.getFullYear(),0,1).toISOString().split('T')[0],end:new Date(now.getFullYear(),11,31).toISOString().split('T')[0]};}
  renderEmpGanhos();
}

function renderEmpGanhos(){
  const{start,end}=empPeriodDates,empId=currentEmpId;
  const myLogs=db.workLogs.filter(l=>l.work_date>=start&&l.work_date<=end&&l.status==='Confirmado'&&(l.work_log_employees||[]).some(we=>we.employee_id===empId));
  const myEarnings=myLogs.reduce((s,l)=>s+((l.work_log_employees||[]).find(we=>we.employee_id===empId)?.payment_amount||0),0);
  const myBonuses=db.referrals.filter(r=>r.employee_id===empId&&r.status==='approved').reduce((s,r)=>s+r.bonus_amount,0);
  $('emp-stats').innerHTML=`<div class="stat-card" style="border-left:4px solid var(--primary)"><div class="stat-label">ğŸ’µ Meus Ganhos</div><div class="stat-value" style="color:var(--primary)">${fmt(myEarnings)}</div></div><div class="stat-card" style="border-left:4px solid var(--secondary)"><div class="stat-label">ğŸ BÃ´nus de IndicaÃ§Ãµes</div><div class="stat-value" style="color:var(--secondary)">${fmt(myBonuses)}</div></div><div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">ğŸ“… Trabalhos</div><div class="stat-value" style="color:var(--warning)">${myLogs.length}</div></div>`;
  $('emp-work-list').innerHTML=myLogs.length===0?'<div class="empty"><div class="icon">ğŸ’µ</div>Nenhum trabalho no perÃ­odo</div>':myLogs.sort((a,b)=>b.work_date.localeCompare(a.work_date)).map(l=>{const cl=getClient(l.client_id),we=(l.work_log_employees||[]).find(we=>we.employee_id===empId);return`<div class="log-row"><div class="log-info"><div class="log-date">${fmtDate(l.work_date)}</div><div class="log-client">${cl?.name||'?'}</div><div class="log-employees">${cl?.frequency||''}</div></div><div class="log-revenue">${fmt(we?.payment_amount||0)}</div></div>`}).join('');
}

function renderEmpAgenda(){
  const base=getWeekStart(new Date());base.setDate(base.getDate()+empWeekOffset*7);
  const days=[];for(let i=0;i<7;i++){const d=new Date(base);d.setDate(base.getDate()+i);days.push(d)}
  const startStr=days[0].toISOString().split('T')[0],endStr=days[6].toISOString().split('T')[0],todayStr=new Date().toISOString().split('T')[0],dn=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];
  $('emp-week-label').textContent=`${days[0].toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})} â€“ ${days[6].toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'})}`;
  const myEntries=db.scheduleEntries.filter(e=>(e.employee_ids||[]).includes(currentEmpId)&&e.work_date>=startStr&&e.work_date<=endStr);
  $('emp-week-grid').innerHTML=days.map((d,i)=>{const ds=d.toISOString().split('T')[0];const de=myEntries.filter(e=>e.work_date===ds);return`<div class="day-col ${ds===todayStr?'today':''}"><div class="day-label">${dn[i]}</div><div class="day-num">${d.getDate()}</div>${de.map(e=>{const cl=getClient(e.client_id);return`<div class="schedule-item ${e.status}"><div style="font-weight:600">${cl?.name||'?'}</div><span class="badge ${e.status==='confirmado'?'badge-secondary':e.status==='cancelado'?'badge-destructive':'badge-warning'}" style="font-size:10px">${e.status}</span></div>`}).join('')}</div>`}).join('');
  $('emp-schedule-list').innerHTML=myEntries.length===0?'<div class="empty"><div class="icon">ğŸ“…</div>Nenhum agendamento esta semana para vocÃª</div>':myEntries.sort((a,b)=>a.work_date.localeCompare(b.work_date)).map(e=>{const cl=getClient(e.client_id);return`<div class="log-row"><div class="log-info"><div class="log-date">${fmtDate(e.work_date)}</div><div class="log-client">${cl?.name||'?'}</div>${e.notes?`<div style="font-size:12px;color:var(--text-muted);font-style:italic">"${e.notes}"</div>`:''}</div><span class="badge ${e.status==='confirmado'?'badge-secondary':e.status==='cancelado'?'badge-destructive':'badge-warning'}">${e.status}</span></div>`}).join('');
}

function renderEmpClients(){
  const empId=currentEmpId,myClients=db.clients.filter(c=>(c.client_employees||[]).some(ce=>ce.employee_id===empId));
  $('emp-clients-list').innerHTML=myClients.length===0?'<div class="empty"><div class="icon">ğŸ‘¥</div>Nenhum cliente designado</div>':myClients.map(c=>{const ce=(c.client_employees||[]).find(ce=>ce.employee_id===empId);return`<div class="log-row" style="margin-bottom:8px"><div class="log-info"><div class="log-client">${c.name}</div><div class="log-employees">${c.frequency}</div></div><div style="text-align:right"><div style="font-size:12px;color:var(--text-muted)">Meu pagamento</div><div style="font-weight:700;color:var(--primary)">${fmt(ce?.payment_amount||0)}</div></div></div>`}).join('');
  const myNotes=db.notifications.filter(n=>n.employee_id===empId);
  $('emp-notes-list').innerHTML=myNotes.length===0?'<p style="color:var(--text-muted);font-size:13px;padding:8px 0">Nenhuma observaÃ§Ã£o enviada ainda</p>':myNotes.map(n=>{const cl=getClient(n.client_id);return`<div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px"><strong>${cl?.name||'?'}</strong><span class="badge ${n.status==='pending'?'badge-warning':'badge-secondary'}">${n.status==='pending'?'Pendente':'Lida'}</span></div><div style="font-size:13px;color:var(--text-muted)">"${n.note}"</div></div>`}).join('');
}

function renderEmpReferrals(){
  const empId=currentEmpId,myRefs=db.referrals.filter(r=>r.employee_id===empId);
  const ap=myRefs.filter(r=>r.status==='approved'),tb=ap.reduce((s,r)=>s+r.bonus_amount,0);
  $('emp-referrals-stats').innerHTML=`<div class="stat-card" style="border-left:4px solid var(--warning)"><div class="stat-label">â³ Pendentes</div><div class="stat-value">${myRefs.filter(r=>r.status==='pending').length}</div></div><div class="stat-card" style="border-left:4px solid var(--secondary)"><div class="stat-label">âœ… Aprovadas</div><div class="stat-value" style="color:var(--secondary)">${ap.length}</div></div><div class="stat-card" style="border-left:4px solid var(--primary)"><div class="stat-label">ğŸ Total BÃ´nus</div><div class="stat-value" style="color:var(--primary)">${fmt(tb)}</div></div>`;
  $('emp-referrals-list').innerHTML=myRefs.length===0?'<div class="empty"><div class="icon">ğŸ</div>Nenhuma indicaÃ§Ã£o ainda</div>':myRefs.map(r=>`<div class="referral-item ${r.status}" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:start"><div><div style="font-weight:700">${r.client_name}</div><div style="font-size:12px;color:var(--text-muted)">ğŸ“ ${r.phone} | ğŸ“ ${r.address}</div></div><span class="badge ${r.status==='pending'?'badge-warning':r.status==='approved'?'badge-secondary':'badge-destructive'}">${r.status==='pending'?'Pendente':r.status==='approved'?'Aprovado':'Rejeitado'}</span></div>${r.bonus_amount>0?`<div style="margin-top:8px;font-weight:700;color:var(--secondary)">ğŸ BÃ´nus: ${fmt(r.bonus_amount)}</div>`:''}</div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â• EVENT LISTENERS â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  // Restaurar sessÃ£o existente
  sb.auth.getSession().then(function(res){
    var session=res.data&&res.data.session;
    if(!session)return;
    var user=session.user;
    sb.from('profiles').select('role,display_name').eq('id',user.id).single().then(function(r){
      if(r.error||!r.data)return;
      var profile=r.data;
      currentUser={role:profile.role,email:user.email,username:profile.display_name,employeeId:user.id};
      $('login-page').classList.add('hidden');
      if(profile.role==='adm'){
        $('app-page').classList.remove('hidden');
        if($('header-username'))$('header-username').textContent=profile.display_name;
        if($('header-email'))$('header-email').textContent=user.email;
        if($('profile-name'))$('profile-name').textContent=profile.display_name;
        if($('profile-avatar'))$('profile-avatar').textContent=profile.display_name.charAt(0).toUpperCase();
        initApp();
      } else {
        $('emp-app-page').classList.remove('hidden');
        if($('emp-header-username'))$('emp-header-username').textContent=profile.display_name;
        if($('emp-header-email'))$('emp-header-email').textContent=user.email;
        initEmpApp(user.id);
      }
    });
  });

  // Login
  $('btn-login').addEventListener('click',doLogin);
  $('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
  $('btn-to-forgot').addEventListener('click',()=>toggleView('forgot-form'));
  $('btn-to-register').addEventListener('click',()=>toggleView('register-form'));
  $('btn-reg-back').addEventListener('click',()=>toggleView('login-form'));
  $('btn-forgot-back').addEventListener('click',()=>toggleView('login-form'));
  $('btn-send-otp').addEventListener('click',()=>toast('CÃ³digo enviado!','success'));
  $('btn-send-forgot').addEventListener('click',()=>toast('CÃ³digo enviado!','success'));
  $('btn-logout-adm').addEventListener('click',doLogout);
  $('btn-logout-emp').addEventListener('click',doLogout);

  // Sidebar
  $('menu-toggle').addEventListener('click',()=>{$('sidebar').classList.toggle('open');$('sidebar-overlay').classList.toggle('open')});
  $('sidebar-overlay').addEventListener('click',()=>{$('sidebar').classList.remove('open');$('sidebar-overlay').classList.remove('open')});

  // ADM nav
  document.querySelectorAll('#sidebar .nav-item').forEach(btn=>{
    btn.addEventListener('click',()=>{navigate(btn.dataset.tab);$('sidebar').classList.remove('open');$('sidebar-overlay').classList.remove('open')});
  });

  // Banner
  $('btn-banner-ver').addEventListener('click',()=>navigate('notifications'));

  // Dashboard filters
  $('dash-month').addEventListener('change',()=>{const[y,m]=$('dash-month').value.split('-');$('dash-start').value=new Date(+y,+m-1,1).toISOString().split('T')[0];$('dash-end').value=new Date(+y,+m,0).toISOString().split('T')[0];renderDashboard()});
  $('dash-start').addEventListener('change',renderDashboard);
  $('dash-end').addEventListener('change',renderDashboard);

  // Schedule
  $('prev-week').addEventListener('click',()=>{weekOffset--;renderSchedule()});
  $('next-week').addEventListener('click',()=>{weekOffset++;renderSchedule()});
  $('btn-add-schedule').addEventListener('click',()=>openModal('schedule-modal'));
  $('btn-save-schedule').addEventListener('click',()=>{
    const date=$('sch-date').value,clientId=$('sch-client').value,empId=$('sch-emp').value,status=$('sch-status').value,notes=$('sch-notes').value;
    if(!date||!clientId){toast('Preencha data e cliente','error');return;}
    db.scheduleEntries.push({id:uid(),work_date:date,client_id:clientId,employee_ids:empId?[empId]:[],status,notes});
    closeModal('schedule-modal');toast('Agendamento criado!','success');renderSchedule();
  });
  $('btn-cancel-schedule').addEventListener('click',()=>closeModal('schedule-modal'));

  // Checklist
  $('btn-add-worklog').addEventListener('click',openAddWorkLog);
  $('btn-save-worklog').addEventListener('click',saveWorkLog);
  $('btn-cancel-worklog').addEventListener('click',()=>closeModal('checklist-modal'));
  $('btn-add-emp-row').addEventListener('click',addEmpRow);
  $('cl-status').addEventListener('change',function(){$('cl-reason-group').classList.toggle('hidden',this.value!=='Cancelado')});
  $('cl-month').addEventListener('change',()=>{const[y,m]=$('cl-month').value.split('-');$('cl-start').value=new Date(+y,+m-1,1).toISOString().split('T')[0];$('cl-end').value=new Date(+y,+m,0).toISOString().split('T')[0];renderChecklist()});
  $('cl-start').addEventListener('change',renderChecklist);
  $('cl-end').addEventListener('change',renderChecklist);

  // Clients
  $('btn-add-client').addEventListener('click',openAddClient);
  $('btn-save-client').addEventListener('click',saveClient);
  $('btn-cancel-client').addEventListener('click',()=>closeModal('client-modal'));
  $('btn-add-client-emp').addEventListener('click',()=>addClientEmpRow());

  // Employees
  $('btn-add-emp').addEventListener('click',()=>openModal('emp-modal'));
  $('btn-save-emp').addEventListener('click',saveEmployee);
  $('btn-cancel-emp').addEventListener('click',()=>closeModal('emp-modal'));
  $('btn-save-edit-emp').addEventListener('click',saveEditEmployee);
  $('btn-cancel-edit-emp').addEventListener('click',()=>closeModal('edit-emp-modal'));
  $('emp-tab-active').addEventListener('click',()=>{$('emp-tab-active').classList.add('active');$('emp-tab-pending').classList.remove('active');$('active-emps').classList.remove('hidden');$('pending-users').classList.add('hidden')});
  $('emp-tab-pending').addEventListener('click',()=>{$('emp-tab-pending').classList.add('active');$('emp-tab-active').classList.remove('active');$('pending-users').classList.remove('hidden');$('active-emps').classList.add('hidden')});
  $('btn-approve-user').addEventListener('click',approveUser);
  $('btn-cancel-approve').addEventListener('click',()=>closeModal('approve-modal'));

  // Costs
  $('btn-add-cost').addEventListener('click',()=>openModal('cost-modal'));
  $('btn-save-cost').addEventListener('click',saveCost);
  $('btn-cancel-cost').addEventListener('click',()=>closeModal('cost-modal'));
  $('filter-all').addEventListener('click',()=>{costsFilter='all';renderCosts()});
  $('filter-recorrente').addEventListener('click',()=>{costsFilter='recorrente';renderCosts()});
  $('filter-unico').addEventListener('click',()=>{costsFilter='unico';renderCosts()});

  // Frequencies
  $('btn-add-freq').addEventListener('click',()=>{$('freq-modal-title').textContent='ğŸ“† Adicionar FrequÃªncia';$('freq-edit-id').value='';$('freq-name').value='';openModal('freq-modal')});
  $('btn-save-freq').addEventListener('click',saveFreq);
  $('btn-cancel-freq').addEventListener('click',()=>closeModal('freq-modal'));

  // Referrals
  $('btn-approve-ref').addEventListener('click',()=>{
    const id=$('ref-edit-id').value,bonus=parseFloat($('ref-bonus').value)||0;
    if(bonus<=0){toast('Informe um valor de bÃ´nus vÃ¡lido','error');return;}
    const r=db.referrals.find(r=>r.id===id);if(r){r.status='approved';r.bonus_amount=bonus;}
    closeModal('ref-modal');toast('IndicaÃ§Ã£o aprovada!','success');renderReferrals();
  });
  $('btn-cancel-ref').addEventListener('click',()=>closeModal('ref-modal'));

  // Profile
  $('btn-save-profile').addEventListener('click',()=>toast('Perfil atualizado!','success'));

  // Employee app
  document.querySelectorAll('.emp-tab-btn').forEach(btn=>btn.addEventListener('click',()=>empNavigate(btn.dataset.etab)));
  document.querySelectorAll('[data-period]').forEach(btn=>btn.addEventListener('click',()=>setEmpPeriod(btn.dataset.period,btn)));
  $('emp-prev-week').addEventListener('click',()=>{empWeekOffset--;renderEmpAgenda()});
  $('emp-next-week').addEventListener('click',()=>{empWeekOffset++;renderEmpAgenda()});
  $('btn-emp-note').addEventListener('click',()=>openModal('emp-note-modal'));
  $('btn-save-note').addEventListener('click',()=>{
    const clientId=$('note-client-sel').value,note=$('note-text').value.trim();
    if(!note){toast('Escreva sua observaÃ§Ã£o','error');return;}
    db.notifications.push({id:uid(),client_id:clientId,employee_id:currentEmpId,note,status:'pending',created_at:new Date().toISOString()});
    $('note-text').value='';closeModal('emp-note-modal');toast('ObservaÃ§Ã£o enviada!','success');renderEmpClients();
  });
  $('btn-cancel-note').addEventListener('click',()=>closeModal('emp-note-modal'));
  $('btn-emp-ref').addEventListener('click',()=>openModal('emp-ref-modal'));
  $('btn-save-emp-ref').addEventListener('click',()=>{
    const name=$('eref-name').value.trim(),phone=$('eref-phone').value.trim(),address=$('eref-address').value.trim(),zip=$('eref-zip').value.trim();
    if(!name||!phone||!address||!zip){toast('Preencha todos os campos','error');return;}
    db.referrals.push({id:uid(),employee_id:currentEmpId,client_name:name,phone,address,zip_code:zip,status:'pending',bonus_amount:0,created_at:new Date().toISOString().split('T')[0]});
    $('eref-name').value='';$('eref-phone').value='';$('eref-address').value='';$('eref-zip').value='';
    closeModal('emp-ref-modal');toast('IndicaÃ§Ã£o enviada!','success');renderEmpReferrals();
  });
  $('btn-cancel-emp-ref').addEventListener('click',()=>closeModal('emp-ref-modal'));
  $('btn-save-emp-profile').addEventListener('click',()=>toast('Senha atualizada!','success'));

  // Delegated clicks (dynamic content)
  document.addEventListener('click',e=>{
    // Schedule delete
    const ds=e.target.dataset.delSchedule;
    if(ds){if(!confirm('Remover agendamento?'))return;db.scheduleEntries=db.scheduleEntries.filter(s=>s.id!==ds);toast('Agendamento removido','success');renderSchedule();return;}
    // Work log edit/delete
    const el=e.target.dataset.editLog;if(el){editWorkLog(el);return;}
    const dl=e.target.dataset.delLog;if(dl){if(!confirm('Remover registro?'))return;db.workLogs=db.workLogs.filter(l=>l.id!==dl);toast('Registro removido','success');renderChecklist();renderDashboard();return;}
    // Client edit/delete
    // Employee edit
    const editEmpId=e.target.dataset.editEmp;if(editEmpId){openEditEmpModal(editEmpId);return;}
    const ec=e.target.dataset.editClient;if(ec){editClient(ec);return;}
    const dc=e.target.dataset.delClient;if(dc){if(!confirm('Remover cliente?'))return;db.clients=db.clients.filter(c=>c.id!==dc);toast('Cliente removido','success');renderClients();return;}
    // Employee delete
    const de=e.target.dataset.delEmp;if(de){
      const empToRemove=db.employees.find(em=>em.id===de);
      if(!confirm(`Remover "${empToRemove?.name||'funcionÃ¡rio'}"? O acesso ao sistema serÃ¡ revogado.`))return;
      // Remove do USERS tambÃ©m
      if(empToRemove){
        const uk=Object.keys(USERS).find(k=>USERS[k].email===empToRemove.email);
        if(uk)delete USERS[uk];
      }
      db.employees=db.employees.filter(em=>em.id!==de);
      toast('FuncionÃ¡rio removido','success');renderEmployees();return;
    }
    // Pending user approve/reject
    const au=e.target.dataset.approveUser;if(au){$('approve-user-id').value=au;$('approve-name').value=(e.target.dataset.approveEmail||'').split('@')[0];openModal('approve-modal');return;}
    const ru=e.target.dataset.rejectUser;if(ru){if(!confirm('Rejeitar usuÃ¡rio?'))return;db.pendingUsers=db.pendingUsers.filter(p=>p.id!==ru);toast('UsuÃ¡rio rejeitado','success');renderEmployees();return;}
    // Cost delete
    const dco=e.target.dataset.delCost;if(dco){if(!confirm('Remover custo?'))return;db.costs=db.costs.filter(c=>c.id!==dco);toast('Custo removido','success');renderCosts();return;}
    // Notifications
    const nr=e.target.dataset.notifRead;if(nr){const n=db.notifications.find(n=>n.id===nr);if(n)n.status='read';toast('NotificaÃ§Ã£o marcada como lida','success');updateNotifBadge();renderNotifications();return;}
    const nd=e.target.dataset.notifDel;if(nd){if(!confirm('Excluir notificaÃ§Ã£o?'))return;db.notifications=db.notifications.filter(n=>n.id!==nd);toast('NotificaÃ§Ã£o excluÃ­da','success');updateNotifBadge();renderNotifications();return;}
    // Frequencies
    const ef=e.target.dataset.editFreq;if(ef){const f=db.frequencies.find(f=>f.id===ef);if(f){$('freq-modal-title').textContent='âœ Editar FrequÃªncia';$('freq-edit-id').value=ef;$('freq-name').value=f.name;openModal('freq-modal');}return;}
    const df=e.target.dataset.delFreq;if(df){if(!confirm('Remover frequÃªncia?'))return;db.frequencies=db.frequencies.filter(f=>f.id!==df);toast('FrequÃªncia removida','success');renderFrequencies();return;}
    // Referrals
    const ar=e.target.dataset.approveRef;if(ar){$('ref-edit-id').value=ar;$('ref-bonus').value='';openModal('ref-modal');return;}
    const rr=e.target.dataset.rejectRef;if(rr){if(!confirm('Rejeitar indicaÃ§Ã£o?'))return;const r=db.referrals.find(r=>r.id===rr);if(r)r.status='rejected';toast('IndicaÃ§Ã£o rejeitada','success');renderReferrals();return;}
    const pr=e.target.dataset.pendingRef;if(pr){const r=db.referrals.find(r=>r.id===pr);if(r){r.status='pending';r.bonus_amount=0;}toast('Voltou para Pendente','success');renderReferrals();return;}
    const dr=e.target.dataset.delRef;if(dr){if(!confirm('Apagar indicaÃ§Ã£o?'))return;db.referrals=db.referrals.filter(r=>r.id!==dr);toast('IndicaÃ§Ã£o apagada','success');renderReferrals();return;}
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â• SHOW/HIDE PASSWORD (login) â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  const toggleBtn=$('toggle-pass'),passInp=$('login-pass'),eyeIco=$('eye-icon');
  if(toggleBtn){
    toggleBtn.addEventListener('click',()=>{
      if(passInp.type==='password'){
        passInp.type='text';
        eyeIco.innerHTML='<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/>';
        toggleBtn.setAttribute('aria-label','Ocultar senha');
      } else {
        passInp.type='password';
        eyeIco.innerHTML='<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
        toggleBtn.setAttribute('aria-label','Mostrar senha');
      }
    });
  }
  document.getElementById('btn-export-csv')?.addEventListener('click',exportRankingCSV);
  document.getElementById('btn-print-dash')?.addEventListener('click',()=>window.print());
});

// â•â•â•â•â•â•â•â•â•â•â•â• TOGGLE SENHA EM QUALQUER CAMPO â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFieldPass(fieldId, btn){
  const inp=document.getElementById(fieldId);
  if(!inp)return;
  const isPass=inp.type==='password';
  inp.type=isPass?'text':'password';
  btn.setAttribute('aria-label',isPass?'Ocultar senha':'Mostrar senha');
  // Troca Ã­cone
  const svgPath=isPass
    ?'<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/>'
    :'<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  btn.querySelector('svg').innerHTML=svgPath;
}

// â•â•â•â•â•â•â•â•â•â•â•â• ABRIR MODAL DE EDIÃ‡ÃƒO DE FUNCIONÃRIO â•â•â•â•â•â•â•â•â•â•â•â•
function openEditEmpModal(empId){
  const emp=db.employees.find(e=>e.id===empId);
  if(!emp)return;
  const u=Object.values(USERS).find(u=>u.email===emp.email);
  $('edit-emp-id').value=emp.id;
  $('edit-emp-name').value=emp.name;
  $('edit-emp-email').value=emp.email;
  $('edit-emp-pass').value=''; // sempre em branco por seguranÃ§a
  $('edit-emp-role').value=u?u.role:'colaborador';
  openModal('edit-emp-modal');
}

// â•â•â•â•â•â•â•â•â•â•â•â• SALVAR EDIÃ‡ÃƒO DE FUNCIONÃRIO â•â•â•â•â•â•â•â•â•â•â•â•
function saveEditEmployee(){
  const empId=$('edit-emp-id').value;
  const name=$('edit-emp-name').value.trim();
  const newEmail=$('edit-emp-email').value.trim().toLowerCase();
  const newPass=$('edit-emp-pass').value;
  const newRole=$('edit-emp-role').value;

  if(!name||!newEmail){toast('Nome e email sÃ£o obrigatÃ³rios','error');return;}
  if(newPass&&newPass.length<6){toast('Nova senha precisa ter pelo menos 6 caracteres','error');return;}

  const emp=db.employees.find(e=>e.id===empId);
  if(!emp)return;

  // Verifica se o novo email jÃ¡ estÃ¡ em uso por outro usuÃ¡rio
  const emailConflict=Object.values(USERS).find(u=>u.email===newEmail&&u.email!==emp.email);
  if(emailConflict){toast('Este email jÃ¡ estÃ¡ em uso por outro usuÃ¡rio','error');return;}

  const oldEmail=emp.email;

  // Atualiza db.employees
  emp.name=name;
  emp.email=newEmail;

  // Atualiza USERS â€” remove entrada antiga e cria nova
  const oldKey=Object.keys(USERS).find(k=>USERS[k].email===oldEmail);
  const existingPass=oldKey?USERS[oldKey].password:'123456';

  if(oldKey)delete USERS[oldKey];

  USERS[newEmail]={
    role:newRole,
    email:newEmail,
    username:name,
    password:newPass||existingPass, // mantÃ©m senha se campo vazio
    employeeId:empId
  };

  closeModal('edit-emp-modal');
  toast(`Dados de "${name}" atualizados com sucesso!`,'success');
  renderEmployees();
  populateSelects();
}

// â•â•â•â•â•â•â•â•â•â•â•â• CHARTS â•â•â•â•â•â•â•â•â•â•â•â•
let _chartRC=null,_chartP=null;
function renderCharts(confirmed){
  const cm={};
  confirmed.forEach(l=>{
    const c=getClient(l.client_id);if(!c)return;
    if(!cm[c.name])cm[c.name]={rev:0,pay:0};
    cm[c.name].rev+=l.revenue;
    cm[c.name].pay+=(l.work_log_employees||[]).reduce((s,e)=>s+e.payment_amount,0);
  });
  const labels=Object.keys(cm);
  const ctx1=document.getElementById('chart-revenue-cost');
  if(ctx1){
    if(_chartRC)_chartRC.destroy();
    _chartRC=new Chart(ctx1,{type:'bar',
      data:{labels,datasets:[
        {label:'Receita',data:labels.map(k=>cm[k].rev),backgroundColor:'rgba(37,99,235,0.82)',borderRadius:5},
        {label:'Custo M.O.',data:labels.map(k=>cm[k].pay),backgroundColor:'rgba(239,68,68,0.78)',borderRadius:5}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top'}},
        scales:{y:{beginAtZero:true,ticks:{callback:v=>'R$'+v}}}}
    });
  }
  const sorted=[...confirmed].sort((a,b)=>a.work_date.localeCompare(b.work_date));
  const bd={};
  sorted.forEach(l=>{const pay=(l.work_log_employees||[]).reduce((s,e)=>s+e.payment_amount,0);bd[l.work_date]=(bd[l.work_date]||0)+(l.revenue-pay);});
  const ctx2=document.getElementById('chart-profit');
  if(ctx2){
    if(_chartP)_chartP.destroy();
    _chartP=new Chart(ctx2,{type:'line',
      data:{labels:Object.keys(bd).map(d=>fmtDate(d)),
        datasets:[{label:'Lucro',data:Object.values(bd),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.12)',fill:true,tension:0.4,pointRadius:5,pointHoverRadius:7}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top'}},
        scales:{y:{beginAtZero:true,ticks:{callback:v=>'R$'+v}}}}
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â• EXPORT CSV â•â•â•â•â•â•â•â•â•â•â•â•
function exportRankingCSV(){
  const start=$('dash-start').value,end=$('dash-end').value;
  const confirmed=db.workLogs.filter(l=>l.work_date>=start&&l.work_date<=end&&l.status==='Confirmado');
  const cm={};
  confirmed.forEach(l=>{
    const c=getClient(l.client_id);if(!c)return;
    if(!cm[c.id])cm[c.id]={name:c.name,freq:c.frequency,rev:0,pay:0};
    cm[c.id].rev+=l.revenue;
    cm[c.id].pay+=(l.work_log_employees||[]).reduce((s,e)=>s+e.payment_amount,0);
  });
  const rows=[['#','Cliente','FrequÃªncia','Receita','Custo M.O.','Lucro']];
  Object.values(cm).sort((a,b)=>(b.rev-b.pay)-(a.rev-a.pay)).forEach((c,i)=>{
    rows.push([i+1,c.name,c.freq,c.rev.toFixed(2),c.pay.toFixed(2),(c.rev-c.pay).toFixed(2)]);
  });
  const csv=rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`ranking-${start}-${end}.csv`;a.click();
}
</script>
</body>
</html>
